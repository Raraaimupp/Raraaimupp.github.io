<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#070b14" />
  <title>LIVE CHAT | ULTRA PREMIUM</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#070b14;

      /* Premium palette (cyan + violet + ice blue) */
      --ice:#79d7ff;
      --cyan:#45f3ff;
      --blue:#5aa7ff;
      --violet:#a78bfa;
      --pink:#fb7185;

      --good:#4ade80;
      --warn:#facc15;
      --bad:#fb7185;

      --text:#eaf2ff;
      --muted: rgba(234,242,255,.60);
      --muted2: rgba(234,242,255,.38);

      --stroke: rgba(121,215,255,.16);
      --stroke2: rgba(255,255,255,.10);

      --glass1: rgba(16, 24, 38, .58);
      --glass2: rgba(10, 15, 24, .45);
      --glass3: rgba(0,0,0,.25);

      --fontH:'Orbitron',sans-serif;
      --fontB:'Share Tech Mono',monospace;

      --r12:12px;
      --r16:16px;
      --r18:18px;
      --r20:20px;
      --r24:24px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:var(--fontB); -webkit-tap-highlight-color:transparent; }
    html, body { height:100%; }
    body{
      background:
        radial-gradient(1200px 900px at 20% 0%, rgba(121,215,255,.10), transparent 60%),
        radial-gradient(900px 900px at 80% 15%, rgba(167,139,250,.09), transparent 55%),
        radial-gradient(900px 900px at 50% 90%, rgba(90,167,255,.07), transparent 55%),
        linear-gradient(180deg, #050814, #070b14 45%, #050814);
      color: var(--text);
      overflow:hidden;
    }

    /* ===== Animated background canvas ===== */
    .bg-wrap{
      position:fixed; inset:0;
      z-index:-3;
      pointer-events:none;
    }
    canvas#fxCanvas{
      width:100%; height:100%;
      display:block;
      filter: drop-shadow(0 0 14px rgba(121,215,255,.14));
    }

    /* Soft glow overlay */
    .glow{
      position:fixed; inset:0;
      z-index:-2;
      pointer-events:none;
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(121,215,255,.10), transparent 70%),
        radial-gradient(700px 700px at 15% 85%, rgba(167,139,250,.08), transparent 60%),
        radial-gradient(700px 700px at 85% 80%, rgba(90,167,255,.08), transparent 60%);
      mix-blend-mode: screen;
      opacity:.95;
    }

    /* Subtle noise overlay (premium feel) */
    .noise{
      position:fixed; inset:0;
      z-index:-1;
      pointer-events:none;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.08'/%3E%3C/svg%3E");
      opacity:.20;
      mix-blend-mode: overlay;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.18); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,.28); }

    /* App layout */
    .app{
      height:100dvh;
      width:100%;
      max-width:1600px;
      margin:0 auto;
      display:flex;
      position:relative;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:310px;
      flex-shrink:0;
      border-right:1px solid var(--stroke);
      background:
        linear-gradient(180deg, rgba(10,15,24,.72), rgba(10,15,24,.45));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
      z-index:50;
      transition: transform .28s cubic-bezier(.4,0,.2,1);
      box-shadow: 18px 0 60px rgba(0,0,0,.45);
    }

    .user-card{
      padding:18px 18px 16px;
      border-bottom:1px solid var(--stroke);
      background:
        linear-gradient(180deg, rgba(16,24,38,.72), rgba(10,15,24,.25));
      box-shadow:
        0 1px 0 rgba(255,255,255,.05) inset;
    }

    .profile-top{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .avatar{
      width:66px; height:66px;
      border-radius:20px;
      border:1px solid rgba(121,215,255,.28);
      background:
        radial-gradient(100px 70px at 20% 10%, rgba(121,215,255,.15), transparent 60%),
        radial-gradient(120px 90px at 85% 0%, rgba(167,139,250,.12), transparent 60%),
        rgba(0,0,0,.28);
      box-shadow:
        0 18px 55px rgba(0,0,0,.42),
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 26px rgba(121,215,255,.08);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      position:relative;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
    }
    .avatar:hover{
      transform: translateY(-1px);
      border-color: rgba(121,215,255,.42);
    }
    .avatar::after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.12), transparent);
      transform: rotate(12deg);
      animation: sheen 4.8s linear infinite;
      opacity:.55;
      pointer-events:none;
    }
    @keyframes sheen{
      0%{ transform: translateX(-60%) rotate(12deg); }
      100%{ transform: translateX(60%) rotate(12deg); }
    }

    .avatar img{ width:100%; height:100%; object-fit:cover; display:none; }
    .avatar .initials{
      font-family:var(--fontH);
      font-weight:700;
      letter-spacing:1px;
      color:#eaf2ff;
      font-size:20px;
      opacity:.92;
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
    }

    .me-info{ min-width:0; flex:1; }
    .me-name{
      font-family:var(--fontH);
      font-size:15px;
      letter-spacing:1.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .me-sub{
      margin-top:8px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      user-select:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
    }
    .pill strong{
      color: var(--text);
      font-weight:700;
      letter-spacing:1px;
      font-family:var(--fontH);
      font-size:10px;
    }

    .status-dot{
      width:7px; height:7px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 14px rgba(250,204,21,.28);
    }
    .status-dot.connected{ background: var(--good); box-shadow: 0 0 14px rgba(74,222,128,.32); }
    .status-dot.disconnected{ background: var(--bad); box-shadow: 0 0 14px rgba(251,113,133,.32); }

    .card-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(121,215,255,.18);
      background:
        radial-gradient(120px 90px at 20% 10%, rgba(121,215,255,.12), transparent 60%),
        rgba(0,0,0,.20);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      font-family:var(--fontH);
      letter-spacing:1.6px;
      text-transform:uppercase;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow:
        0 16px 40px rgba(0,0,0,.30),
        0 0 0 1px rgba(255,255,255,.04) inset;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(121,215,255,.36);
      filter: brightness(1.06);
    }
    .btn::after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.10), transparent);
      transform: rotate(10deg);
      animation: sheen 5.5s linear infinite;
      opacity:.35;
      pointer-events:none;
    }
    .btn.danger{
      border-color: rgba(251,113,133,.22);
    }
    .btn.danger:hover{
      border-color: rgba(251,113,133,.42);
      filter: brightness(1.06);
    }

    /* Under hamburger: Online count then Music button */
    .mini-panel{
      padding:14px 18px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      flex-direction:column;
      gap:10px;
      background: linear-gradient(180deg, rgba(12,18,30,.32), rgba(12,18,30,.14));
    }
    .mini-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .mini-title{
      font-family:var(--fontH);
      letter-spacing:1.6px;
      font-size:11px;
      color: var(--muted);
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .mini-value{
      font-family:var(--fontH);
      letter-spacing:1.6px;
      font-size:11px;
      color: var(--text);
      padding:7px 12px;
      border-radius:999px;
      border:1px solid rgba(121,215,255,.18);
      background: rgba(0,0,0,.22);
      min-width:58px;
      text-align:center;
      box-shadow: 0 0 0 1px rgba(255,255,255,.04) inset;
    }

    .music-btn{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(121,215,255,.18);
      background:
        radial-gradient(140px 100px at 22% 0%, rgba(121,215,255,.20), transparent 60%),
        radial-gradient(160px 120px at 85% 0%, rgba(167,139,250,.16), transparent 60%),
        rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      font-family:var(--fontH);
      letter-spacing:1.8px;
      text-transform:uppercase;
      font-size:11px;
      user-select:none;
      position:relative;
      overflow:hidden;
      box-shadow:
        0 18px 50px rgba(0,0,0,.32),
        0 0 0 1px rgba(255,255,255,.04) inset;
    }
    .music-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(121,215,255,.40);
      filter: brightness(1.08);
    }
    .music-btn::after{
      content:"";
      position:absolute; inset:-35%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.12), transparent);
      transform: rotate(12deg);
      animation: sheen 6.2s linear infinite;
      opacity:.45;
      pointer-events:none;
    }
    .music-state-dot{
      width:8px; height:8px; border-radius:50%;
      background: rgba(234,242,255,.25);
      box-shadow: 0 0 16px rgba(121,215,255,.20);
    }
    .music-on .music-state-dot{ background: var(--good); box-shadow: 0 0 16px rgba(74,222,128,.35); }
    .music-off .music-state-dot{ background: rgba(234,242,255,.22); }

    .online-users{
      flex:1;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .section-header{
      padding:14px 18px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1.8px;
      text-transform:uppercase;
      color: var(--muted);
    }
    .users-list{
      flex:1;
      overflow:auto;
      padding:10px;
      min-height:0;
    }
    .user-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid transparent;
      background: rgba(0,0,0,.10);
      margin-bottom:9px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .15s ease;
      position:relative;
      overflow:hidden;
    }
    .user-item::after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.08), transparent);
      transform: rotate(12deg);
      animation: sheen 7.2s linear infinite;
      opacity:.18;
      pointer-events:none;
    }
    .user-item:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,.16);
      border-color: rgba(121,215,255,.16);
    }

    .u-ava{
      width:36px;height:36px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(60px 45px at 20% 10%, rgba(121,215,255,.12), transparent 60%),
        rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1px;
      color: var(--text);
      overflow:hidden;
      flex-shrink:0;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .u-ava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .u-in{ font-family:var(--fontH); font-size:11px; letter-spacing:1px; opacity:.95; }
    .u-info{ min-width:0; }
    .u-name{ font-size:13px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .u-role{ font-size:10px; color:var(--muted2); text-transform:uppercase; letter-spacing:1.4px; margin-top:2px; }

    /* ===== Chat area ===== */
    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
      position:relative;
    }
    .chat-header{
      height:66px;
      flex-shrink:0;
      border-bottom:1px solid var(--stroke);
      background:
        linear-gradient(180deg, rgba(16,24,38,.65), rgba(10,15,24,.22));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      gap:10px;
      z-index:10;
      box-shadow: 0 10px 40px rgba(0,0,0,.30);
    }
    .left-head{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .hamburger{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(121,215,255,.18);
      background:
        radial-gradient(70px 50px at 22% 0%, rgba(121,215,255,.18), transparent 60%),
        rgba(0,0,0,.18);
      color: var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      flex-shrink:0;
      box-shadow: 0 14px 35px rgba(0,0,0,.26);
      position:relative;
      overflow:hidden;
    }
    .hamburger:hover{ transform: translateY(-1px); border-color: rgba(121,215,255,.40); filter: brightness(1.08); }
    .hamburger::after{
      content:"";
      position:absolute; inset:-35%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.10), transparent);
      transform: rotate(12deg);
      animation: sheen 6.6s linear infinite;
      opacity:.40;
      pointer-events:none;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand h1{
      font-family:var(--fontH);
      font-size:16px;
      letter-spacing:2.3px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .badge-prem{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(121,215,255,.22);
      background:
        linear-gradient(135deg, rgba(121,215,255,.18), rgba(167,139,250,.10));
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2.2px;
      text-transform:uppercase;
      color: var(--text);
      white-space:nowrap;
      box-shadow: 0 0 18px rgba(121,215,255,.08);
    }

    .right-head{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .conn-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(74,222,128,.25);
      background: rgba(0,0,0,.18);
      font-family:var(--fontH);
      letter-spacing:2.0px;
      font-size:10px;
      text-transform:uppercase;
      color: rgba(74,222,128,.95);
      box-shadow: 0 12px 35px rgba(0,0,0,.22);
      white-space:nowrap;
    }
    .conn-pill.disc{ border-color: rgba(251,113,133,.25); color: rgba(251,113,133,.95); }
    .conn-pill.conn{ border-color: rgba(250,204,21,.25); color: rgba(250,204,21,.95); }

    .messages{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:16px 14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .sys{
      align-self:center;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1.4px;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:center;
      max-width:92%;
      box-shadow: 0 16px 40px rgba(0,0,0,.22);
    }

    .msg{
      display:flex;
      gap:10px;
      max-width:92%;
      animation: pop .18s ease;
    }
    .msg.own{ align-self:flex-end; flex-direction:row-reverse; }
    .msg.other{ align-self:flex-start; }

    @keyframes pop{
      from{ transform: translateY(6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    /* avatar kecil di chat */
    .m-ava{
      width:34px;height:34px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(60px 45px at 20% 10%, rgba(121,215,255,.12), transparent 60%),
        rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex-shrink:0;
      box-shadow: 0 12px 30px rgba(0,0,0,.26);
      margin-top:18px;
    }
    .m-ava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .m-ava .m-in{
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:1px;
      opacity:.95;
    }

    .bubble-wrap{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted2);
      font-size:11px;
      letter-spacing:1.2px;
      text-transform:uppercase;
      flex-wrap:wrap;
    }
    .meta .name{
      font-family:var(--fontH);
      letter-spacing:2px;
      color: var(--text);
      font-size:10px;
    }
    .role-badge{
      font-family:var(--fontH);
      font-size:9px;
      letter-spacing:2px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
    }
    .bubble{
      border-radius: 18px;
      padding:12px 14px;
      line-height:1.55;
      font-size:14px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(180px 120px at 15% 0%, rgba(121,215,255,.10), transparent 60%),
        rgba(0,0,0,.18);
      box-shadow:
        0 18px 55px rgba(0,0,0,.30),
        0 0 0 1px rgba(255,255,255,.04) inset;
      position:relative;
      overflow:hidden;
      min-width: 140px;
      max-width: 620px;
    }
    .bubble::after{
      content:"";
      position:absolute; inset:-35%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.10), transparent);
      transform: rotate(10deg);
      animation: sheen 7.5s linear infinite;
      opacity:.22;
      pointer-events:none;
    }

    .msg.own .bubble{
      background:
        radial-gradient(180px 120px at 15% 0%, rgba(121,215,255,.16), transparent 60%),
        linear-gradient(135deg, rgba(121,215,255,.16), rgba(167,139,250,.10)),
        rgba(0,0,0,.12);
      border-color: rgba(121,215,255,.20);
    }

    .bubble img{
      max-width:100%;
      display:block;
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }

    /* ===== Input: super premium buttons ===== */
    .input{
      flex-shrink:0;
      border-top:1px solid rgba(121,215,255,.14);
      background:
        linear-gradient(180deg, rgba(10,15,24,.18), rgba(16,24,38,.62));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      display:flex;
      align-items:flex-end;
      gap:10px;
      box-shadow:
        0 -16px 60px rgba(0,0,0,.40),
        0 -1px 0 rgba(255,255,255,.05) inset;
    }

    .input .wrap{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .file-preview{
      display:none;
      padding:9px 10px;
      border-radius:14px;
      border:1px solid rgba(121,215,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
      align-items:center;
      gap:10px;
      box-shadow: 0 12px 35px rgba(0,0,0,.22);
    }
    .file-preview.active{ display:flex; }
    .file-preview .remove{ margin-left:auto; cursor:pointer; opacity:.9; }

    textarea{
      width:100%;
      min-height:54px;
      max-height:140px;
      resize:none;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(160px 110px at 14% 18%, rgba(121,215,255,.12), transparent 62%),
        radial-gradient(220px 140px at 90% 0%, rgba(167,139,250,.10), transparent 60%),
        rgba(0,0,0,.30);
      color: var(--text);
      outline:none;
      font-size:14px;
      transition: border-color .15s ease, background .15s ease, box-shadow .15s ease;
      box-shadow:
        0 18px 55px rgba(0,0,0,.35),
        0 0 0 1px rgba(255,255,255,.04) inset;
    }
    textarea:focus{
      border-color: rgba(121,215,255,.38);
      box-shadow:
        0 18px 60px rgba(0,0,0,.38),
        0 0 28px rgba(121,215,255,.10),
        0 0 0 1px rgba(255,255,255,.05) inset;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-shrink:0;
      align-items:flex-end;
    }

    .icon{
      width:54px;height:54px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(120px 90px at 20% 0%, rgba(121,215,255,.14), transparent 60%),
        radial-gradient(140px 100px at 90% 0%, rgba(167,139,250,.12), transparent 60%),
        rgba(0,0,0,.18);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      box-shadow:
        0 18px 55px rgba(0,0,0,.34),
        0 0 0 1px rgba(255,255,255,.04) inset;
      position:relative;
      overflow:hidden;
    }
    .icon::after{
      content:"";
      position:absolute; inset:-35%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.12), transparent);
      transform: rotate(12deg);
      animation: sheen 6.8s linear infinite;
      opacity:.30;
      pointer-events:none;
    }
    .icon:hover{
      transform: translateY(-1px);
      border-color: rgba(121,215,255,.28);
      filter: brightness(1.06);
    }

    .send{
      border-color: rgba(121,215,255,.26);
      background:
        radial-gradient(140px 120px at 25% 0%, rgba(121,215,255,.55), transparent 62%),
        radial-gradient(160px 120px at 85% 0%, rgba(167,139,250,.45), transparent 60%),
        linear-gradient(135deg, rgba(69,243,255,.65), rgba(90,167,255,.58));
      color:#051020;
      font-weight:900;
      text-shadow: none;
    }
    .send:hover{
      border-color: rgba(121,215,255,.42);
      filter: brightness(1.08);
      box-shadow:
        0 22px 70px rgba(0,0,0,.40),
        0 0 30px rgba(121,215,255,.12);
    }

    .send:active, .icon:active{ transform: translateY(0px) scale(.99); }

    .send:disabled, .icon:disabled, textarea:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter: none;
      transform:none;
    }

    /* Typing */
    .typing{
      height:18px;
      padding:0 14px 10px;
      color: var(--muted2);
      font-size:11px;
      display:none;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .typing .dots span{
      width:4px;height:4px;border-radius:999px;
      background: rgba(234,242,255,.45);
      display:inline-block;
      animation: bounce 1.2s infinite;
      margin-right:3px;
    }
    .typing .dots span:nth-child(2){ animation-delay:.15s; }
    .typing .dots span:nth-child(3){ animation-delay:.3s; }
    @keyframes bounce{ 0%,80%,100%{ transform: scale(.2); opacity:.4; } 40%{ transform: scale(1); opacity:1; } }

    /* Modal image */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:18px;
    }
    .modal.active{ display:flex; }
    .modal img{
      max-width:95%;
      max-height:90vh;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 25px 90px rgba(0,0,0,.60);
    }

    /* Overlay for mobile sidebar */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      z-index:40;
    }
    .overlay.active{ display:block; }

    /* LOGIN / PROFILE modal */
    .gate{
      position:fixed; inset:0;
      z-index:3000;
      background: rgba(0,0,0,.70);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .gate.active{ display:flex; }
    .gate-card{
      width:100%;
      max-width:520px;
      border-radius:20px;
      border:1px solid rgba(121,215,255,.18);
      background:
        linear-gradient(180deg, rgba(16,24,38,.78), rgba(10,15,24,.58));
      box-shadow: 0 28px 100px rgba(0,0,0,.60);
      overflow:hidden;
      position:relative;
    }
    .gate-card::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.12), transparent);
      transform: rotate(10deg);
      animation: sheen 7.8s linear infinite;
      opacity:.20;
      pointer-events:none;
    }
    .gate-head{
      padding:18px 18px 12px;
      border-bottom:1px solid rgba(121,215,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .gate-title{
      font-family:var(--fontH);
      letter-spacing:2.4px;
      text-transform:uppercase;
      font-size:14px;
    }
    .gate-sub{
      padding:0 18px 14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .gate-body{
      padding:16px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .field{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: var(--text);
      outline:none;
      font-size:14px;
      box-shadow: 0 16px 45px rgba(0,0,0,.25);
    }
    .field:focus{ border-color: rgba(121,215,255,.35); }

    .upload{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:16px;
      border:1px dashed rgba(121,215,255,.22);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 16px 45px rgba(0,0,0,.22);
    }
    .gate-footer{
      padding:14px 18px 18px;
      display:flex;
      gap:10px;
    }
    .primary{
      flex:1;
      padding:12px 12px;
      border-radius:16px;
      border:none;
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2.4px;
      text-transform:uppercase;
      font-size:12px;
      background:
        radial-gradient(180px 130px at 25% 0%, rgba(121,215,255,.65), transparent 62%),
        radial-gradient(180px 130px at 85% 0%, rgba(167,139,250,.50), transparent 60%),
        linear-gradient(135deg, rgba(69,243,255,.70), rgba(90,167,255,.62));
      color:#051020;
      font-weight:900;
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
    }
    .secondary{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2.2px;
      text-transform:uppercase;
      font-size:12px;
      box-shadow: 0 16px 45px rgba(0,0,0,.28);
    }
    .hint{
      padding:0 18px 16px;
      color: var(--muted2);
      font-size:11px;
    }

    /* Mobile */
    @media (max-width: 900px){
      .sidebar{
        position:fixed;
        top:0; bottom:0; left:0;
        transform: translateX(-105%);
        width:285px;
      }
      .sidebar.active{ transform: translateX(0); }
      .bubble{ max-width: 86vw; }
    }
  </style>
</head>

<body>
  <!-- Background -->
  <div class="bg-wrap">
    <canvas id="fxCanvas"></canvas>
  </div>
  <div class="glow"></div>
  <div class="noise"></div>

  <!-- LOGIN / PROFILE -->
  <div class="gate" id="gate">
    <div class="gate-card">
      <div class="gate-head">
        <div class="gate-title" id="gateTitle">LOGIN</div>
        <span class="pill"><span class="status-dot disconnected"></span><strong>Profile</strong></span>
      </div>
      <div class="gate-sub" id="gateSub">
        Masukin <b>username</b> & (opsional) <b>foto profil</b> biar tampil di chat.<br/>
        Data disimpan di browser kamu (localStorage).
      </div>
      <div class="gate-body">
        <div class="row">
          <input id="gateUsername" class="field" maxlength="20" placeholder="username (3-20) contoh: raraa_01" autocomplete="off"/>
          <label class="upload" for="gatePhoto">
            <i class="fa-solid fa-image"></i>
            <span id="photoLabel">Upload foto profil (opsional)</span>
          </label>
          <input id="gatePhoto" type="file" accept="image/*" style="display:none"/>
        </div>
      </div>
      <div class="gate-footer">
        <button class="primary" id="gateGo">Masuk</button>
        <button class="secondary" id="gateReset" title="hapus data login">Reset</button>
      </div>
      <div class="hint">
        Autoplay musik kadang diblokir browser—kalau tidak bunyi, tekan tombol MUSIC.
      </div>
    </div>
  </div>

  <!-- Mobile overlay -->
  <div class="overlay" id="overlay"></div>

  <!-- Image modal -->
  <div class="modal" id="imgModal">
    <img id="imgModalEl" alt="preview"/>
  </div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="profile-top">
          <div class="avatar" id="meAvatar" role="button" tabindex="0" title="Edit profile">
            <img id="meAvatarImg" alt="me"/>
            <div class="initials" id="meInitials">ME</div>
          </div>
          <div class="me-info">
            <div class="me-name" id="meName">Loading...</div>
            <div class="me-sub">
              <span class="pill"><span class="status-dot" id="connDot"></span><strong id="connText">CONNECTING</strong></span>
              <span class="pill"><i class="fa-solid fa-user-shield"></i><strong id="meRole">USER</strong></span>
            </div>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn" id="btnEdit"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
          <button class="btn danger" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>

      <!-- Under hamburger: online count then music -->
      <div class="mini-panel">
        <div class="mini-row">
          <div class="mini-title"><i class="fa-solid fa-users"></i> Online</div>
          <div class="mini-value" id="onlineCount">0</div>
        </div>

        <button class="music-btn music-off" id="musicBtn">
          <span class="music-state-dot" id="musicDot"></span>
          <span id="musicText">MUSIC OFF</span>
        </button>
      </div>

      <div class="online-users">
        <div class="section-header">
          <span>Online Users</span>
          <span id="onlineCountTop">0</span>
        </div>
        <div class="users-list" id="userList"></div>
      </div>
    </aside>

    <!-- CHAT -->
    <main class="chat">
      <header class="chat-header">
        <div class="left-head">
          <button class="hamburger" id="hamburger" aria-label="menu">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div class="brand">
            <h1>LIVE CHAT</h1>
            <span class="badge-prem">ULTRA</span>
          </div>
        </div>
        <div class="right-head">
          <div class="conn-pill conn" id="connPill"><i class="fa-solid fa-wifi"></i> CONNECTING</div>
        </div>
      </header>

      <section class="messages" id="messages">
        <div class="sys" id="welcome">
          <i class="fa-solid fa-circle-notch fa-spin"></i>
          Waiting for login...
        </div>
      </section>

      <div class="typing" id="typing">
        <div class="dots"><span></span><span></span><span></span></div>
        <div id="typingText">Someone is typing...</div>
      </div>

      <footer class="input">
        <div class="wrap">
          <div class="file-preview" id="filePreview">
            <i class="fa-solid fa-paperclip"></i>
            <span id="fileName" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;">file</span>
            <i class="fa-solid fa-xmark remove" id="fileRemove"></i>
          </div>
          <textarea id="msgInput" placeholder="Type message (or select image)..." disabled></textarea>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none"/>
        <div class="btns">
          <button class="icon" id="attachBtn" disabled title="Attach"><i class="fa-solid fa-paperclip"></i></button>
          <button class="icon send" id="sendBtn" disabled title="Send"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </footer>
    </main>
  </div>

  <!-- Audio (loop) -->
  <audio id="bgm" preload="auto" loop>
    <source src="https://files.catbox.moe/wlny2m.mp3" type="audio/mpeg"/>
  </audio>

  <!-- SET SOCKET URL (ubah ini sesuai backend kamu) -->
  <script>
  window.SOCKET_URL = "https://livechatscarrydeath.raraaprivate.my.id";
</script>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
    /* =========================
       CONFIG + STORAGE
    ========================== */
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;
    const KEY_USER  = "ic_username";
    const KEY_PHOTO = "ic_profile_photo"; // base64
    const KEY_ROLE  = "ic_role"; // default user

    const els = {
      gate: document.getElementById("gate"),
      gateTitle: document.getElementById("gateTitle"),
      gateSub: document.getElementById("gateSub"),
      gateUsername: document.getElementById("gateUsername"),
      gatePhoto: document.getElementById("gatePhoto"),
      photoLabel: document.getElementById("photoLabel"),
      gateGo: document.getElementById("gateGo"),
      gateReset: document.getElementById("gateReset"),

      sidebar: document.getElementById("sidebar"),
      overlay: document.getElementById("overlay"),
      hamburger: document.getElementById("hamburger"),

      meAvatar: document.getElementById("meAvatar"),
      meAvatarImg: document.getElementById("meAvatarImg"),
      meInitials: document.getElementById("meInitials"),
      meName: document.getElementById("meName"),
      meRole: document.getElementById("meRole"),
      btnEdit: document.getElementById("btnEdit"),
      btnLogout: document.getElementById("btnLogout"),

      onlineCount: document.getElementById("onlineCount"),
      onlineCountTop: document.getElementById("onlineCountTop"),
      userList: document.getElementById("userList"),

      connDot: document.getElementById("connDot"),
      connText: document.getElementById("connText"),
      connPill: document.getElementById("connPill"),

      messages: document.getElementById("messages"),
      welcome: document.getElementById("welcome"),
      typing: document.getElementById("typing"),
      typingText: document.getElementById("typingText"),

      msgInput: document.getElementById("msgInput"),
      sendBtn: document.getElementById("sendBtn"),
      attachBtn: document.getElementById("attachBtn"),
      fileInput: document.getElementById("fileInput"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      fileRemove: document.getElementById("fileRemove"),

      imgModal: document.getElementById("imgModal"),
      imgModalEl: document.getElementById("imgModalEl"),

      musicBtn: document.getElementById("musicBtn"),
      musicText: document.getElementById("musicText"),
      musicDot: document.getElementById("musicDot"),
      bgm: document.getElementById("bgm"),

      fxCanvas: document.getElementById("fxCanvas"),
    };

    const myUser = {
      username: null,
      role: (localStorage.getItem(KEY_ROLE) || "user"),
      photo: null, // base64
    };

    let socket = null;
    let isConnected = false;
    let typingTimeout = null;
    let pingInterval = null;

    let currentFile = null;
    let currentFileData = null;

    /* =========================
       UTIL
    ========================== */
    function escapeHtml(t){
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    }
    function isValidUsername(name){
      return /^[A-Za-z0-9_]{3,20}$/.test(String(name || "").trim());
    }
    function initials(name){
      const s = String(name || "").trim();
      return (s.substring(0,2).toUpperCase() || "ME");
    }
    function enableInput(on){
      els.msgInput.disabled = !on;
      els.sendBtn.disabled = !on;
      els.attachBtn.disabled = !on;
      if(on) els.msgInput.focus();
    }
    function setConn(status, label){
      // status: connected | connecting | disconnected
      els.connDot.classList.remove("connected","disconnected");
      els.connPill.classList.remove("disc","conn");

      if(status === "connected"){
        els.connDot.classList.add("connected");
        els.connPill.innerHTML = `<i class="fa-solid fa-wifi"></i> ${label || "CONNECTED"}`;
        els.connPill.style.borderColor = "rgba(74,222,128,.25)";
        els.connPill.style.color = "rgba(74,222,128,.95)";
      } else if(status === "connecting"){
        els.connPill.classList.add("conn");
        els.connPill.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${label || "CONNECTING"}`;
        els.connPill.style.borderColor = "rgba(250,204,21,.25)";
        els.connPill.style.color = "rgba(250,204,21,.95)";
      } else {
        els.connDot.classList.add("disconnected");
        els.connPill.classList.add("disc");
        els.connPill.innerHTML = `<i class="fa-solid fa-wifi-slash"></i> ${label || "DISCONNECTED"}`;
        els.connPill.style.borderColor = "rgba(251,113,133,.25)";
        els.connPill.style.color = "rgba(251,113,133,.95)";
      }
      els.connText.textContent = (label || status).toUpperCase();
    }

    function applyProfileUI(){
      els.meName.textContent = myUser.username || "Guest";
      els.meRole.textContent = String(myUser.role || "user").toUpperCase();
      els.meInitials.textContent = initials(myUser.username);

      if(myUser.photo){
        els.meAvatarImg.src = myUser.photo;
        els.meAvatarImg.style.display = "block";
        els.meInitials.style.display = "none";
      }else{
        els.meAvatarImg.removeAttribute("src");
        els.meAvatarImg.style.display = "none";
        els.meInitials.style.display = "block";
      }
    }

    /* =========================
       SIDEBAR TOGGLE
    ========================== */
    function sidebarOpen(open){
      const show = (open === undefined) ? !els.sidebar.classList.contains("active") : open;
      if(show){
        els.sidebar.classList.add("active");
        els.overlay.classList.add("active");
      }else{
        els.sidebar.classList.remove("active");
        els.overlay.classList.remove("active");
      }
    }

    /* =========================
       LOGIN / EDIT PROFILE
    ========================== */
    function openGate(mode){
      els.gate.classList.add("active");
      if(mode === "edit"){
        els.gateTitle.textContent = "EDIT PROFILE";
        els.gateSub.innerHTML = `Ubah <b>username</b> / <b>foto profil</b>. Akan langsung dipakai di chat.`;
        els.gateUsername.value = myUser.username || "";
        els.photoLabel.textContent = myUser.photo ? "Ganti foto profil (sudah ada)" : "Upload foto profil (opsional)";
      } else {
        els.gateTitle.textContent = "LOGIN";
        els.gateSub.innerHTML = `Masukin <b>username</b> & (opsional) <b>foto profil</b> biar tampil di chat.<br/>Data disimpan di browser kamu (localStorage).`;
        els.gateUsername.value = "";
        els.photoLabel.textContent = "Upload foto profil (opsional)";
      }
      setTimeout(()=> els.gateUsername.focus(), 50);
    }
    function closeGate(){ els.gate.classList.remove("active"); }

    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function doGateSave(){
      const name = String(els.gateUsername.value || "").trim();
      if(!isValidUsername(name)){
        alert("Username harus 3–20 karakter dan hanya huruf/angka/underscore.");
        els.gateUsername.focus();
        els.gateUsername.select();
        return;
      }

      myUser.username = name;
      localStorage.setItem(KEY_USER, name);

      if(els.gatePhoto.files && els.gatePhoto.files[0]){
        const f = els.gatePhoto.files[0];
        if(!f.type.startsWith("image/")){
          alert("Foto profil harus gambar.");
          return;
        }
        if(f.size > 2 * 1024 * 1024){
          alert("Foto profil max 2MB biar ringan.");
          return;
        }
        myUser.photo = await fileToBase64(f);
        localStorage.setItem(KEY_PHOTO, myUser.photo);
      } else {
        const savedPhoto = localStorage.getItem(KEY_PHOTO);
        myUser.photo = savedPhoto ? savedPhoto : null;
      }

      applyProfileUI();
      closeGate();

      if(!socket){
        connectSocket();
      }else{
        if(isConnected) socket.emit("chat:login", { username: myUser.username, role: myUser.role, photo: myUser.photo });
      }
    }

    function doLogout(){
      localStorage.removeItem(KEY_USER);
      localStorage.removeItem(KEY_PHOTO);

      myUser.username = null;
      myUser.photo = null;

      try{ if(socket) socket.disconnect(); }catch(_){}
      socket = null;
      isConnected = false;

      els.messages.innerHTML = "";
      els.messages.appendChild(els.welcome);
      els.welcome.style.display = "flex";
      els.welcome.innerHTML = `<i class="fa-solid fa-user-lock"></i> Please login (username)`;

      enableInput(false);
      setConn("disconnected","LOGIN REQUIRED");
      applyProfileUI();

      sidebarOpen(false);
      openGate("login");
    }

    /* =========================
       MUSIC
    ========================== */
    let musicOn = false;

    async function tryPlayMusic(){
      try{
        els.bgm.volume = 0.75;
        await els.bgm.play();
        setMusicState(true);
      }catch(_){
        setMusicState(false);
      }
    }
    function setMusicState(on){
      musicOn = !!on;
      els.musicBtn.classList.toggle("music-on", musicOn);
      els.musicBtn.classList.toggle("music-off", !musicOn);
      els.musicText.textContent = musicOn ? "MUSIC ON" : "MUSIC OFF";
    }
    async function toggleMusic(){
      try{
        if(musicOn){
          els.bgm.pause();
          setMusicState(false);
        }else{
          await els.bgm.play();
          setMusicState(true);
        }
      }catch(_){
        setMusicState(false);
        alert("Browser kamu blok autoplay. Coba klik lagi / unmute perangkat.");
      }
    }
    function installAudioUnlock(){
      const unlock = async () => {
        if(!musicOn){
          try{ await els.bgm.play(); setMusicState(true); }catch(_){}
        }
        window.removeEventListener("touchstart", unlock);
        window.removeEventListener("click", unlock);
      };
      window.addEventListener("touchstart", unlock, { once:true });
      window.addEventListener("click", unlock, { once:true });
    }

    /* =========================
       SOCKET
    ========================== */
    function connectSocket(){
      if(!window.io){
        setConn("disconnected","SOCKET CLIENT MISSING");
        return;
      }

      setConn("connecting","CONNECTING");
      enableInput(false);

      socket = io(SOCKET_URL, { transports:["websocket","polling"] });

      socket.on("connect", ()=>{
        isConnected = true;
        setConn("connected","CONNECTED");

        socket.emit("chat:login", {
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-check"></i> Connected as ${escapeHtml(myUser.username)}`;
        setTimeout(()=> els.welcome.style.display = "none", 1800);

        enableInput(true);
        startPing();
      });

      socket.on("disconnect", ()=>{
        isConnected = false;
        setConn("disconnected","DISCONNECTED");
        enableInput(false);

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Disconnected`;
        stopPing();
      });

      socket.on("connect_error", ()=>{
        isConnected = false;
        setConn("disconnected","CONNECT ERROR");
        enableInput(false);

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Cannot connect to Socket server`;
      });

      socket.on("chat:history", (history)=>{
        els.messages.innerHTML = "";
        (history || []).forEach(m => m.image ? addImageMessage(m) : addMessage(m));
        scrollBottom();
      });

      socket.on("chat:newMessage", (msg)=>{
        addMessage(msg);
        scrollBottom();
      });

      socket.on("chat:image", (msg)=>{
        addImageMessage(msg);
        scrollBottom();
      });

      socket.on("chat:userTyping", (data)=>{
        if(!data) return;
        if(data.username !== myUser.username){
          els.typing.style.display = data.isTyping ? "flex" : "none";
          els.typingText.textContent = `${data.username} is typing...`;
        }
      });

      socket.on("chat:onlineUsers", (data)=>{
        const count = Number(data?.count ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
        renderUserList(data?.users || []);
      });

      socket.on("chat:userJoin", (data)=>{
        systemMsg(`${escapeHtml(data?.username || "someone")} joined`);
        const count = Number(data?.onlineCount ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
      });

      socket.on("chat:userLeave", (data)=>{
        systemMsg(`${escapeHtml(data?.username || "someone")} left`);
        const count = Number(data?.onlineCount ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
      });

      socket.on("pong", ()=>{});
    }

    function startPing(){
      stopPing();
      pingInterval = setInterval(()=>{
        if(!socket || !isConnected) return;
        socket.emit("ping");
      }, 5000);
    }
    function stopPing(){
      if(pingInterval) clearInterval(pingInterval);
      pingInterval = null;
    }

    /* =========================
       CHAT UI
    ========================== */
    function scrollBottom(){
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function systemMsg(text){
      const d = document.createElement("div");
      d.className = "sys";
      d.innerHTML = `<i class="fa-solid fa-bolt"></i> ${text}`;
      els.messages.appendChild(d);
      scrollBottom();
      setTimeout(()=> d.remove(), 4200);
    }

    function makeMsgAvatar(photo, name){
      const wrap = document.createElement("div");
      wrap.className = "m-ava";
      wrap.innerHTML = `<img alt="ava"><div class="m-in">${escapeHtml(initials(name))}</div>`;
      const img = wrap.querySelector("img");
      const ini = wrap.querySelector(".m-in");
      if(photo){
        img.src = photo;
        img.style.display = "block";
        ini.style.display = "none";
      }else{
        img.style.display = "none";
        ini.style.display = "block";
      }
      return wrap;
    }

    function addMessage(data){
      const isOwn = (data?.username === myUser.username);
      const msg = document.createElement("div");
      msg.className = `msg ${isOwn ? "own" : "other"}`;

      const time = new Date(data?.timestamp || Date.now())
        .toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});

      const role = String(data?.role || "user").toUpperCase();
      const photo = isOwn ? myUser.photo : (data?.photo || null);
      const name = String(data?.username || "");

      const ava = makeMsgAvatar(photo, name);

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";
      wrap.innerHTML = `
        <div class="meta">
          <span class="name">${escapeHtml(name)}</span>
          <span class="role-badge">${escapeHtml(role)}</span>
          <span>${time}</span>
        </div>
        <div class="bubble">${escapeHtml(data?.message || "").replace(/\n/g,"<br>")}</div>
      `;

      msg.appendChild(ava);
      msg.appendChild(wrap);
      els.messages.appendChild(msg);
    }

    function addImageMessage(data){
      const isOwn = (data?.username === myUser.username);
      const msg = document.createElement("div");
      msg.className = `msg ${isOwn ? "own" : "other"}`;

      const time = new Date(data?.timestamp || Date.now())
        .toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});

      const role = String(data?.role || "user").toUpperCase();
      const name = String(data?.username || "");
      const photo = isOwn ? myUser.photo : (data?.photo || null);

      const ava = makeMsgAvatar(photo, name);

      const caption = data?.message ? `<div style="margin-bottom:8px">${escapeHtml(data.message).replace(/\n/g,"<br>")}</div>` : "";
      const img = data?.image ? `<img src="${data.image}" data-preview="1" alt="image"/>` : "";

      const wrap = document.createElement("div");
      wrap.className = "bubble-wrap";
      wrap.innerHTML = `
        <div class="meta">
          <span class="name">${escapeHtml(name)}</span>
          <span class="role-badge">${escapeHtml(role)}</span>
          <span>${time}</span>
        </div>
        <div class="bubble">${caption}${img}</div>
      `;

      msg.appendChild(ava);
      msg.appendChild(wrap);
      els.messages.appendChild(msg);

      const im = wrap.querySelector('img[data-preview="1"]');
      if(im){
        im.addEventListener("click", ()=>{
          els.imgModalEl.src = data.image;
          els.imgModal.classList.add("active");
        });
      }
    }

    function renderUserList(users){
      els.userList.innerHTML = "";
      const order = { owner:0, admin:1, user:2 };
      users.slice().sort((a,b)=> (order[a.role]??99)-(order[b.role]??99)).forEach(u=>{
        const item = document.createElement("div");
        item.className = "user-item";

        const name = String(u.username || "");
        const role = String(u.role || "user").toUpperCase();
        const photo = u.photo || null;

        item.innerHTML = `
          <div class="u-ava">
            <img alt="u" />
            <div class="u-in">${escapeHtml(initials(name))}</div>
          </div>
          <div class="u-info">
            <div class="u-name">${escapeHtml(name)}</div>
            <div class="u-role">${escapeHtml(role)}</div>
          </div>
        `;

        const img = item.querySelector(".u-ava img");
        const inits = item.querySelector(".u-in");

        if(photo){
          img.src = photo;
          img.style.display = "block";
          inits.style.display = "none";
        }else{
          img.style.display = "none";
          inits.style.display = "block";
        }

        els.userList.appendChild(item);
      });
    }

    /* =========================
       SEND + FILE
    ========================== */
    function sendMessage(){
      if(!socket || !isConnected) return;

      const text = String(els.msgInput.value || "").trim();
      if(!text && !currentFile) return;

      if(currentFile){
        socket.emit("chat:image", {
          image: currentFileData,
          filename: currentFile.name,
          message: text,
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });
        clearFile();
      }else{
        socket.emit("chat:message", {
          message: text,
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });
      }

      els.msgInput.value = "";
      els.msgInput.style.height = "auto";
    }

    function handleFileSelect(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      const ok = f.type.startsWith("image/") || f.type.startsWith("video/");
      if(!ok) return alert("Hanya boleh image/video");
      if(f.size > 10*1024*1024) return alert("Max 10MB");

      currentFile = f;
      els.filePreview.classList.add("active");
      els.fileName.textContent = f.name;

      const r = new FileReader();
      r.onload = (ev)=> currentFileData = ev.target.result;
      r.readAsDataURL(f);
    }

    function clearFile(){
      currentFile = null;
      currentFileData = null;
      els.filePreview.classList.remove("active");
      els.fileInput.value = "";
    }

    /* =========================
       PREMIUM BACKGROUND FX (random objects)
       - glowing bubbles, hex outlines, particles
       - slow movement, premium vibe
    ========================== */
    function setupFX(){
      const c = els.fxCanvas;
      const ctx = c.getContext("2d", { alpha:true });

      const DPR = () => Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let w=0,h=0,dpr=1;

      function resize(){
        dpr = DPR();
        w = window.innerWidth;
        h = window.innerHeight;
        c.width = Math.floor(w * dpr);
        c.height = Math.floor(h * dpr);
        c.style.width = w + "px";
        c.style.height = h + "px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      const rand=(a,b)=>Math.random()*(b-a)+a;

      const particles=[];
      const bubbles=[];
      const hexes=[];

      const PCOUNT = Math.min(220, Math.floor((w*h)/6500));
      const BCOUNT = Math.min(14, Math.floor((w*h)/90000)+10);
      const HCOUNT = Math.min(9, Math.floor((w*h)/180000)+6);

      for(let i=0;i<PCOUNT;i++){
        particles.push({
          x: rand(0,w), y: rand(0,h),
          r: rand(.6, 1.6),
          a: rand(.10,.55),
          vx: rand(-.06,.06),
          vy: rand(-.05,.08)
        });
      }

      for(let i=0;i<BCOUNT;i++){
        bubbles.push({
          x: rand(0,w), y: rand(0,h),
          r: rand(26, 95),
          vx: rand(-.10,.12),
          vy: rand(-.08,.12),
          hue: rand(185, 265),
          a: rand(.06,.13),
          pulse: rand(.002,.008)
        });
      }

      for(let i=0;i<HCOUNT;i++){
        hexes.push({
          x: rand(0,w), y: rand(0,h),
          s: rand(26, 65),
          vx: rand(-.08,.08),
          vy: rand(-.07,.09),
          rot: rand(0, Math.PI),
          vr: rand(-.003,.003),
          a: rand(.05,.10),
          hue: rand(185, 255)
        });
      }

      function hexPath(x,y,size,rot){
        ctx.beginPath();
        for(let i=0;i<6;i++){
          const ang = rot + i*(Math.PI/3);
          const px = x + Math.cos(ang)*size;
          const py = y + Math.sin(ang)*size;
          if(i===0) ctx.moveTo(px,py);
          else ctx.lineTo(px,py);
        }
        ctx.closePath();
      }

      let t=0;
      function draw(){
        t++;
        ctx.clearRect(0,0,w,h);

        // particles
        for(const p of particles){
          p.x += p.vx; p.y += p.vy;
          if(p.x< -10) p.x=w+10; if(p.x>w+10) p.x=-10;
          if(p.y< -10) p.y=h+10; if(p.y>h+10) p.y=-10;

          ctx.beginPath();
          ctx.fillStyle = `rgba(205,230,255,${p.a})`;
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fill();
        }

        // bubbles (glow rings)
        for(const b of bubbles){
          b.x += b.vx; b.y += b.vy;
          if(b.x< -120) b.x=w+120; if(b.x>w+120) b.x=-120;
          if(b.y< -120) b.y=h+120; if(b.y>h+120) b.y=-120;

          const pulse = 1 + Math.sin(t*b.pulse)*0.06;
          const rr = b.r * pulse;

          const g = ctx.createRadialGradient(b.x,b.y, rr*0.15, b.x,b.y, rr);
          g.addColorStop(0, `hsla(${b.hue}, 90%, 70%, ${b.a})`);
          g.addColorStop(0.6, `hsla(${b.hue}, 90%, 60%, ${b.a*0.55})`);
          g.addColorStop(1, `hsla(${b.hue}, 90%, 60%, 0)`);

          ctx.fillStyle = g;
          ctx.beginPath();
          ctx.arc(b.x,b.y, rr, 0, Math.PI*2);
          ctx.fill();

          ctx.strokeStyle = `hsla(${b.hue}, 90%, 75%, ${b.a*0.85})`;
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.arc(b.x,b.y, rr*0.82, 0, Math.PI*2);
          ctx.stroke();
        }

        // hex outlines
        for(const hx of hexes){
          hx.x += hx.vx; hx.y += hx.vy;
          hx.rot += hx.vr;

          if(hx.x< -120) hx.x=w+120; if(hx.x>w+120) hx.x=-120;
          if(hx.y< -120) hx.y=h+120; if(hx.y>h+120) hx.y=-120;

          ctx.save();
          ctx.globalAlpha = 1;

          hexPath(hx.x,hx.y,hx.s,hx.rot);
          ctx.strokeStyle = `hsla(${hx.hue}, 90%, 70%, ${hx.a})`;
          ctx.lineWidth = 1;
          ctx.stroke();

          // inner
          hexPath(hx.x,hx.y,hx.s*0.62,hx.rot+0.25);
          ctx.strokeStyle = `hsla(${hx.hue+20}, 90%, 70%, ${hx.a*0.65})`;
          ctx.stroke();

          ctx.restore();
        }

        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);
    }

    /* =========================
       INIT
    ========================== */
    function init(){
      setupFX();

      // textarea autoresize
      els.msgInput.addEventListener("input", function(){
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      // UI events
      els.hamburger.addEventListener("click", ()=> sidebarOpen(true));
      els.overlay.addEventListener("click", ()=> sidebarOpen(false));
      document.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          els.imgModal.classList.remove("active");
          sidebarOpen(false);
        }
      });

      els.imgModal.addEventListener("click", ()=> els.imgModal.classList.remove("active"));

      els.attachBtn.addEventListener("click", ()=> els.fileInput.click());
      els.fileInput.addEventListener("change", handleFileSelect);
      els.fileRemove.addEventListener("click", clearFile);

      els.sendBtn.addEventListener("click", sendMessage);
      els.msgInput.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          sendMessage();
        }
      });

      els.msgInput.addEventListener("input", ()=>{
        if(!socket || !isConnected) return;
        if(typingTimeout) clearTimeout(typingTimeout);
        socket.emit("chat:typing", true);
        typingTimeout = setTimeout(()=> socket.emit("chat:typing", false), 900);
      });

      // profile open
      els.meAvatar.addEventListener("click", ()=> openGate("edit"));
      els.btnEdit.addEventListener("click", ()=> openGate("edit"));
      els.btnLogout.addEventListener("click", doLogout);

      // gate actions
      els.gateGo.addEventListener("click", doGateSave);
      els.gateUsername.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doGateSave(); });
      els.gateReset.addEventListener("click", ()=>{
        localStorage.removeItem(KEY_USER);
        localStorage.removeItem(KEY_PHOTO);
        els.gateUsername.value = "";
        els.gatePhoto.value = "";
        els.photoLabel.textContent = "Upload foto profil (opsional)";
        alert("Data login dihapus. Silakan isi lagi.");
      });
      els.gatePhoto.addEventListener("change", ()=>{
        const f = els.gatePhoto.files && els.gatePhoto.files[0];
        if(!f) return;
        els.photoLabel.textContent = `Foto: ${f.name}`;
      });

      // music
      els.musicBtn.addEventListener("click", toggleMusic);
      installAudioUnlock();
      tryPlayMusic();

      // load stored profile
      const savedName = (localStorage.getItem(KEY_USER) || "").trim();
      const savedPhoto = (localStorage.getItem(KEY_PHOTO) || "").trim();
      myUser.photo = savedPhoto || null;

      if(isValidUsername(savedName)){
        myUser.username = savedName;
        applyProfileUI();
        setConn("connecting","CONNECTING");
        connectSocket();
      }else{
        myUser.username = null;
        applyProfileUI();
        enableInput(false);
        setConn("disconnected","LOGIN REQUIRED");
        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-user-lock"></i> Please login (username)`;
        openGate("login");
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
