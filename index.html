<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0a0f18" />
  <title>LIVE CHAT | PREMIUM</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#070b12;
      --card: rgba(16, 24, 38, .55);
      --card2: rgba(10, 14, 24, .72);
      --stroke: rgba(120, 190, 255, .18);
      --stroke2: rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted: rgba(234,242,255,.55);
      --muted2: rgba(234,242,255,.32);

      --good:#4ade80;
      --warn:#facc15;
      --bad:#fb7185;

      --cyan:#7dd3fc;
      --blue:#60a5fa;
      --violet:#a78bfa;

      --fontH:'Orbitron',sans-serif;
      --fontB:'Share Tech Mono',monospace;

      --r12:12px;
      --r16:16px;
      --r20:20px;
      --r24:24px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:var(--fontB); -webkit-tap-highlight-color:transparent; }
    html, body { height:100%; }
    body{
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(120,190,255,.14), transparent 60%),
        radial-gradient(900px 900px at 80% 10%, rgba(167,139,250,.10), transparent 55%),
        radial-gradient(1000px 900px at 50% 110%, rgba(96,165,250,.10), transparent 60%),
        linear-gradient(180deg, #050812, #070b12 55%, #050812);
      color: var(--text);
      overflow:hidden;
    }

    /* ===== Premium background canvas (random objects) ===== */
    .bg-wrap{
      position:fixed; inset:0; z-index:-2;
      pointer-events:none;
    }
    canvas#fxCanvas{
      width:100%; height:100%;
      display:block;
      filter: drop-shadow(0 0 18px rgba(125,211,252,.22));
    }

    /* ===== subtle glow overlay (no blur on content) ===== */
    .glow{
      position:fixed; inset:0; z-index:-1;
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(125,211,252,.10), transparent 70%),
        radial-gradient(800px 800px at 15% 80%, rgba(96,165,250,.08), transparent 60%),
        radial-gradient(750px 750px at 88% 72%, rgba(167,139,250,.06), transparent 55%);
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.95;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.16); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,.25); }

    .app{
      height:100dvh;
      width:100%;
      max-width:1600px;
      margin:0 auto;
      display:flex;
      position:relative;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:310px;
      flex-shrink:0;
      border-right:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,15,24,.72), rgba(10,15,24,.35));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      z-index:50;
      transition: transform .28s cubic-bezier(.4,0,.2,1);
    }

    .user-card{
      padding:20px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,24,38,.74), rgba(10,15,24,.28));
    }

    .profile-top{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .avatar{
      width:66px; height:66px;
      border-radius:20px;
      border:1px solid rgba(125,211,252,.38);
      background: rgba(0,0,0,.35);
      box-shadow:
        0 14px 45px rgba(0,0,0,.38),
        0 0 0 1px rgba(255,255,255,.06) inset;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      position:relative;
      cursor:pointer;
    }
    .avatar::after{
      content:"";
      position:absolute; inset:-30%;
      background: conic-gradient(from 180deg, rgba(125,211,252,.0), rgba(96,165,250,.22), rgba(167,139,250,.18), rgba(125,211,252,.0));
      animation: spin 6.8s linear infinite;
      opacity:.75;
    }
    .avatar > *{ position:relative; z-index:2; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .avatar img{
      width:100%; height:100%; object-fit:cover;
      display:none;
    }
    .avatar .initials{
      font-family:var(--fontH);
      font-weight:800;
      letter-spacing:1px;
      color:#eaf2ff;
      font-size:20px;
      opacity:.92;
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .me-info{ min-width:0; flex:1; }
    .me-name{
      font-family:var(--fontH);
      font-size:15px;
      letter-spacing:1px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .me-sub{
      margin-top:6px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      user-select:none;
    }
    .pill strong{
      color: var(--text);
      font-weight:800;
      letter-spacing:1px;
      font-family:var(--fontH);
      font-size:10px;
    }

    .status-dot{
      width:7px; height:7px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 12px rgba(250,204,21,.35);
    }
    .status-dot.connected{ background: var(--good); box-shadow: 0 0 12px rgba(74,222,128,.35); }
    .status-dot.disconnected{ background: var(--bad); box-shadow: 0 0 12px rgba(251,113,133,.35); }

    .card-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-family:var(--fontH);
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.40); background: rgba(0,0,0,.32); }
    .btn.danger{ border-color: rgba(251,113,133,.25); }
    .btn.danger:hover{ border-color: rgba(251,113,133,.45); }

    /* Under hamburger request: Online count then Music button */
    .mini-panel{
      padding:14px 20px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      flex-direction:column;
      gap:10px;
      background: linear-gradient(180deg, rgba(12,18,30,.38), rgba(12,18,30,.16));
    }
    .mini-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .mini-title{
      font-family:var(--fontH);
      letter-spacing:1px;
      font-size:11px;
      color: var(--muted);
      text-transform:uppercase;
    }
    .mini-value{
      font-family:var(--fontH);
      letter-spacing:1px;
      font-size:11px;
      color: var(--text);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      min-width:52px;
      text-align:center;
    }

    .music-btn{
      width:100%;
      padding:11px 12px;
      border-radius:16px;
      border:1px solid rgba(125,211,252,.22);
      background: linear-gradient(135deg, rgba(96,165,250,.20), rgba(167,139,250,.10));
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      font-family:var(--fontH);
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:11px;
      user-select:none;
      box-shadow: 0 10px 32px rgba(0,0,0,.22);
    }
    .music-btn:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.45); }
    .music-state-dot{
      width:8px; height:8px; border-radius:50%;
      background: rgba(234,242,255,.25);
      box-shadow: 0 0 14px rgba(125,211,252,.20);
    }
    .music-on .music-state-dot{ background: var(--good); box-shadow: 0 0 14px rgba(74,222,128,.35); }
    .music-off .music-state-dot{ background: rgba(234,242,255,.25); }

    .online-users{
      flex:1;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .section-header{
      padding:14px 20px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      color: var(--muted);
    }
    .users-list{
      flex:1;
      overflow:auto;
      padding:12px 10px;
      min-height:0;
    }
    .user-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px;
      border-radius:14px;
      border:1px solid transparent;
      background: rgba(0,0,0,.10);
      margin-bottom:8px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .15s ease;
    }
    .user-item:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,.18);
      border-color: rgba(125,211,252,.18);
    }
    .u-ava{
      width:36px;height:36px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1px;
      color: var(--text);
      overflow:hidden;
      flex-shrink:0;
      position:relative;
    }
    .u-ava::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(125,211,252,.35), transparent 55%);
      opacity:.35;
      pointer-events:none;
    }
    .u-ava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .u-in{ position:relative; z-index:2; }
    .u-info{ min-width:0; }
    .u-name{ font-size:13px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .u-role{ font-size:10px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-top:2px; }

    /* ===== Chat area ===== */
    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
      position:relative;
    }
    .chat-header{
      height:66px;
      flex-shrink:0;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,24,38,.68), rgba(10,15,24,.24));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      gap:10px;
      z-index:10;
    }
    .left-head{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .hamburger{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      flex-shrink:0;
    }
    .hamburger:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.40); }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand h1{
      font-family:var(--fontH);
      font-size:16px;
      letter-spacing:2px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .badge-prem{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(125,211,252,.25);
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(167,139,250,.10));
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--text);
      white-space:nowrap;
    }

    .right-head{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .conn-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(74,222,128,.25);
      background: rgba(0,0,0,.20);
      font-family:var(--fontH);
      letter-spacing:2px;
      font-size:10px;
      text-transform:uppercase;
      color: rgba(74,222,128,.95);
    }
    .conn-pill.disc{
      border-color: rgba(251,113,133,.25);
      color: rgba(251,113,133,.95);
    }
    .conn-pill.conn{
      border-color: rgba(250,204,21,.25);
      color: rgba(250,204,21,.95);
    }

    .messages{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:18px 16px 14px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
    }

    .sys{
      align-self:center;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:center;
      max-width:92%;
    }

    /* Message row with avatar (premium) */
    .mrow{
      display:flex;
      align-items:flex-end;
      gap:10px;
      max-width:92%;
      animation: pop .18s ease;
    }
    .mrow.own{ align-self:flex-end; flex-direction: row-reverse; }
    .mrow.other{ align-self:flex-start; }

    @keyframes pop{
      from{ transform: translateY(6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .mava{
      width:34px; height:34px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.24);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      position:relative;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .mava::after{
      content:"";
      position:absolute; inset:-45%;
      background: radial-gradient(circle at 30% 30%, rgba(125,211,252,.35), transparent 58%);
      opacity:.35;
      pointer-events:none;
    }
    .mava img{ width:100%; height:100%; object-fit:cover; display:none; }
    .mava .ini{
      position:relative; z-index:2;
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:1px;
      opacity:.92;
    }

    .mbox{
      display:flex;
      flex-direction:column;
      min-width:0;
      max-width:100%;
      gap:6px;
    }

    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted2);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta .name{
      font-family:var(--fontH);
      letter-spacing:2px;
      color: var(--text);
      font-size:10px;
    }
    .role-badge{
      font-family:var(--fontH);
      font-size:9px;
      letter-spacing:2px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      flex-shrink:0;
    }
    .bubble{
      border-radius: 18px;
      padding:12px 14px;
      line-height:1.55;
      font-size:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      word-break:break-word;
    }
    .mrow.own .bubble{
      background: linear-gradient(135deg, rgba(96,165,250,.22), rgba(167,139,250,.10));
      border-color: rgba(125,211,252,.25);
    }
    .bubble img{
      max-width:100%;
      display:block;
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }

    /* Input */
    .input{
      flex-shrink:0;
      border-top:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,15,24,.22), rgba(16,24,38,.58));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:12px 14px;
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .input .wrap{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .file-preview{
      display:none;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
      align-items:center;
      gap:10px;
    }
    .file-preview.active{ display:flex; }
    .file-preview .remove{ margin-left:auto; cursor:pointer; opacity:.85; }

    textarea{
      width:100%;
      min-height:52px;
      max-height:130px;
      resize:none;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.32);
      color: var(--text);
      outline:none;
      font-size:14px;
      transition: border-color .15s ease, background .15s ease;
    }
    textarea:focus{ border-color: rgba(125,211,252,.38); background: rgba(0,0,0,.38); }

    .btns{
      display:flex;
      gap:10px;
      flex-shrink:0;
    }
    .icon{
      width:54px;height:54px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.20);
    }
    .icon:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.25); }
    .send{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.80));
      border-color: rgba(125,211,252,.35);
      color:#07101e;
      font-weight:900;
    }
    .send:disabled, .icon:disabled, textarea:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    /* Typing */
    .typing{
      height:18px;
      padding:0 16px 10px;
      color: var(--muted2);
      font-size:11px;
      display:none;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .typing .dots span{
      width:4px;height:4px;border-radius:999px;
      background: rgba(234,242,255,.45);
      display:inline-block;
      animation: bounce 1.2s infinite;
      margin-right:3px;
    }
    .typing .dots span:nth-child(2){ animation-delay:.15s; }
    .typing .dots span:nth-child(3){ animation-delay:.3s; }
    @keyframes bounce{ 0%,80%,100%{ transform: scale(.2); opacity:.4; } 40%{ transform: scale(1); opacity:1; } }

    /* Modal image */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:18px;
    }
    .modal.active{ display:flex; }
    .modal img{
      max-width:95%;
      max-height:90vh;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
    }

    /* Overlay for mobile sidebar */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      z-index:40;
    }
    .overlay.active{ display:block; }

    /* LOGIN / PROFILE modal */
    .gate{
      position:fixed; inset:0;
      z-index:3000;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .gate.active{ display:flex; }
    .gate-card{
      width:100%;
      max-width:540px;
      border-radius:20px;
      border:1px solid rgba(125,211,252,.18);
      background: linear-gradient(180deg, rgba(16,24,38,.78), rgba(10,15,24,.58));
      box-shadow: 0 25px 85px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .gate-head{
      padding:18px 18px 12px;
      border-bottom:1px solid rgba(125,211,252,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .gate-title{
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:14px;
    }
    .gate-sub{
      padding:0 18px 14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .gate-body{
      padding:16px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .field{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    .field:focus{ border-color: rgba(125,211,252,.35); }
    .upload{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:16px;
      border:1px dashed rgba(125,211,252,.22);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .gate-footer{
      padding:14px 18px 18px;
      display:flex;
      gap:10px;
    }
    .primary{
      flex:1;
      padding:12px 12px;
      border-radius:16px;
      border:none;
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.80));
      color:#07101e;
      font-weight:900;
    }
    .secondary{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
    }
    .hint{
      padding:0 18px 16px;
      color: var(--muted2);
      font-size:11px;
    }

    @media (max-width: 900px){
      .sidebar{
        position:fixed;
        top:0; bottom:0; left:0;
        transform: translateX(-105%);
        width:286px;
        box-shadow: 18px 0 60px rgba(0,0,0,.55);
      }
      .sidebar.active{ transform: translateX(0); }
      .mrow{ max-width:100%; }
    }
  </style>
</head>

<body>
  <!-- Background -->
  <div class="bg-wrap">
    <canvas id="fxCanvas"></canvas>
  </div>
  <div class="glow"></div>

  <!-- LOGIN / PROFILE GATE -->
  <div class="gate" id="gate">
    <div class="gate-card">
      <div class="gate-head">
        <div class="gate-title" id="gateTitle">LOGIN</div>
        <span class="pill"><span class="status-dot disconnected"></span><strong>Profile</strong></span>
      </div>
      <div class="gate-sub" id="gateSub">
        Masukin <b>username</b> & (opsional) <b>foto profil</b> biar tampil di chat.<br/>
        Data disimpan di browser kamu (localStorage).
      </div>
      <div class="gate-body">
        <div class="row">
          <input id="gateUsername" class="field" maxlength="20" placeholder="username (3-20) contoh: raraa_01" autocomplete="off"/>
          <label class="upload" for="gatePhoto">
            <i class="fa-solid fa-image"></i>
            <span id="photoLabel">Upload foto profil (opsional)</span>
          </label>
          <input id="gatePhoto" type="file" accept="image/*" style="display:none"/>
        </div>
      </div>
      <div class="gate-footer">
        <button class="primary" id="gateGo">Masuk</button>
        <button class="secondary" id="gateReset" title="hapus data login">Reset</button>
      </div>
      <div class="hint">
        Autoplay musik kadang diblokir browser — kalau tidak bunyi, tekan tombol MUSIC.
      </div>
    </div>
  </div>

  <!-- Mobile overlay -->
  <div class="overlay" id="overlay"></div>

  <!-- Image modal -->
  <div class="modal" id="imgModal">
    <img id="imgModalEl" alt="preview"/>
  </div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="profile-top">
          <div class="avatar" id="meAvatar" role="button" tabindex="0" title="Edit profile">
            <img id="meAvatarImg" alt="me"/>
            <div class="initials" id="meInitials">ME</div>
          </div>
          <div class="me-info">
            <div class="me-name" id="meName">Loading...</div>
            <div class="me-sub">
              <span class="pill"><span class="status-dot" id="connDot"></span><strong id="connText">CONNECTING</strong></span>
              <span class="pill"><i class="fa-solid fa-user-shield"></i><strong id="meRole">USER</strong></span>
            </div>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn" id="btnEdit"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
          <button class="btn danger" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>

      <!-- Under hamburger: online count then music button -->
      <div class="mini-panel">
        <div class="mini-row">
          <div class="mini-title"><i class="fa-solid fa-users"></i> Online</div>
          <div class="mini-value" id="onlineCount">0</div>
        </div>

        <button class="music-btn music-off" id="musicBtn">
          <span class="music-state-dot" id="musicDot"></span>
          <span id="musicText">MUSIC OFF</span>
        </button>
      </div>

      <div class="online-users">
        <div class="section-header">
          <span>Online Users</span>
          <span id="onlineCountTop">0</span>
        </div>
        <div class="users-list" id="userList"></div>
      </div>
    </aside>

    <!-- CHAT -->
    <main class="chat">
      <header class="chat-header">
        <div class="left-head">
          <button class="hamburger" id="hamburger" aria-label="menu">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div class="brand">
            <h1>LIVE CHAT</h1>
            <span class="badge-prem">PREMIUM</span>
          </div>
        </div>
        <div class="right-head">
          <div class="conn-pill conn" id="connPill"><i class="fa-solid fa-wifi"></i> CONNECTING</div>
        </div>
      </header>

      <section class="messages" id="messages">
        <div class="sys" id="welcome">
          <i class="fa-solid fa-circle-notch fa-spin"></i>
          Waiting for login...
        </div>
      </section>

      <div class="typing" id="typing">
        <div class="dots"><span></span><span></span><span></span></div>
        <div id="typingText">Someone is typing...</div>
      </div>

      <footer class="input">
        <div class="wrap">
          <div class="file-preview" id="filePreview">
            <i class="fa-solid fa-paperclip"></i>
            <span id="fileName" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;">file</span>
            <i class="fa-solid fa-xmark remove" id="fileRemove"></i>
          </div>
          <textarea id="msgInput" placeholder="Type message (or select image)..." disabled></textarea>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none"/>
        <div class="btns">
          <button class="icon" id="attachBtn" disabled><i class="fa-solid fa-paperclip"></i></button>
          <button class="icon send" id="sendBtn" disabled><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </footer>
    </main>
  </div>

  <!-- Audio (loop) -->
  <audio id="bgm" preload="auto" loop>
    <source src="https://files.catbox.moe/wlny2m.mp3" type="audio/mpeg"/>
  </audio>

  <!-- IMPORTANT: backend socket beda domain? set di sini -->
  <script>
    window.SOCKET_URL = "https://livechatscarrydeath.raraaprivate.my.id";
  </script>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
    /* =========================
       CONFIG + STORAGE
    ========================== */
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;
    const KEY_USER  = "ic_username";
    const KEY_PHOTO = "ic_profile_photo";
    const KEY_ROLE  = "ic_role";

    const els = {
      gate: document.getElementById("gate"),
      gateTitle: document.getElementById("gateTitle"),
      gateSub: document.getElementById("gateSub"),
      gateUsername: document.getElementById("gateUsername"),
      gatePhoto: document.getElementById("gatePhoto"),
      photoLabel: document.getElementById("photoLabel"),
      gateGo: document.getElementById("gateGo"),
      gateReset: document.getElementById("gateReset"),

      sidebar: document.getElementById("sidebar"),
      overlay: document.getElementById("overlay"),
      hamburger: document.getElementById("hamburger"),

      meAvatar: document.getElementById("meAvatar"),
      meAvatarImg: document.getElementById("meAvatarImg"),
      meInitials: document.getElementById("meInitials"),
      meName: document.getElementById("meName"),
      meRole: document.getElementById("meRole"),
      btnEdit: document.getElementById("btnEdit"),
      btnLogout: document.getElementById("btnLogout"),

      onlineCount: document.getElementById("onlineCount"),
      onlineCountTop: document.getElementById("onlineCountTop"),
      userList: document.getElementById("userList"),

      connDot: document.getElementById("connDot"),
      connText: document.getElementById("connText"),
      connPill: document.getElementById("connPill"),

      messages: document.getElementById("messages"),
      welcome: document.getElementById("welcome"),
      typing: document.getElementById("typing"),
      typingText: document.getElementById("typingText"),

      msgInput: document.getElementById("msgInput"),
      sendBtn: document.getElementById("sendBtn"),
      attachBtn: document.getElementById("attachBtn"),
      fileInput: document.getElementById("fileInput"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      fileRemove: document.getElementById("fileRemove"),

      imgModal: document.getElementById("imgModal"),
      imgModalEl: document.getElementById("imgModalEl"),

      musicBtn: document.getElementById("musicBtn"),
      musicText: document.getElementById("musicText"),
      musicDot: document.getElementById("musicDot"),
      bgm: document.getElementById("bgm"),

      fxCanvas: document.getElementById("fxCanvas"),
    };

    const myUser = {
      username: null,
      role: (localStorage.getItem(KEY_ROLE) || "user"),
      photo: null,
    };

    let socket = null;
    let isConnected = false;
    let typingTimeout = null;
    let pingInterval = null;
    let lastPing = Date.now();

    let currentFile = null;
    let currentFileData = null;

    /* =========================
       UTIL
    ========================== */
    function escapeHtml(t){
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    }
    function isValidUsername(name){
      return /^[A-Za-z0-9_]{3,20}$/.test(String(name || "").trim());
    }
    function initials(name){
      const s = String(name || "").trim();
      return (s.substring(0,2).toUpperCase() || "ME");
    }
    function enableInput(on){
      els.msgInput.disabled = !on;
      els.sendBtn.disabled = !on;
      els.attachBtn.disabled = !on;
      if(on) els.msgInput.focus();
    }
    function setConn(status, label){
      els.connDot.classList.remove("connected","disconnected");
      els.connPill.classList.remove("disc","conn");
      if(status === "connected"){
        els.connDot.classList.add("connected");
        els.connPill.innerHTML = `<i class="fa-solid fa-wifi"></i> ${label || "CONNECTED"}`;
      } else if(status === "connecting"){
        els.connPill.classList.add("conn");
        els.connPill.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${label || "CONNECTING"}`;
      } else {
        els.connDot.classList.add("disconnected");
        els.connPill.classList.add("disc");
        els.connPill.innerHTML = `<i class="fa-solid fa-wifi-slash"></i> ${label || "DISCONNECTED"}`;
      }
      els.connText.textContent = (label || status).toUpperCase();
    }

    function applyProfileUI(){
      els.meName.textContent = myUser.username || "Guest";
      els.meRole.textContent = String(myUser.role || "user").toUpperCase();
      els.meInitials.textContent = initials(myUser.username);

      if(myUser.photo){
        els.meAvatarImg.src = myUser.photo;
        els.meAvatarImg.style.display = "block";
        els.meInitials.style.display = "none";
      }else{
        els.meAvatarImg.removeAttribute("src");
        els.meAvatarImg.style.display = "none";
        els.meInitials.style.display = "block";
      }
    }

    /* =========================
       SIDEBAR TOGGLE
    ========================== */
    function sidebarOpen(open){
      const show = (open === undefined) ? !els.sidebar.classList.contains("active") : open;
      if(show){
        els.sidebar.classList.add("active");
        els.overlay.classList.add("active");
      }else{
        els.sidebar.classList.remove("active");
        els.overlay.classList.remove("active");
      }
    }

    /* =========================
       LOGIN / EDIT PROFILE
    ========================== */
    function openGate(mode){
      els.gate.classList.add("active");
      if(mode === "edit"){
        els.gateTitle.textContent = "EDIT PROFILE";
        els.gateSub.innerHTML = `Ubah <b>username</b> / <b>foto profil</b>. Akan langsung dipakai di chat.`;
        els.gateUsername.value = myUser.username || "";
        els.photoLabel.textContent = myUser.photo ? "Ganti foto profil (sudah ada)" : "Upload foto profil (opsional)";
      } else {
        els.gateTitle.textContent = "LOGIN";
        els.gateSub.innerHTML = `Masukin <b>username</b> & (opsional) <b>foto profil</b> biar tampil di chat.<br/>Data disimpan di browser kamu (localStorage).`;
        els.gateUsername.value = "";
        els.photoLabel.textContent = "Upload foto profil (opsional)";
      }
      setTimeout(()=> els.gateUsername.focus(), 50);
    }

    function closeGate(){
      els.gate.classList.remove("active");
    }

    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function doGateSave(){
      const name = String(els.gateUsername.value || "").trim();
      if(!isValidUsername(name)){
        alert("Username harus 3–20 karakter dan hanya huruf/angka/underscore.");
        els.gateUsername.focus();
        els.gateUsername.select();
        return;
      }

      myUser.username = name;
      localStorage.setItem(KEY_USER, name);

      // photo optional
      if(els.gatePhoto.files && els.gatePhoto.files[0]){
        const f = els.gatePhoto.files[0];
        if(!f.type.startsWith("image/")){
          alert("Foto profil harus gambar.");
          return;
        }
        if(f.size > 2 * 1024 * 1024){
          alert("Foto profil max 2MB biar ringan.");
          return;
        }
        myUser.photo = await fileToBase64(f);
        localStorage.setItem(KEY_PHOTO, myUser.photo);
      } else {
        const savedPhoto = localStorage.getItem(KEY_PHOTO);
        myUser.photo = savedPhoto ? savedPhoto : null;
      }

      applyProfileUI();
      closeGate();

      if(!socket){
        connectSocket();
      }else{
        if(isConnected) socket.emit("chat:login", { username: myUser.username, role: myUser.role, photo: myUser.photo });
      }
    }

    function doLogout(){
      localStorage.removeItem(KEY_USER);
      localStorage.removeItem(KEY_PHOTO);

      myUser.username = null;
      myUser.photo = null;

      try{ if(socket) socket.disconnect(); }catch(_){}
      socket = null;
      isConnected = false;

      els.messages.innerHTML = "";
      els.messages.appendChild(els.welcome);
      els.welcome.style.display = "flex";
      els.welcome.innerHTML = `<i class="fa-solid fa-user-lock"></i> Please login (username)`;

      enableInput(false);
      setConn("disconnected","LOGIN REQUIRED");
      applyProfileUI();

      sidebarOpen(false);
      openGate("login");
    }

    /* =========================
       MUSIC (best-effort autoplay)
    ========================== */
    let musicOn = false;

    async function tryPlayMusic(){
      try{
        els.bgm.volume = 0.75;
        await els.bgm.play();
        setMusicState(true);
      }catch(err){
        setMusicState(false);
      }
    }

    function setMusicState(on){
      musicOn = !!on;
      els.musicBtn.classList.toggle("music-on", musicOn);
      els.musicBtn.classList.toggle("music-off", !musicOn);
      els.musicText.textContent = musicOn ? "MUSIC ON" : "MUSIC OFF";
    }

    async function toggleMusic(){
      try{
        if(musicOn){
          els.bgm.pause();
          setMusicState(false);
        }else{
          await els.bgm.play();
          setMusicState(true);
        }
      }catch(_){
        setMusicState(false);
        alert("Browser kamu blok autoplay. Coba klik lagi / unmute perangkat.");
      }
    }

    function installAudioUnlock(){
      const unlock = async () => {
        if(!musicOn){
          try{ await els.bgm.play(); setMusicState(true); }catch(_){}
        }
        window.removeEventListener("touchstart", unlock);
        window.removeEventListener("click", unlock);
      };
      window.addEventListener("touchstart", unlock, { once:true });
      window.addEventListener("click", unlock, { once:true });
    }

    /* =========================
       SOCKET
    ========================== */
    function connectSocket(){
      if(!window.io){
        setConn("disconnected","SOCKET CLIENT MISSING");
        return;
      }

      setConn("connecting","CONNECTING");
      enableInput(false);

      socket = io(SOCKET_URL, { transports:["websocket","polling"] });

      socket.on("connect", ()=>{
        isConnected = true;
        setConn("connected","CONNECTED");

        socket.emit("chat:login", {
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-check"></i> Connected as ${escapeHtml(myUser.username)}`;
        setTimeout(()=> els.welcome.style.display = "none", 2000);

        enableInput(true);
        startPing();
      });

      socket.on("disconnect", ()=>{
        isConnected = false;
        setConn("disconnected","DISCONNECTED");
        enableInput(false);

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Disconnected`;
        stopPing();
      });

      socket.on("connect_error", ()=>{
        isConnected = false;
        setConn("disconnected","CONNECT ERROR");
        enableInput(false);

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Cannot connect to Socket server`;
      });

      socket.on("chat:history", (history)=>{
        els.messages.innerHTML = "";
        (history || []).forEach(m => m.image ? addImageMessage(m) : addMessage(m));
        scrollBottom();
      });

      socket.on("chat:newMessage", (msg)=>{
        addMessage(msg);
        scrollBottom();
      });

      socket.on("chat:image", (msg)=>{
        addImageMessage(msg);
        scrollBottom();
      });

      socket.on("chat:userTyping", (data)=>{
        if(!data) return;
        if(data.username !== myUser.username){
          els.typing.style.display = data.isTyping ? "flex" : "none";
          els.typingText.textContent = `${data.username} is typing...`;
        }
      });

      socket.on("chat:onlineUsers", (data)=>{
        const count = Number(data?.count ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
        renderUserList(data?.users || []);
      });

      socket.on("chat:userJoin", (data)=>{
        const name = escapeHtml(data?.username || "someone");
        systemMsg(`${name} joined`);
        const count = Number(data?.onlineCount ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
      });

      socket.on("chat:userLeave", (data)=>{
        const name = escapeHtml(data?.username || "someone");
        systemMsg(`${name} left`);
        const count = Number(data?.onlineCount ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
      });

      socket.on("pong", ()=>{});
    }

    function startPing(){
      stopPing();
      pingInterval = setInterval(()=>{
        if(!socket || !isConnected) return;
        lastPing = Date.now();
        socket.emit("ping");
      }, 5000);
    }
    function stopPing(){
      if(pingInterval) clearInterval(pingInterval);
      pingInterval = null;
    }

    /* =========================
       CHAT UI (WITH AVATAR)
    ========================== */
    function scrollBottom(){
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function systemMsg(text){
      const d = document.createElement("div");
      d.className = "sys";
      d.innerHTML = `<i class="fa-solid fa-bolt"></i> ${text}`;
      els.messages.appendChild(d);
      scrollBottom();
      setTimeout(()=> d.remove(), 4500);
    }

    function buildAvatarNode(photo, name){
      const wrap = document.createElement("div");
      wrap.className = "mava";
      const img = document.createElement("img");
      const ini = document.createElement("div");
      ini.className = "ini";
      ini.textContent = initials(name);
      if(photo){
        img.src = photo;
        img.style.display = "block";
        ini.style.display = "none";
      }else{
        img.style.display = "none";
        ini.style.display = "block";
      }
      wrap.appendChild(img);
      wrap.appendChild(ini);
      return wrap;
    }

    function addMessage(data){
      const isOwn = (data?.username === myUser.username);
      const time = new Date(data?.timestamp || Date.now()).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
      const role = String(data?.role || "user").toUpperCase();

      const photo = isOwn ? myUser.photo : (data?.photo || null);

      const row = document.createElement("div");
      row.className = `mrow ${isOwn ? "own" : "other"}`;

      const ava = buildAvatarNode(photo, data?.username || "");
      const box = document.createElement("div");
      box.className = "mbox";
      box.innerHTML = `
        <div class="meta">
          <span class="name">${escapeHtml(data?.username || "")}</span>
          <span class="role-badge">${escapeHtml(role)}</span>
          <span>${time}</span>
        </div>
        <div class="bubble">${escapeHtml(data?.message || "").replace(/\n/g,"<br>")}</div>
      `;

      row.appendChild(ava);
      row.appendChild(box);
      els.messages.appendChild(row);
    }

    function addImageMessage(data){
      const isOwn = (data?.username === myUser.username);
      const time = new Date(data?.timestamp || Date.now()).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
      const role = String(data?.role || "user").toUpperCase();

      const photo = isOwn ? myUser.photo : (data?.photo || null);

      const row = document.createElement("div");
      row.className = `mrow ${isOwn ? "own" : "other"}`;

      const ava = buildAvatarNode(photo, data?.username || "");
      const box = document.createElement("div");
      box.className = "mbox";

      const caption = data?.message ? `<div style="margin-bottom:8px">${escapeHtml(data.message).replace(/\n/g,"<br>")}</div>` : "";
      const img = data?.image ? `<img src="${data.image}" data-preview="1" alt="image"/>` : "";

      box.innerHTML = `
        <div class="meta">
          <span class="name">${escapeHtml(data?.username || "")}</span>
          <span class="role-badge">${escapeHtml(role)}</span>
          <span>${time}</span>
        </div>
        <div class="bubble">
          ${caption}
          ${img}
        </div>
      `;

      row.appendChild(ava);
      row.appendChild(box);
      els.messages.appendChild(row);

      const im = row.querySelector('img[data-preview="1"]');
      if(im){
        im.addEventListener("click", ()=>{
          els.imgModalEl.src = data.image;
          els.imgModal.classList.add("active");
        });
      }
    }

    function renderUserList(users){
      els.userList.innerHTML = "";
      const order = { owner:0, admin:1, user:2 };
      users.slice().sort((a,b)=> (order[a.role]??99)-(order[b.role]??99)).forEach(u=>{
        const item = document.createElement("div");
        item.className = "user-item";

        const name = String(u.username || "");
        const role = String(u.role || "user").toUpperCase();
        const photo = u.photo || null;

        item.innerHTML = `
          <div class="u-ava">
            <img alt="u" />
            <div class="u-in">${escapeHtml(initials(name))}</div>
          </div>
          <div class="u-info">
            <div class="u-name">${escapeHtml(name)}</div>
            <div class="u-role">${escapeHtml(role)}</div>
          </div>
        `;

        const img = item.querySelector(".u-ava img");
        const inits = item.querySelector(".u-in");

        if(photo){
          img.src = photo;
          img.style.display = "block";
          inits.style.display = "none";
        }else{
          img.style.display = "none";
          inits.style.display = "block";
        }

        els.userList.appendChild(item);
      });
    }

    /* =========================
       SEND + FILE
    ========================== */
    function sendMessage(){
      if(!socket || !isConnected) return;

      const text = String(els.msgInput.value || "").trim();
      if(!text && !currentFile) return;

      if(currentFile){
        socket.emit("chat:image", {
          image: currentFileData,
          filename: currentFile.name,
          message: text,
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });
        clearFile();
      }else{
        socket.emit("chat:message", {
          message: text,
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });
      }

      els.msgInput.value = "";
      els.msgInput.style.height = "auto";
    }

    function handleFileSelect(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      const ok = f.type.startsWith("image/") || f.type.startsWith("video/");
      if(!ok) return alert("Hanya boleh image/video");
      if(f.size > 10*1024*1024) return alert("Max 10MB");

      currentFile = f;
      els.filePreview.classList.add("active");
      els.fileName.textContent = f.name;

      const r = new FileReader();
      r.onload = (ev)=> currentFileData = ev.target.result;
      r.readAsDataURL(f);
    }

    function clearFile(){
      currentFile = null;
      currentFileData = null;
      els.filePreview.classList.remove("active");
      els.fileInput.value = "";
    }

    /* =========================
       PREMIUM BACKGROUND (Random Objects)
       - floating orbs + diamonds + hex outlines
       - slow movement + parallax feel
    ========================== */
    function setupFX(){
      const c = els.fxCanvas;
      const ctx = c.getContext("2d", { alpha:true });

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        c.width = Math.floor(window.innerWidth * dpr);
        c.height = Math.floor(window.innerHeight * dpr);
        c.style.width = window.innerWidth + "px";
        c.style.height = window.innerHeight + "px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      const W = () => window.innerWidth;
      const H = () => window.innerHeight;
      const rand = (a,b)=> Math.random()*(b-a)+a;

      const palette = [
        {a:[125,211,252], b:[96,165,250]},
        {a:[167,139,250], b:[125,211,252]},
        {a:[96,165,250], b:[167,139,250]},
      ];

      const objs = [];
      const count = Math.min(26, Math.max(16, Math.floor((W()*H())/42000)));

      for(let i=0;i<count;i++){
        const p = palette[Math.floor(Math.random()*palette.length)];
        objs.push({
          type: ["orb","diamond","hex"][Math.floor(Math.random()*3)],
          x: rand(0,W()),
          y: rand(0,H()),
          r: rand(18, 60),
          vx: rand(-0.12, 0.12),
          vy: rand(-0.10, 0.10),
          rot: rand(0, Math.PI*2),
          vr: rand(-0.0025, 0.0025),
          alpha: rand(0.12, 0.35),
          glow: rand(0.20, 0.55),
          colA: p.a,
          colB: p.b,
          phase: rand(0, 1000),
        });
      }

      const stars = [];
      const sCount = Math.min(240, Math.max(120, Math.floor((W()*H())/6500)));
      for(let i=0;i<sCount;i++){
        stars.push({
          x: rand(0,W()),
          y: rand(0,H()),
          r: rand(.4, 1.5),
          a: rand(.10, .75),
          tw: rand(.002, .01),
          sp: rand(.06, .22)
        });
      }

      function rgba(arr, a){
        return `rgba(${arr[0]},${arr[1]},${arr[2]},${a})`;
      }

      function drawDiamond(x,y,r,rot,stroke){
        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(rot);
        ctx.beginPath();
        ctx.moveTo(0, -r);
        ctx.lineTo(r*0.8, 0);
        ctx.lineTo(0, r);
        ctx.lineTo(-r*0.8, 0);
        ctx.closePath();
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 1.2;
        ctx.stroke();
        ctx.restore();
      }

      function drawHex(x,y,r,rot,stroke){
        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(rot);
        ctx.beginPath();
        for(let i=0;i<6;i++){
          const a = (Math.PI/3)*i;
          const px = Math.cos(a)*r;
          const py = Math.sin(a)*r;
          if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
        }
        ctx.closePath();
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 1.1;
        ctx.stroke();
        ctx.restore();
      }

      let t = 0;
      function frame(){
        t += 1;
        ctx.clearRect(0,0,W(),H());

        // star field (slow drift)
        for(const s of stars){
          s.a += (Math.random()<0.5?-1:1)*s.tw;
          s.a = Math.max(0.06, Math.min(0.92, s.a));
          s.y += s.sp*0.12;
          if(s.y > H()+10) s.y = -10;

          ctx.beginPath();
          ctx.fillStyle = `rgba(180,220,255,${s.a})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();
        }

        // objects
        for(const o of objs){
          o.x += o.vx;
          o.y += o.vy + Math.sin((t+o.phase)*0.002)*0.06;
          o.rot += o.vr;

          if(o.x < -120) o.x = W()+120;
          if(o.x > W()+120) o.x = -120;
          if(o.y < -140) o.y = H()+140;
          if(o.y > H()+140) o.y = -140;

          const g = ctx.createRadialGradient(o.x, o.y, 0, o.x, o.y, o.r*2.2);
          g.addColorStop(0, rgba(o.colA, 0.22*o.glow));
          g.addColorStop(0.4, rgba(o.colB, 0.10*o.glow));
          g.addColorStop(1, "rgba(0,0,0,0)");

          // glow wash
          ctx.beginPath();
          ctx.fillStyle = g;
          ctx.arc(o.x, o.y, o.r*2.2, 0, Math.PI*2);
          ctx.fill();

          // main shape
          const stroke = `rgba(210,240,255,${o.alpha})`;

          if(o.type === "orb"){
            const grad = ctx.createRadialGradient(o.x-o.r*0.25, o.y-o.r*0.25, o.r*0.2, o.x, o.y, o.r);
            grad.addColorStop(0, rgba(o.colA, 0.22));
            grad.addColorStop(0.6, rgba(o.colB, 0.12));
            grad.addColorStop(1, "rgba(0,0,0,0)");
            ctx.beginPath();
            ctx.fillStyle = grad;
            ctx.arc(o.x, o.y, o.r, 0, Math.PI*2);
            ctx.fill();

            ctx.beginPath();
            ctx.strokeStyle = stroke;
            ctx.lineWidth = 1.2;
            ctx.arc(o.x, o.y, o.r, 0, Math.PI*2);
            ctx.stroke();
          } else if(o.type === "diamond"){
            drawDiamond(o.x, o.y, o.r*0.75, o.rot, stroke);
          } else {
            drawHex(o.x, o.y, o.r*0.72, o.rot, stroke);
          }
        }

        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    /* =========================
       INIT
    ========================== */
    function init(){
      setupFX();

      els.msgInput.addEventListener("input", function(){
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      // sidebar
      els.hamburger.addEventListener("click", ()=> sidebarOpen(true));
      els.overlay.addEventListener("click", ()=> sidebarOpen(false));
      document.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          els.imgModal.classList.remove("active");
          sidebarOpen(false);
        }
      });

      // modal
      els.imgModal.addEventListener("click", ()=> els.imgModal.classList.remove("active"));

      // file
      els.attachBtn.addEventListener("click", ()=> els.fileInput.click());
      els.fileInput.addEventListener("change", handleFileSelect);
      els.fileRemove.addEventListener("click", clearFile);

      // send
      els.sendBtn.addEventListener("click", sendMessage);
      els.msgInput.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          sendMessage();
        }
      });

      els.msgInput.addEventListener("input", ()=>{
        if(!socket || !isConnected) return;
        if(typingTimeout) clearTimeout(typingTimeout);
        socket.emit("chat:typing", true);
        typingTimeout = setTimeout(()=> socket.emit("chat:typing", false), 900);
      });

      // profile
      els.meAvatar.addEventListener("click", ()=> openGate("edit"));
      els.btnEdit.addEventListener("click", ()=> openGate("edit"));
      els.btnLogout.addEventListener("click", doLogout);

      // gate
      els.gateGo.addEventListener("click", doGateSave);
      els.gateUsername.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doGateSave(); });
      els.gateReset.addEventListener("click", ()=>{
        localStorage.removeItem(KEY_USER);
        localStorage.removeItem(KEY_PHOTO);
        els.gateUsername.value = "";
        els.gatePhoto.value = "";
        els.photoLabel.textContent = "Upload foto profil (opsional)";
        alert("Data login dihapus. Silakan isi lagi.");
      });
      els.gatePhoto.addEventListener("change", ()=>{
        const f = els.gatePhoto.files && els.gatePhoto.files[0];
        if(!f) return;
        els.photoLabel.textContent = `Foto: ${f.name}`;
      });

      // music
      els.musicBtn.addEventListener("click", toggleMusic);
      installAudioUnlock();
      tryPlayMusic();

      // load profile
      const savedName = (localStorage.getItem(KEY_USER) || "").trim();
      const savedPhoto = (localStorage.getItem(KEY_PHOTO) || "").trim();
      myUser.photo = savedPhoto || null;

      if(isValidUsername(savedName)){
        myUser.username = savedName;
        applyProfileUI();
        setConn("connecting","CONNECTING");
        connectSocket();
      }else{
        myUser.username = null;
        applyProfileUI();
        enableInput(false);
        setConn("disconnected","LOGIN REQUIRED");
        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-user-lock"></i> Please login (username)`;
        openGate("login");
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
