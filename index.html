<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#070a12" />
  <title>LIVE CHAT</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#070a12;
      --card: rgba(16, 24, 38, .55);
      --card2: rgba(12, 18, 30, .78);
      --stroke: rgba(120, 190, 255, .18);
      --stroke2: rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted: rgba(234,242,255,.58);
      --muted2: rgba(234,242,255,.38);

      --good:#22c55e;
      --warn:#facc15;
      --bad:#fb7185;

      --fontH:'Orbitron',sans-serif;
      --fontB:'Share Tech Mono',monospace;

      --r12:12px;
      --r16:16px;
      --r20:20px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:var(--fontB); -webkit-tap-highlight-color:transparent; }
    html, body { height:100%; }
    body{
      background: radial-gradient(1200px 900px at 20% 0%, rgba(160,120,255,.10), transparent 55%),
                  radial-gradient(900px 900px at 80% 15%, rgba(0,255,255,.08), transparent 50%),
                  linear-gradient(180deg, #04050a, #070a12 45%, #04050a);
      color: var(--text);
      overflow:hidden;
    }

    /* ===== Animated background canvas (color shifting) ===== */
    .bg-wrap{ position:fixed; inset:0; z-index:-2; pointer-events:none; }
    canvas#fxCanvas{ width:100%; height:100%; display:block; filter: drop-shadow(0 0 10px rgba(125,211,252,.18)); }
    .glow{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(125,211,252,.12), transparent 70%),
        radial-gradient(800px 800px at 15% 80%, rgba(170,120,255,.10), transparent 60%),
        radial-gradient(700px 700px at 85% 85%, rgba(96,165,250,.10), transparent 55%);
      mix-blend-mode: screen;
      opacity:.9;
    }

    /* =========================
       âœ… SPLASH INTRO (ESTETIC)
       - loading text 3D slowmo
       - anime doll wave
       ========================= */
    .splash{
      position:fixed; inset:0;
      z-index:6000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(125,211,252,.15), transparent 70%),
        radial-gradient(800px 800px at 15% 80%, rgba(170,120,255,.12), transparent 60%),
        radial-gradient(700px 700px at 85% 85%, rgba(96,165,250,.12), transparent 55%),
        rgba(0,0,0,.78);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      overflow:hidden;
      user-select:none;
      pointer-events:auto;
    }
    .splash.hide{
      animation: splashOut .6s ease forwards;
      pointer-events:none;
    }
    @keyframes splashOut{
      to{ opacity:0; transform: scale(1.02); }
    }

    .splash-card{
      width:min(900px, 92vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(16,24,38,.78), rgba(10,15,24,.50));
      box-shadow: 0 30px 120px rgba(0,0,0,.65);
      overflow:hidden;
      position:relative;
      transform: translateY(10px) scale(.98);
      opacity:0;
      animation: splashIn .85s cubic-bezier(.2,.8,.2,1) forwards;
    }
    @keyframes splashIn{
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    .splash-card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        conic-gradient(from 180deg, rgba(125,211,252,.18), rgba(170,120,255,.16), rgba(96,165,250,.16), rgba(125,211,252,.18));
      filter: blur(18px);
      opacity:.7;
      animation: hueSplash 7s linear infinite;
      z-index:-1;
    }
    @keyframes hueSplash{
      0%{ filter:hue-rotate(0deg) blur(18px); }
      100%{ filter:hue-rotate(360deg) blur(18px); }
    }

    .splash-inner{
      display:flex;
      gap:18px;
      align-items:center;
      padding:18px 18px 16px;
    }
    .splash-left{
      flex:1;
      min-width:0;
      padding:10px 6px;
    }
    .splash-title{
      font-family:var(--fontH);
      letter-spacing:3px;
      text-transform:uppercase;
      font-size: clamp(16px, 2.6vw, 26px);
      line-height:1.25;
      margin-bottom:10px;

      /* 3D-ish text */
      color:#eaf2ff;
      text-shadow:
        0 1px 0 rgba(255,255,255,.25),
        0 2px 0 rgba(0,0,0,.25),
        0 10px 22px rgba(0,0,0,.45),
        0 0 18px rgba(125,211,252,.25);
      transform: perspective(900px) rotateX(10deg);
    }

    /* type / loading reveal */
    .type3d{
      display:inline-block;
      white-space:nowrap;
      overflow:hidden;
      border-right:2px solid rgba(234,242,255,.55);
      width:0ch;
      animation: typing 2.4s steps(24, end) .25s forwards, caret .9s steps(1) infinite;
    }
    @keyframes typing{
      to{ width:24ch; } /* "Welcome To Room Live Chat" = 24 */
    }
    @keyframes caret{
      50%{ border-right-color: transparent; }
    }

    .splash-sub{
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
      line-height:1.65;
      max-width: 52ch;
    }

    .splash-load{
      margin-top:14px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .splash-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: rgba(234,242,255,.88);
      font-family:var(--fontH);
      letter-spacing:2px;
      font-size:10px;
      text-transform:uppercase;
    }
    .loader3d{
      width:18px;height:18px;
      border-radius:6px;
      background: linear-gradient(135deg, rgba(125,211,252,.95), rgba(170,120,255,.78), rgba(96,165,250,.88));
      box-shadow:
        0 0 0 1px rgba(255,255,255,.12) inset,
        0 12px 24px rgba(0,0,0,.35),
        0 0 18px rgba(125,211,252,.25);
      transform-style:preserve-3d;
      animation: cube 1.25s ease-in-out infinite;
    }
    @keyframes cube{
      0%{ transform: perspective(500px) rotateX(10deg) rotateY(0deg) translateZ(0); }
      50%{ transform: perspective(500px) rotateX(28deg) rotateY(180deg) translateZ(2px); }
      100%{ transform: perspective(500px) rotateX(10deg) rotateY(360deg) translateZ(0); }
    }

    .splash-right{
      width:min(300px, 38vw);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 6px;
    }
    .mascot{
      width:min(260px, 34vw);
      aspect-ratio: 1/1;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(160px 160px at 35% 30%, rgba(125,211,252,.16), transparent 70%),
        radial-gradient(180px 180px at 70% 70%, rgba(170,120,255,.14), transparent 70%),
        rgba(0,0,0,.18);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .mascot:after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, transparent, rgba(125,211,252,.20), transparent, rgba(170,120,255,.18), transparent);
      animation: spinGlow 6s linear infinite;
      opacity:.8;
      filter: blur(12px);
    }
    @keyframes spinGlow{ to{ transform: rotate(360deg); } }

    /* SVG wave animation hooks */
    .mascot svg{
      width:84%;
      height:auto;
      position:relative;
      z-index:1;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
      transform: translateY(6px);
      animation: floaty 2.4s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(6px); }
      50%{ transform: translateY(-2px); }
    }
    .wave-arm{
      transform-origin: 78% 54%;
      animation: wave 1.1s ease-in-out infinite;
    }
    @keyframes wave{
      0%{ transform: rotate(10deg); }
      50%{ transform: rotate(-22deg); }
      100%{ transform: rotate(10deg); }
    }

    .spark{
      position:absolute;
      width:6px;height:6px;border-radius:999px;
      background: rgba(234,242,255,.85);
      box-shadow: 0 0 16px rgba(125,211,252,.35);
      opacity:.0;
      animation: spark 1.6s ease-in-out infinite;
      z-index:2;
    }
    .spark.s1{ left:18%; top:22%; animation-delay:.0s; }
    .spark.s2{ left:76%; top:26%; animation-delay:.4s; }
    .spark.s3{ left:64%; top:74%; animation-delay:.8s; }
    @keyframes spark{
      0%{ transform: translateY(6px) scale(.6); opacity:0; }
      35%{ opacity:.9; }
      60%{ opacity:.25; }
      100%{ transform: translateY(-10px) scale(1.25); opacity:0; }
    }

    @media (max-width: 820px){
      .splash-inner{ flex-direction:column; text-align:center; }
      .splash-sub{ margin-left:auto; margin-right:auto; }
      .splash-load{ justify-content:center; }
      .splash-right{ width:100%; }
      .mascot{ width:min(280px, 72vw); }
      .splash-title{ transform: perspective(900px) rotateX(8deg); }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.16); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,.25); }

    .app{
      height:100dvh;
      width:100%;
      max-width:1600px;
      margin:0 auto;
      display:flex;
      position:relative;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:300px;
      flex-shrink:0;
      border-right:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,15,24,.68), rgba(10,15,24,.35));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      z-index:50;
      transition: transform .28s cubic-bezier(.4,0,.2,1);
    }

    .user-card{
      padding:20px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,24,38,.75), rgba(10,15,24,.25));
    }
    .profile-top{ display:flex; align-items:center; gap:12px; }
    .avatar{
      width:64px; height:64px;
      border-radius:18px;
      border:1px solid rgba(125,211,252,.35);
      background: rgba(0,0,0,.35);
      box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,.06) inset;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      position:relative;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:none; }
    .avatar .initials{
      font-family:var(--fontH);
      font-weight:700;
      letter-spacing:1px;
      color:#eaf2ff;
      font-size:20px;
      opacity:.95;
      text-transform:uppercase;
    }

    .me-info{ min-width:0; flex:1; }
    .me-name{
      font-family:var(--fontH);
      font-size:15px;
      letter-spacing:1px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-transform:uppercase;
    }
    .me-bio{
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .me-sub{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      user-select:none;
    }
    .status-dot{
      width:7px; height:7px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 12px rgba(250,204,21,.35);
    }
    .status-dot.connected{ background: var(--good); box-shadow: 0 0 12px rgba(34,197,94,.35); }
    .status-dot.disconnected{ background: var(--bad); box-shadow: 0 0 12px rgba(251,113,133,.35); }

    .card-actions{ margin-top:14px; display:flex; gap:10px; }
    .btn{
      flex:1;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(0,0,0,.25));
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .btn:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(125,211,252,.16), rgba(170,120,255,.14), rgba(96,165,250,.14));
      opacity:.55;
      filter: blur(10px);
      z-index:-1;
      animation: hue 6s linear infinite;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.25); filter: brightness(1.06); }
    .btn.danger{ border-color: rgba(251,113,133,.25); }
    .btn.danger:hover{ border-color: rgba(251,113,133,.45); }

    @keyframes hue { 0%{ filter:hue-rotate(0deg) blur(10px); } 100%{ filter:hue-rotate(360deg) blur(10px); } }

    /* Under hamburger: online count then music */
    .mini-panel{
      padding:14px 20px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      flex-direction:column;
      gap:10px;
      background: linear-gradient(180deg, rgba(12,18,30,.35), rgba(12,18,30,.12));
    }
    .mini-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .mini-title{
      font-family:var(--fontH);
      letter-spacing:2px;
      font-size:10px;
      color: var(--muted);
      text-transform:uppercase;
      display:flex; align-items:center; gap:8px;
    }
    .mini-value{
      font-family:var(--fontH);
      letter-spacing:2px;
      font-size:10px;
      color: var(--text);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      min-width:52px;
      text-align:center;
    }

    .music-btn{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(135deg, rgba(125,211,252,.12), rgba(170,120,255,.10), rgba(96,165,250,.10));
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:10px;
      user-select:none;
      position:relative;
      overflow:hidden;
      animation: hueBtn 7s linear infinite;
    }
    @keyframes hueBtn { 0%{ filter:hue-rotate(0deg); } 100%{ filter:hue-rotate(360deg); } }
    .music-btn:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.25); filter: brightness(1.06); }
    .music-state-dot{ width:8px; height:8px; border-radius:50%; background: rgba(234,242,255,.25); box-shadow: 0 0 14px rgba(125,211,252,.20); }
    .music-on .music-state-dot{ background: var(--good); box-shadow: 0 0 14px rgba(34,197,94,.35); }

    .online-users{ flex:1; overflow:hidden; display:flex; flex-direction:column; min-height:0; }
    .section-header{
      padding:14px 20px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--muted);
    }
    .users-list{ flex:1; overflow:auto; padding:10px; min-height:0; }

    .user-item{
      display:flex; align-items:center; gap:12px;
      padding:10px;
      border-radius:14px;
      border:1px solid transparent;
      background: rgba(0,0,0,.10);
      margin-bottom:8px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .15s ease;
      position:relative;
    }
    .user-item:hover{ transform: translateY(-1px); background: rgba(0,0,0,.18); border-color: rgba(125,211,252,.14); }
    .u-ava{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden; flex-shrink:0;
      position:relative;
    }
    .u-ava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .u-ava .u-in{ font-family:var(--fontH); font-size:11px; letter-spacing:2px; color:var(--text); text-transform:uppercase; }
    .u-info{ min-width:0; flex:1; }
    .u-name{ font-size:13px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-transform:capitalize; }
    .u-bio{ font-size:11px; color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:3px; }
    .u-meta{ display:flex; align-items:center; gap:8px; margin-top:6px; color:var(--muted2); font-size:10px; letter-spacing:1px; text-transform:uppercase; }
    .u-dot{ width:8px;height:8px;border-radius:50%; background: var(--bad); box-shadow: 0 0 12px rgba(251,113,133,.25); }
    .u-dot.on{ background: var(--good); box-shadow: 0 0 12px rgba(34,197,94,.25); }
    .u-unread{
      position:absolute; right:10px; top:12px;
      background: linear-gradient(135deg, rgba(251,113,133,.9), rgba(170,120,255,.8));
      border:1px solid rgba(255,255,255,.12);
      color:#07101e;
      font-family:var(--fontH);
      font-weight:900;
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      display:none;
    }
    .u-unread.on{ display:block; }

    /* ===== Chat area ===== */
    .chat{ flex:1; display:flex; flex-direction:column; min-width:0; position:relative; }

    /* TOP HEADER (FIX RAPiH, GA NUBRUK) */
    .chat-header{
      height:64px;
      flex-shrink:0;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,24,38,.62), rgba(10,15,24,.22));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      padding:0 14px;
      gap:10px;
      z-index:10;
    }
    .left-head{ display:flex; align-items:center; gap:12px; min-width:0; flex:1; }
    .hamburger{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      flex-shrink:0;
    }
    .hamburger:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.22); }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand h1{
      font-family:var(--fontH);
      font-size:16px;
      letter-spacing:3px;
      text-transform:uppercase;
      white-space:nowrap;
    }

    /* RIGHT: CONNECT + SIGNAL/PING (rapih, tidak gabung) */
    .right-head{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
      min-width:0;
    }
    .conn-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-family:var(--fontH);
      letter-spacing:2px;
      font-size:10px;
      text-transform:uppercase;
      color: rgba(234,242,255,.92);
      white-space:nowrap;
    }
    .conn-pill.ok{ border-color: rgba(34,197,94,.25); color: rgba(34,197,94,.95); }
    .conn-pill.bad{ border-color: rgba(251,113,133,.25); color: rgba(251,113,133,.95); }
    .conn-pill.wait{ border-color: rgba(250,204,21,.25); color: rgba(250,204,21,.95); }

    .sig-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
      min-width: 112px;
      justify-content:space-between;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .bars{ display:flex; align-items:flex-end; gap:3px; }
    .bar{ width:4px; border-radius:3px; background: rgba(234,242,255,.28); transition: background .2s ease, opacity .2s ease; }
    .bar:nth-child(1){ height:8px; }
    .bar:nth-child(2){ height:12px; }
    .bar:nth-child(3){ height:16px; }
    .bar:nth-child(4){ height:20px; }
    .bars.l1 .bar:nth-child(2),
    .bars.l1 .bar:nth-child(3),
    .bars.l1 .bar:nth-child(4){ opacity:.25; }
    .bars.l2 .bar:nth-child(3),
    .bars.l2 .bar:nth-child(4){ opacity:.25; }
    .bars.l3 .bar:nth-child(4){ opacity:.25; }
    .bars.l4 .bar{ opacity:1; }

    .ms{
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      color: var(--muted);
      text-transform:uppercase;
      transition: color .2s ease;
    }

    /* âœ… Ping color states (merah/kuning/hijau) */
    .sig-pill.bad{ border-color: rgba(251,113,133,.30); box-shadow: 0 0 0 1px rgba(251,113,133,.08) inset; }
    .sig-pill.warn{ border-color: rgba(250,204,21,.30); box-shadow: 0 0 0 1px rgba(250,204,21,.08) inset; }
    .sig-pill.good{ border-color: rgba(34,197,94,.30); box-shadow: 0 0 0 1px rgba(34,197,94,.08) inset; }

    .sig-pill.bad .bar{ background: rgba(251,113,133,.62); }
    .sig-pill.warn .bar{ background: rgba(250,204,21,.62); }
    .sig-pill.good .bar{ background: rgba(34,197,94,.62); }

    .sig-pill.bad .ms{ color: rgba(251,113,133,.92); }
    .sig-pill.warn .ms{ color: rgba(250,204,21,.92); }
    .sig-pill.good .ms{ color: rgba(34,197,94,.92); }

    /* DM header (WA-like) */
    .dm-header{
      display:none;
      height:54px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(16,24,38,.62), rgba(10,15,24,.18));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:0 12px;
      align-items:center;
      gap:10px;
      z-index:11;
    }
    .dm-header.on{ display:flex; }
    .dm-back{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      flex-shrink:0;
    }
    .dm-center{ flex:1; min-width:0; text-align:center; }
    .dm-name{
      font-family:var(--fontH);
      font-size:12px;
      letter-spacing:2px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dm-sub{
      margin-top:3px;
      font-size:11px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dm-ava{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;
    }
    .dm-ava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .dm-ava .dm-in{ font-family:var(--fontH); font-size:11px; letter-spacing:2px; text-transform:uppercase; }

    .messages{
      flex:1; min-height:0;
      overflow:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .sys{
      align-self:center;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:center;
      max-width:92%;
    }

    .msg{ display:flex; gap:10px; max-width:86%; animation: pop .18s ease; }
    .msg.own{ align-self:flex-end; flex-direction:row-reverse; }
    .msg.other{ align-self:flex-start; }

    @keyframes pop{ from{ transform: translateY(6px); opacity:0; } to{ transform: translateY(0); opacity:1; } }

    .m-ava{
      width:36px;height:36px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;
      cursor:pointer; /* âœ… click open profile */
    }
    .m-ava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .m-ava .m-in{ font-family:var(--fontH); font-size:10px; letter-spacing:2px; text-transform:uppercase; }

    .bubble{
      border-radius: 18px;
      padding:12px 14px;
      line-height:1.5;
      font-size:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
      min-width: 120px;
    }
    .msg.own .bubble{
      background: linear-gradient(135deg, rgba(125,211,252,.14), rgba(170,120,255,.12), rgba(96,165,250,.12));
      border-color: rgba(125,211,252,.18);
      animation: hueBtn 7s linear infinite;
    }
    .bubble .time{
      margin-top:8px;
      font-size:10px;
      color: var(--muted2);
      letter-spacing:1px;
      text-transform:uppercase;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      align-items:center;
    }

    /* âœ… Reply button (mobile friendly, no dblclick needed) */
    .rbtn{
      border:none;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(234,242,255,.78);
      padding:4px 8px;
      border-radius:999px;
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2px;
      font-size:9px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      transition: filter .15s ease, border-color .15s ease, transform .15s ease;
    }
    .rbtn:hover{ filter:brightness(1.08); border-color: rgba(125,211,252,.18); transform: translateY(-1px); }

    .bubble img{
      max-width:100%;
      display:block;
      margin-top:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }
    .reply-card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 10px;
      margin-bottom:10px;
    }
    .reply-card .rt{
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      color: var(--muted);
      text-transform:uppercase;
      margin-bottom:6px;
    }
    .reply-card .rc{ font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Input */
    .input{
      flex-shrink:0;
      border-top:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,15,24,.20), rgba(16,24,38,.55));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:12px 14px;
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .input .wrap{ flex:1; min-width:0; display:flex; flex-direction:column; gap:8px; }

    .file-preview{
      display:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size:12px;
      align-items:center;
      gap:10px;
    }
    .file-preview.active{ display:flex; }

    .reply-preview{
      display:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(125,211,252,.16);
      background: linear-gradient(135deg, rgba(125,211,252,.08), rgba(170,120,255,.07), rgba(96,165,250,.07));
      color: var(--muted);
      font-size:12px;
      align-items:center;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .reply-preview.active{ display:flex; }
    .reply-preview .x{ margin-left:auto; cursor:pointer; opacity:.85; }

    textarea{
      width:100%;
      min-height:52px;
      max-height:120px;
      resize:none;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      color: var(--text);
      outline:none;
      font-size:14px;
      transition: border-color .15s ease, background .15s ease;
    }
    textarea:focus{ border-color: rgba(125,211,252,.22); background: rgba(0,0,0,.34); }

    .btns{ display:flex; gap:10px; flex-shrink:0; }
    .icon{
      width:52px;height:52px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      position:relative;
      overflow:hidden;
    }
    .icon:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.18); filter: brightness(1.06); }
    .send{
      background: linear-gradient(135deg, rgba(125,211,252,.55), rgba(170,120,255,.45), rgba(96,165,250,.50));
      border-color: rgba(125,211,252,.22);
      color:#061020;
      font-weight:900;
      animation: hueBtn 7s linear infinite;
    }
    .icon:disabled, .send:disabled, textarea:disabled{ opacity:.45; cursor:not-allowed; }

    /* Typing */
    .typing{
      height:18px;
      padding:0 16px 10px;
      color: var(--muted2);
      font-size:11px;
      display:none;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .typing .dots span{
      width:4px;height:4px;border-radius:999px;
      background: rgba(234,242,255,.45);
      display:inline-block;
      animation: bounce 1.2s infinite;
      margin-right:3px;
    }
    .typing .dots span:nth-child(2){ animation-delay:.15s; }
    .typing .dots span:nth-child(3){ animation-delay:.3s; }
    @keyframes bounce{ 0%,80%,100%{ transform: scale(.2); opacity:.4; } 40%{ transform: scale(1); opacity:1; } }

    /* Modals */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      z-index:40;
    }
    .overlay.active{ display:block; }

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:18px;
    }
    .modal.active{ display:flex; }
    .modal img{
      max-width:95%;
      max-height:90vh;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
    }

    /* Login gate */
    .gate{
      position:fixed; inset:0;
      z-index:3000;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .gate.active{ display:flex; }
    .gate-card{
      width:100%;
      max-width:560px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(16,24,38,.78), rgba(10,15,24,.55));
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }
    .gate-card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(900px 300px at 10% 0%, rgba(125,211,252,.18), transparent 55%),
                  radial-gradient(700px 300px at 90% 20%, rgba(170,120,255,.16), transparent 55%),
                  radial-gradient(700px 400px at 50% 110%, rgba(96,165,250,.16), transparent 55%);
      animation: hue 8s linear infinite;
      opacity:.9;
      z-index:-1;
      filter: blur(14px);
    }
    .gate-head{
      padding:18px 18px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .gate-title{
      font-family:var(--fontH);
      letter-spacing:3px;
      text-transform:uppercase;
      font-size:14px;
    }
    .gate-sub{
      padding:0 18px 14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .gate-body{ padding:16px 18px 18px; display:flex; flex-direction:column; gap:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .field{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    .field:focus{ border-color: rgba(125,211,252,.22); }
    .upload{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .gate-footer{ padding:14px 18px 18px; display:flex; gap:10px; }
    .primary{
      flex:1;
      padding:12px 12px;
      border-radius:16px;
      border:none;
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:3px;
      text-transform:uppercase;
      font-size:12px;
      background: linear-gradient(135deg, rgba(125,211,252,.85), rgba(170,120,255,.70), rgba(96,165,250,.80));
      color:#061020;
      font-weight:900;
      animation: hueBtn 7s linear infinite;
    }
    .secondary{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--text);
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:3px;
      text-transform:uppercase;
      font-size:12px;
    }
    .hint{ padding:0 18px 16px; color: var(--muted2); font-size:11px; }

    /* Public profile modal */
    .pmodal{
      position:fixed; inset:0;
      z-index:2600;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.70);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .pmodal.active{ display:flex; }
    .pcard{
      width:100%;
      max-width:560px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(16,24,38,.75), rgba(10,15,24,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .pcard:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(125,211,252,.14), rgba(170,120,255,.14), rgba(96,165,250,.14));
      opacity:.55;
      filter: blur(12px);
      z-index:-1;
      animation: hue 7s linear infinite;
    }
    .phead{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between;
    }
    .ptitle{
      font-family:var(--fontH);
      letter-spacing:3px;
      text-transform:uppercase;
      font-size:13px;
      color: var(--text);
    }
    .px{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--text);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .pbody{ padding:14px 16px 16px; display:flex; gap:14px; align-items:center; }
    .pava{
      width:74px;height:74px;border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;
    }
    .pava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .pava .pin{ font-family:var(--fontH); letter-spacing:2px; text-transform:uppercase; }
    .pinfo{ flex:1; min-width:0; }
    .pname{
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pbio{
      margin-top:6px;
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pmeta{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .pstat{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--muted);
    }
    .pdot{ width:8px;height:8px;border-radius:50%; background: var(--bad); box-shadow: 0 0 12px rgba(251,113,133,.25); }
    .pdot.on{ background: var(--good); box-shadow: 0 0 12px rgba(34,197,94,.25); }

    .pfoot{
      padding:14px 16px 16px;
      display:flex; gap:10px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .pbtn{
      flex:1;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:3px;
      text-transform:uppercase;
      font-size:11px;
      display:flex;align-items:center;justify-content:center;gap:10px;
      position:relative;
      overflow:hidden;
      animation: hueBtn 7s linear infinite;
    }
    .pbtn:hover{ filter: brightness(1.06); border-color: rgba(125,211,252,.18); }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:86px;
      transform:translateX(-50%);
      z-index:5000;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      display:none;
      max-width: min(520px, 92vw);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .toast.on{ display:block; animation: pop .18s ease; }
    .toast .t1{ font-family:var(--fontH); letter-spacing:2px; text-transform:uppercase; font-size:11px; color: var(--muted); }
    .toast .t2{ margin-top:6px; font-size:13px; color: var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Mobile sidebar */
    @media (max-width: 900px){
      .sidebar{
        position:fixed;
        top:0; bottom:0; left:0;
        transform: translateX(-105%);
        width:290px;
        box-shadow: 18px 0 60px rgba(0,0,0,.55);
      }
      .sidebar.active{ transform: translateX(0); }
      .sig-pill{ min-width: 102px; }
    }
    @media (max-width: 520px){
      .conn-pill{ display:none; } /* biar makin rapih di layar kecil */
      .sig-pill{ min-width: 106px; }
    }
  </style>
</head>

<body>
  <div class="bg-wrap"><canvas id="fxCanvas"></canvas></div>
  <div class="glow"></div>

  <!-- âœ… SPLASH INTRO -->
  <div class="splash" id="splash">
    <div class="splash-card">
      <div class="splash-inner">
        <div class="splash-left">
          <div class="splash-title">
            <span class="type3d">Welcome To Room Live Chat</span>
          </div>
          <div class="splash-sub">
            Menghubungkan server, menyiapkan profile, dan sinkron userâ€¦ <br/>
            <span style="opacity:.8">Halo ðŸ‘‹ (anime doll nyapa dulu biar premium)</span>
          </div>
          <div class="splash-load">
            <span class="splash-pill"><span class="loader3d"></span> LOADING</span>
            <span class="splash-pill"><i class="fa-solid fa-sparkles"></i> 3D SLOWMO TEXT</span>
            <span class="splash-pill"><i class="fa-solid fa-wand-magic-sparkles"></i> PREMIUM INTRO</span>
          </div>
        </div>

        <div class="splash-right">
          <div class="mascot" aria-label="anime mascot waving">
            <span class="spark s1"></span><span class="spark s2"></span><span class="spark s3"></span>
            <!-- simple anime-like SVG -->
            <svg viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="gHair" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="rgba(170,120,255,.9)"/>
                  <stop offset="1" stop-color="rgba(125,211,252,.9)"/>
                </linearGradient>
                <linearGradient id="gSkin" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="rgba(255,232,220,.95)"/>
                  <stop offset="1" stop-color="rgba(255,210,200,.95)"/>
                </linearGradient>
              </defs>

              <!-- shadow -->
              <ellipse cx="160" cy="286" rx="92" ry="18" fill="rgba(0,0,0,.30)"/>

              <!-- body -->
              <g>
                <path d="M110 250c8-42 32-62 50-62s42 20 50 62c2 10-6 18-16 18H126c-10 0-18-8-16-18z"
                      fill="rgba(125,211,252,.18)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
                <path d="M124 236c6-26 22-40 36-40s30 14 36 40" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="2"/>
              </g>

              <!-- head -->
              <g>
                <circle cx="160" cy="150" r="78" fill="url(#gSkin)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
                <!-- cheeks -->
                <ellipse cx="118" cy="170" rx="14" ry="10" fill="rgba(251,113,133,.25)"/>
                <ellipse cx="202" cy="170" rx="14" ry="10" fill="rgba(251,113,133,.25)"/>
              </g>

              <!-- hair -->
              <g>
                <path d="M82 154c8-62 44-98 78-98s70 36 78 98c-10-12-22-20-32-22-16-3-28 10-46 10s-30-13-46-10c-10 2-22 10-32 22z"
                      fill="url(#gHair)" opacity=".95" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
                <path d="M98 118c18-30 40-46 62-46s44 16 62 46" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="2" opacity=".8"/>
              </g>

              <!-- eyes -->
              <g>
                <ellipse cx="130" cy="150" rx="18" ry="22" fill="rgba(6,16,32,.92)"/>
                <ellipse cx="190" cy="150" rx="18" ry="22" fill="rgba(6,16,32,.92)"/>
                <circle cx="124" cy="142" r="6" fill="rgba(234,242,255,.90)"/>
                <circle cx="184" cy="142" r="6" fill="rgba(234,242,255,.90)"/>
                <path d="M118 176c10 8 22 8 32 0" fill="none" stroke="rgba(6,16,32,.55)" stroke-width="3" stroke-linecap="round"/>
                <path d="M178 176c10 8 22 8 32 0" fill="none" stroke="rgba(6,16,32,.55)" stroke-width="3" stroke-linecap="round"/>
              </g>

              <!-- mouth -->
              <path d="M146 194c6 8 22 8 28 0" fill="none" stroke="rgba(6,16,32,.55)" stroke-width="3" stroke-linecap="round"/>

              <!-- waving arm (right) -->
              <g class="wave-arm">
                <path d="M224 224c18-16 34-22 46-14 10 6 9 20-4 34-10 12-26 20-44 26"
                      fill="none" stroke="rgba(255,232,220,.92)" stroke-width="18" stroke-linecap="round"/>
                <path d="M254 202c10 2 18 8 20 16" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="3" stroke-linecap="round"/>
                <circle cx="270" cy="222" r="12" fill="url(#gSkin)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>
              </g>

              <!-- left arm -->
              <path d="M96 234c-18-12-26-26-22-36 4-10 18-10 34 2 10 8 18 20 24 32"
                    fill="none" stroke="rgba(255,232,220,.92)" stroke-width="18" stroke-linecap="round"/>

              <!-- little hello bubble -->
              <g opacity=".9">
                <path d="M208 88c30 0 54 18 54 40s-24 40-54 40c-6 0-12-1-18-2l-18 14 6-18c-14-8-24-20-24-34 0-22 24-40 54-40z"
                      fill="rgba(0,0,0,.22)" stroke="rgba(255,255,255,.12)" stroke-width="2"/>
                <text x="208" y="133" text-anchor="middle" font-family="Orbitron, sans-serif" font-size="16" fill="rgba(234,242,255,.92)" letter-spacing="2">HALO</text>
              </g>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="t1" id="toastTitle">INFO</div>
    <div class="t2" id="toastMsg">...</div>
  </div>

  <!-- LOGIN / PROFILE GATE -->
  <div class="gate" id="gate">
    <div class="gate-card">
      <div class="gate-head">
        <div class="gate-title" id="gateTitle">LOGIN</div>
        <span class="pill"><span class="status-dot disconnected"></span><strong>PROFILE</strong></span>
      </div>
      <div class="gate-sub" id="gateSub">
        Masukin <b>nama</b> (min 3 karakter), <b>bio</b>, dan (opsional) <b>foto profil</b>.
      </div>
      <div class="gate-body">
        <div class="row">
          <input id="gateName" class="field" placeholder="Nama (min 3 karakter) bebas spasi/simbol" autocomplete="off"/>
        </div>
        <div class="row">
          <input id="gateBio" class="field" maxlength="180" placeholder="Bio (opsional) contoh: jangan lupa follow ðŸ˜¼" autocomplete="off"/>
        </div>
        <div class="row">
          <label class="upload" for="gatePhoto"><i class="fa-solid fa-image"></i><span id="photoLabel">Upload foto profil (opsional)</span></label>
          <input id="gatePhoto" type="file" accept="image/*" style="display:none"/>
        </div>
      </div>
      <div class="gate-footer">
        <button class="primary" id="gateGo">MASUK</button>
        <button class="secondary" id="gateReset" title="hapus data login">RESET</button>
      </div>
      <div class="hint">
        Autoplay musik bisa diblokir browser. Kalau tidak bunyi, tekan tombol MUSIC.
      </div>
    </div>
  </div>

  <!-- Mobile overlay -->
  <div class="overlay" id="overlay"></div>

  <!-- Image modal -->
  <div class="modal" id="imgModal">
    <img id="imgModalEl" alt="preview"/>
  </div>

  <!-- Public Profile Modal -->
  <div class="pmodal" id="pmodal">
    <div class="pcard">
      <div class="phead">
        <div class="ptitle">PUBLIC PROFILE</div>
        <button class="px" id="pclose"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="pbody">
        <div class="pava" id="pava">
          <img id="pavaImg" alt="p"/>
          <div class="pin" id="pavaIn">--</div>
        </div>
        <div class="pinfo">
          <div class="pname" id="pname">---</div>
          <div class="pbio" id="pbio">---</div>
          <div class="pmeta">
            <div class="pstat"><span class="pdot" id="pdot"></span><span id="pstatus">OFFLINE</span></div>
          </div>
        </div>
      </div>
      <div class="pfoot">
        <button class="pbtn" id="pdm"><i class="fa-solid fa-lock"></i> DM</button>
        <button class="pbtn" id="pview"><i class="fa-solid fa-eye"></i> VIEW</button>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="profile-top">
          <div class="avatar" id="meAvatar" role="button" tabindex="0" title="Edit profile">
            <img id="meAvatarImg" alt="me"/>
            <div class="initials" id="meInitials">ME</div>
          </div>
          <div class="me-info">
            <div class="me-name" id="meName">Loading...</div>
            <div class="me-bio" id="meBio">...</div>
            <div class="me-sub">
              <span class="pill"><span class="status-dot" id="connDot"></span><strong id="connText">CONNECTING</strong></span>
            </div>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn" id="btnEdit"><i class="fa-solid fa-pen-to-square"></i> EDIT</button>
          <button class="btn danger" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> LOGOUT</button>
        </div>
      </div>

      <div class="mini-panel">
        <div class="mini-row">
          <div class="mini-title"><i class="fa-solid fa-users"></i> ONLINE</div>
          <div class="mini-value" id="onlineCount">0</div>
        </div>

        <button class="music-btn" id="musicBtn">
          <span class="music-state-dot" id="musicDot"></span>
          <span id="musicText">MUSIC OFF</span>
        </button>
      </div>

      <div class="online-users">
        <div class="section-header">
          <span>USERS (HISTORY)</span>
          <span id="usersCount">0</span>
        </div>
        <div class="users-list" id="userList"></div>
      </div>
    </aside>

    <!-- CHAT -->
    <main class="chat">
      <!-- PUBLIC HEADER -->
      <header class="chat-header" id="publicHeader">
        <div class="left-head">
          <button class="hamburger" id="hamburger" aria-label="menu"><i class="fa-solid fa-bars"></i></button>
          <div class="brand"><h1>LIVE CHAT</h1></div>
        </div>
        <div class="right-head">
          <div class="conn-pill wait" id="connPill"><i class="fa-solid fa-spinner fa-spin"></i> CONNECTING</div>
          <div class="sig-pill" id="sigPill" title="Ping">
            <div class="bars l1" id="bars">
              <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
            <div class="ms" id="pingText">-- MS</div>
          </div>
        </div>
      </header>

      <!-- DM HEADER -->
      <header class="dm-header" id="dmHeader">
        <button class="dm-back" id="dmBack" aria-label="back"><i class="fa-solid fa-chevron-left"></i></button>
        <div class="dm-center">
          <div class="dm-name" id="dmName">---</div>
          <div class="dm-sub" id="dmSub">---</div>
        </div>
        <div class="dm-ava" id="dmAva">
          <img id="dmAvaImg" alt="dm"/>
          <div class="dm-in" id="dmAvaIn">--</div>
        </div>
      </header>

      <section class="messages" id="messages">
        <div class="sys" id="welcome">
          <i class="fa-solid fa-circle-notch fa-spin"></i> Waiting for login...
        </div>
      </section>

      <div class="typing" id="typing">
        <div class="dots"><span></span><span></span><span></span></div>
        <div id="typingText">Someone is typing...</div>
      </div>

      <footer class="input">
        <div class="wrap">
          <div class="reply-preview" id="replyPreview">
            <i class="fa-solid fa-reply"></i>
            <div style="min-width:0;flex:1">
              <div style="font-family:var(--fontH);font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px" id="replyToName">REPLY</div>
              <div style="font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="replyToText">...</div>
            </div>
            <i class="fa-solid fa-xmark x" id="replyRemove"></i>
          </div>

          <div class="file-preview" id="filePreview">
            <i class="fa-solid fa-paperclip"></i>
            <span id="fileName" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;">file</span>
            <i class="fa-solid fa-xmark" style="cursor:pointer;opacity:.85" id="fileRemove"></i>
          </div>

          <textarea id="msgInput" placeholder="Type message..." disabled></textarea>
        </div>

        <!-- âœ… accept image + video -->
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none"/>
        <div class="btns">
          <button class="icon" id="attachBtn" disabled title="Image/Video"><i class="fa-solid fa-paperclip"></i></button>
          <button class="icon" id="micBtn" disabled title="Record voice"><i class="fa-solid fa-microphone"></i></button>
          <button class="icon send" id="sendBtn" disabled title="Send"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </footer>
    </main>
  </div>

  <!-- Audio -->
  <audio id="bgm" preload="auto" loop>
    <source src="https://files.catbox.moe/wlny2m.mp3" type="audio/mpeg"/>
  </audio>

  <!-- SOCKET URL -->
  <script>
    // ganti ini sesuai backend kamu:
    window.SOCKET_URL = "http://panelkeknyahmm.alxzy.my.id:6008";
  </script>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
    /* ============================================================
       STORAGE KEYS
    ============================================================ */
    const KEY_NAME  = "lc_name";
    const KEY_BIO   = "lc_bio";
    const KEY_PHOTO = "lc_photo";

    /* ============================================================
       ELEMENTS
    ============================================================ */
    const el = {
      fxCanvas: document.getElementById("fxCanvas"),

      splash: document.getElementById("splash"),

      toast: document.getElementById("toast"),
      toastTitle: document.getElementById("toastTitle"),
      toastMsg: document.getElementById("toastMsg"),

      gate: document.getElementById("gate"),
      gateTitle: document.getElementById("gateTitle"),
      gateSub: document.getElementById("gateSub"),
      gateName: document.getElementById("gateName"),
      gateBio: document.getElementById("gateBio"),
      gatePhoto: document.getElementById("gatePhoto"),
      photoLabel: document.getElementById("photoLabel"),
      gateGo: document.getElementById("gateGo"),
      gateReset: document.getElementById("gateReset"),

      sidebar: document.getElementById("sidebar"),
      overlay: document.getElementById("overlay"),
      hamburger: document.getElementById("hamburger"),

      meAvatar: document.getElementById("meAvatar"),
      meAvatarImg: document.getElementById("meAvatarImg"),
      meInitials: document.getElementById("meInitials"),
      meName: document.getElementById("meName"),
      meBio: document.getElementById("meBio"),
      btnEdit: document.getElementById("btnEdit"),
      btnLogout: document.getElementById("btnLogout"),

      onlineCount: document.getElementById("onlineCount"),
      usersCount: document.getElementById("usersCount"),
      userList: document.getElementById("userList"),

      connDot: document.getElementById("connDot"),
      connText: document.getElementById("connText"),
      connPill: document.getElementById("connPill"),
      sigPill: document.getElementById("sigPill"),
      bars: document.getElementById("bars"),
      pingText: document.getElementById("pingText"),

      publicHeader: document.getElementById("publicHeader"),
      dmHeader: document.getElementById("dmHeader"),
      dmBack: document.getElementById("dmBack"),
      dmName: document.getElementById("dmName"),
      dmSub: document.getElementById("dmSub"),
      dmAva: document.getElementById("dmAva"),
      dmAvaImg: document.getElementById("dmAvaImg"),
      dmAvaIn: document.getElementById("dmAvaIn"),

      messages: document.getElementById("messages"),
      welcome: document.getElementById("welcome"),
      typing: document.getElementById("typing"),
      typingText: document.getElementById("typingText"),

      msgInput: document.getElementById("msgInput"),
      sendBtn: document.getElementById("sendBtn"),
      attachBtn: document.getElementById("attachBtn"),
      micBtn: document.getElementById("micBtn"),
      fileInput: document.getElementById("fileInput"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      fileRemove: document.getElementById("fileRemove"),

      replyPreview: document.getElementById("replyPreview"),
      replyToName: document.getElementById("replyToName"),
      replyToText: document.getElementById("replyToText"),
      replyRemove: document.getElementById("replyRemove"),

      imgModal: document.getElementById("imgModal"),
      imgModalEl: document.getElementById("imgModalEl"),

      musicBtn: document.getElementById("musicBtn"),
      musicText: document.getElementById("musicText"),
      musicDot: document.getElementById("musicDot"),
      bgm: document.getElementById("bgm"),

      pmodal: document.getElementById("pmodal"),
      pclose: document.getElementById("pclose"),
      pava: document.getElementById("pava"),
      pavaImg: document.getElementById("pavaImg"),
      pavaIn: document.getElementById("pavaIn"),
      pname: document.getElementById("pname"),
      pbio: document.getElementById("pbio"),
      pdot: document.getElementById("pdot"),
      pstatus: document.getElementById("pstatus"),
      pdm: document.getElementById("pdm"),
      pview: document.getElementById("pview"),
    };

    /* ============================================================
       STATE
    ============================================================ */
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;

    const me = { name:null, bio:"", photo:null };

    let socket = null;
    let connected = false;

    let musicOn = false;

    // users history (online/offline)
    const usersMap = new Map(); // name -> {name,bio,photo,online,lastSeen,unreadDM}
    let profUser = null;        // currently opened profile modal

    // chat mode
    let chatMode = "public"; // public | dm
    let dmPeer = null;       // {name,bio,photo,online,...}
    let dmRoom = null;       // stable room key
    const dmCache = new Map(); // room -> messages array

    // send extras
    let currentFile = null;
    let currentFileData = null;

    let replyTo = null; // {id,name,text}

    // ping
    let pingTimer = null;
    let lastPingAt = 0;

    // voice record
    let mediaRecorder = null;
    let voiceChunks = [];
    let voiceBlob = null;

    /* ============================================================
       UTIL
    ============================================================ */
    const esc = (t)=> {
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    };
    const clamp = (s, n)=> (String(s ?? "").length > n ? String(s).slice(0,n) : String(s ?? ""));
    const initials = (name)=>{
      const s = String(name||"").trim();
      const parts = s.split(/\s+/).filter(Boolean);
      const a = (parts[0]?.[0]||"").toUpperCase();
      const b = (parts[1]?.[0]||parts[0]?.[1]||"").toUpperCase();
      return (a + b) || "ME";
    };
    const validName = (name)=>{
      const s = String(name||"").trim();
      return s.length >= 3;
    };
    const formatTime = (ts)=>{
      try{
        return new Date(ts||Date.now()).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
      }catch{ return ""; }
    };
    const makeId = ()=> String(Date.now()) + "_" + Math.random().toString(16).slice(2);

    function toast(title, msg){
      el.toastTitle.textContent = String(title||"INFO").toUpperCase();
      el.toastMsg.textContent = String(msg||"");
      el.toast.classList.add("on");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.toast.classList.remove("on"), 2600);
    }

    function setConn(status){
      // status: ok | wait | bad
      el.connDot.classList.remove("connected","disconnected");
      el.connPill.classList.remove("ok","wait","bad");

      if(status === "ok"){
        el.connDot.classList.add("connected");
        el.connText.textContent = "CONNECTED";
        el.connPill.classList.add("ok");
        el.connPill.innerHTML = `<i class="fa-solid fa-wifi"></i> CONNECTED`;
      }else if(status === "wait"){
        el.connText.textContent = "CONNECTING";
        el.connPill.classList.add("wait");
        el.connPill.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> CONNECTING`;
      }else{
        el.connDot.classList.add("disconnected");
        el.connText.textContent = "DISCONNECTED";
        el.connPill.classList.add("bad");
        el.connPill.innerHTML = `<i class="fa-solid fa-wifi-slash"></i> DISCONNECTED`;
      }
    }

    // âœ… ping: merah/kuning/hijau (tanpa ubah struktur)
    function setBarsByPing(ms){
      // signal bars level
      let level = 1;
      if(ms <= 80) level = 4;
      else if(ms <= 140) level = 3;
      else if(ms <= 220) level = 2;
      else level = 1;
      el.bars.className = "bars l" + level;

      // color state
      el.sigPill.classList.remove("good","warn","bad");
      if(ms <= 120) el.sigPill.classList.add("good");
      else if(ms <= 240) el.sigPill.classList.add("warn");
      else el.sigPill.classList.add("bad");
    }

    function applyMeUI(){
      el.meName.textContent = me.name ? me.name : "Guest";
      el.meBio.textContent = me.bio ? me.bio : "â€”";
      el.meInitials.textContent = initials(me.name);

      if(me.photo){
        el.meAvatarImg.src = me.photo;
        el.meAvatarImg.style.display = "block";
        el.meInitials.style.display = "none";
      }else{
        el.meAvatarImg.removeAttribute("src");
        el.meAvatarImg.style.display = "none";
        el.meInitials.style.display = "block";
      }
    }

    function sidebarOpen(open){
      const show = (open===undefined) ? !el.sidebar.classList.contains("active") : open;
      if(show){
        el.sidebar.classList.add("active");
        el.overlay.classList.add("active");
      }else{
        el.sidebar.classList.remove("active");
        el.overlay.classList.remove("active");
      }
    }

    function openGate(mode){
      el.gate.classList.add("active");
      el.gateTitle.textContent = (mode==="edit") ? "EDIT PROFILE" : "LOGIN";
      if(mode==="edit"){
        el.gateName.value = me.name || "";
        el.gateBio.value = me.bio || "";
        el.photoLabel.textContent = me.photo ? "Ganti foto profil (sudah ada)" : "Upload foto profil (opsional)";
      }else{
        el.gateName.value = "";
        el.gateBio.value = "";
        el.photoLabel.textContent = "Upload foto profil (opsional)";
      }
      setTimeout(()=> el.gateName.focus(), 50);
    }
    function closeGate(){ el.gate.classList.remove("active"); }

    function openProfile(u){
      profUser = u;
      el.pmodal.classList.add("active");

      el.pname.textContent = (u?.name||"").toUpperCase();
      el.pbio.textContent = u?.bio || "â€”";

      const on = !!u?.online;
      el.pdot.classList.toggle("on", on);
      el.pstatus.textContent = on ? "ONLINE" : "OFFLINE";

      if(u?.photo){
        el.pavaImg.src = u.photo;
        el.pavaImg.style.display = "block";
        el.pavaIn.style.display = "none";
      }else{
        el.pavaImg.removeAttribute("src");
        el.pavaImg.style.display = "none";
        el.pavaIn.style.display = "block";
        el.pavaIn.textContent = initials(u?.name);
      }
    }
    function closeProfile(){
      el.pmodal.classList.remove("active");
      profUser = null;
    }

    function enableInput(on){
      el.msgInput.disabled = !on;
      el.sendBtn.disabled = !on;
      el.attachBtn.disabled = !on;
      el.micBtn.disabled = !on;
      if(on) el.msgInput.focus();
    }

    function clearFile(){
      currentFile = null;
      currentFileData = null;
      el.filePreview.classList.remove("active");
      el.fileInput.value = "";
    }

    function setReplyPreview(on, data){
      if(on && data){
        replyTo = data;
        el.replyToName.textContent = ("REPLY TO: " + (data.name||"")).toUpperCase();
        el.replyToText.textContent = data.text || "";
        el.replyPreview.classList.add("active");
      }else{
        replyTo = null;
        el.replyPreview.classList.remove("active");
      }
    }

    // âœ… helper: get user object for profile (ensure bio/photo from map)
    function getUserSafe(name, fromPhoto){
      if(!name) return null;
      const u = usersMap.get(name);
      if(u) return u;
      return {
        name,
        bio: "",
        photo: fromPhoto || null,
        online: false,
        lastSeen: Date.now(),
        unreadDM: 0
      };
    }

    /* ============================================================
       INTRO SPLASH
    ============================================================ */
    function hideSplash(){
      if(!el.splash) return;
      el.splash.classList.add("hide");
      setTimeout(()=> {
        if(el.splash && el.splash.parentNode) el.splash.parentNode.removeChild(el.splash);
      }, 700);
    }

    /* ============================================================
       MUSIC
    ============================================================ */
    function setMusicState(on){
      musicOn = !!on;
      el.musicBtn.classList.toggle("music-on", musicOn);
      el.musicText.textContent = musicOn ? "MUSIC ON" : "MUSIC OFF";
    }
    async function tryPlayMusic(){
      try{
        el.bgm.volume = 0.75;
        await el.bgm.play();
        setMusicState(true);
      }catch{ setMusicState(false); }
    }
    async function toggleMusic(){
      try{
        if(musicOn){
          el.bgm.pause();
          setMusicState(false);
        }else{
          await el.bgm.play();
          setMusicState(true);
        }
      }catch{
        setMusicState(false);
        toast("AUDIO", "Autoplay diblokir. Coba klik lagi / unmute HP.");
      }
    }
    function installAudioUnlock(){
      const unlock = async () => {
        if(!musicOn){
          try{ await el.bgm.play(); setMusicState(true); }catch{}
        }
        window.removeEventListener("touchstart", unlock);
        window.removeEventListener("click", unlock);
      };
      window.addEventListener("touchstart", unlock, { once:true });
      window.addEventListener("click", unlock, { once:true });
    }

    /* ============================================================
       CHAT: MODE SWITCH
    ============================================================ */
    function setModePublic(){
      chatMode = "public";
      dmPeer = null;
      dmRoom = null;

      el.dmHeader.classList.remove("on");
      el.publicHeader.style.display = "flex";

      el.messages.innerHTML = "";
      el.messages.appendChild(el.welcome);
      el.welcome.style.display = "flex";
      el.welcome.innerHTML = `<i class="fa-solid fa-bolt"></i> PUBLIC CHAT`;
      setTimeout(()=> el.welcome.style.display = "none", 900);

      if(socket && connected) socket.emit("public:history");
      setReplyPreview(false);
      clearFile();
    }

    function roomKey(a,b){
      const x = String(a||"").toLowerCase();
      const y = String(b||"").toLowerCase();
      return [x,y].sort().join("__");
    }

    function setModeDM(peer){
      chatMode = "dm";
      dmPeer = peer;
      dmRoom = roomKey(me.name, peer.name);

      el.publicHeader.style.display = "none";
      el.dmHeader.classList.add("on");

      el.dmName.textContent = (peer.name||"").toUpperCase();
      el.dmSub.textContent = peer.bio ? peer.bio : (peer.online ? "ONLINE" : "OFFLINE");

      if(peer.photo){
        el.dmAvaImg.src = peer.photo;
        el.dmAvaImg.style.display = "block";
        el.dmAvaIn.style.display = "none";
      }else{
        el.dmAvaImg.removeAttribute("src");
        el.dmAvaImg.style.display = "none";
        el.dmAvaIn.style.display = "block";
        el.dmAvaIn.textContent = initials(peer.name);
      }

      // clear unread
      const u = usersMap.get(peer.name);
      if(u){ u.unreadDM = 0; usersMap.set(peer.name,u); renderUsers(); }

      // render dm history
      el.messages.innerHTML = "";
      const cached = dmCache.get(dmRoom) || [];
      if(cached.length){
        cached.forEach(m => renderMsg(m, "dm"));
        scrollBottom();
      }else{
        el.welcome.style.display = "flex";
        el.welcome.innerHTML = `<i class="fa-solid fa-lock"></i> DM: ${esc(peer.name)}`;
        el.messages.appendChild(el.welcome);
      }

      if(socket && connected){
        socket.emit("dm:history", { room: dmRoom, peer: peer.name });
      }

      setReplyPreview(false);
      clearFile();
    }

    /* ============================================================
       MESSAGES RENDER
    ============================================================ */
    function scrollBottom(){ el.messages.scrollTop = el.messages.scrollHeight; }

    function renderMsg(m, modeOverride){
      const mode = modeOverride || chatMode;
      const isOwn = (String(m?.from||"") === String(me.name||""));

      const wrap = document.createElement("div");
      wrap.className = "msg " + (isOwn ? "own" : "other");

      const ava = document.createElement("div");
      ava.className = "m-ava";

      // avatar: fromPhoto present? else initials
      const img = document.createElement("img");
      const ini = document.createElement("div");
      ini.className = "m-in";
      ini.textContent = initials(m?.from || "?");

      if(m?.fromPhoto){
        img.src = m.fromPhoto;
        img.style.display = "block";
        ini.style.display = "none";
      }else{
        img.style.display = "none";
        ini.style.display = "block";
      }
      ava.appendChild(img);
      ava.appendChild(ini);

      // âœ… click avatar => open public profile (works in public + dm)
      ava.addEventListener("click", ()=>{
        const u = getUserSafe(m?.from, m?.fromPhoto);
        if(!u) return;
        // ensure photo if missing
        if(m?.fromPhoto && !u.photo) u.photo = m.fromPhoto;
        usersMap.set(u.name, u);
        renderUsers();
        openProfile(u);
      });

      // bubble
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.dataset.id = m?.id || "";

      // reply card
      if(m?.replyTo?.id){
        const rc = document.createElement("div");
        rc.className = "reply-card";
        rc.innerHTML = `<div class="rt">REPLY TO: ${esc(m.replyTo.name||"")}</div><div class="rc">${esc(m.replyTo.text||"")}</div>`;
        bubble.appendChild(rc);
      }

      // content
      if(m?.kind === "image" && m?.data){
        if(m?.text){
          const t = document.createElement("div");
          t.innerHTML = esc(m.text).replace(/\n/g,"<br>");
          bubble.appendChild(t);
        }
        const im = document.createElement("img");
        im.src = m.data;
        im.alt = "image";
        im.addEventListener("click", ()=>{
          el.imgModalEl.src = m.data;
          el.imgModal.classList.add("active");
        });
        bubble.appendChild(im);
      }else if(m?.kind === "video" && m?.data){
        if(m?.text){
          const t = document.createElement("div");
          t.innerHTML = esc(m.text).replace(/\n/g,"<br>");
          bubble.appendChild(t);
        }
        const v = document.createElement("video");
        v.controls = true;
        v.playsInline = true;
        v.src = m.data;
        v.style.width = "260px";
        v.style.maxWidth = "100%";
        v.style.marginTop = "10px";
        v.style.borderRadius = "12px";
        v.style.border = "1px solid rgba(255,255,255,.12)";
        bubble.appendChild(v);
      }else if(m?.kind === "voice" && m?.data){
        if(m?.text){
          const t = document.createElement("div");
          t.innerHTML = esc(m.text).replace(/\n/g,"<br>");
          bubble.appendChild(t);
        }
        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = m.data;
        audio.style.width = "260px";
        audio.style.marginTop = "10px";
        bubble.appendChild(audio);
      }else{
        const t = document.createElement("div");
        t.innerHTML = esc(m?.text || "").replace(/\n/g,"<br>");
        bubble.appendChild(t);
      }

      // time + âœ… reply button (everyone can see reply tag because replyTo already broadcast)
      const tm = document.createElement("div");
      tm.className = "time";

      const btn = document.createElement("button");
      btn.className = "rbtn";
      btn.type = "button";
      btn.innerHTML = `<i class="fa-solid fa-reply"></i><span>REPLY</span>`;

      btn.addEventListener("click", ()=>{
        setReplyPreview(true, {
          id: m.id,
          name: m.from,
          text: (m.text || (m.kind ? "["+m.kind+"]" : ""))
        });
        toast("REPLY", "Reply aktif. Ketik pesan lalu kirim.");
      });

      const ts = document.createElement("span");
      ts.textContent = formatTime(m?.ts);

      tm.appendChild(btn);
      tm.appendChild(ts);
      bubble.appendChild(tm);

      // (tetap support dblclick juga)
      bubble.addEventListener("dblclick", ()=>{
        setReplyPreview(true, { id: m.id, name: m.from, text: (m.text || (m.kind ? "["+m.kind+"]" : "")) });
        toast("REPLY", "Reply aktif. Ketik pesan lalu kirim.");
      });

      wrap.appendChild(ava);
      wrap.appendChild(bubble);
      el.messages.appendChild(wrap);
    }

    /* ============================================================
       USERS LIST
    ============================================================ */
    function renderUsers(){
      const arr = Array.from(usersMap.values())
        .sort((a,b)=>{
          // online first
          if(!!a.online !== !!b.online) return (b.online?1:0) - (a.online?1:0);
          // last seen desc
          return (b.lastSeen||0) - (a.lastSeen||0);
        });

      el.userList.innerHTML = "";
      el.usersCount.textContent = String(arr.length);

      for(const u of arr){
        const item = document.createElement("div");
        item.className = "user-item";

        const ava = document.createElement("div");
        ava.className = "u-ava";
        const img = document.createElement("img");
        const ini = document.createElement("div");
        ini.className = "u-in";
        ini.textContent = initials(u.name);

        if(u.photo){
          img.src = u.photo;
          img.style.display = "block";
          ini.style.display = "none";
        }else{
          img.style.display = "none";
          ini.style.display = "block";
        }
        ava.appendChild(img);
        ava.appendChild(ini);

        const info = document.createElement("div");
        info.className = "u-info";
        info.innerHTML = `
          <div class="u-name">${esc(u.name)}</div>
          <div class="u-bio">${esc(u.bio||"â€”")}</div>
          <div class="u-meta">
            <span class="u-dot ${u.online ? "on" : ""}"></span>
            <span>${u.online ? "ONLINE" : "OFFLINE"}</span>
            <span style="opacity:.6">â€¢</span>
            <span style="opacity:.8">${u.online ? "TAP FOR DM" : "DM READY"}</span>
          </div>
        `;

        const unread = document.createElement("div");
        unread.className = "u-unread " + ((u.unreadDM||0)>0 ? "on" : "");
        unread.textContent = String(u.unreadDM||0);

        item.appendChild(ava);
        item.appendChild(info);
        item.appendChild(unread);

        item.addEventListener("click", ()=>{
          // tap = open public profile modal
          openProfile(u);
        });

        el.userList.appendChild(item);
      }
    }

    /* ============================================================
       SOCKET
    ============================================================ */
    function connectSocket(){
      if(!window.io){
        setConn("bad");
        toast("ERROR","Socket.io client missing.");
        return;
      }

      setConn("wait");
      enableInput(false);

      socket = io(SOCKET_URL, { transports:["websocket","polling"] });

      socket.on("connect", ()=>{
        connected = true;
        setConn("ok");
        enableInput(true);

        // hello profile
        socket.emit("profile:hello", { name: me.name, bio: me.bio, photo: me.photo });
        socket.emit("users:sync");

        // history
        socket.emit("public:history");

        // ping loop
        startPing();
      });

      socket.on("disconnect", ()=>{
        connected = false;
        setConn("bad");
        enableInput(false);
        stopPing();
      });

      socket.on("connect_error", ()=>{
        connected = false;
        setConn("bad");
        enableInput(false);
        stopPing();
      });

      socket.on("users:list", (data)=>{
        const list = data?.users || [];
        el.onlineCount.textContent = String(data?.onlineCount ?? 0);

        for(const u of list){
          const prev = usersMap.get(u.name) || { unreadDM:0 };
          usersMap.set(u.name, {
            name: u.name,
            bio: u.bio || "",
            photo: u.photo || null,
            online: !!u.online,
            lastSeen: u.lastSeen || Date.now(),
            unreadDM: prev.unreadDM || 0
          });
        }
        renderUsers();
      });

      socket.on("users:update", (u)=>{
        if(!u?.name) return;
        const prev = usersMap.get(u.name) || { unreadDM:0 };
        usersMap.set(u.name, {
          name: u.name,
          bio: u.bio || "",
          photo: u.photo || null,
          online: !!u.online,
          lastSeen: u.lastSeen || Date.now(),
          unreadDM: prev.unreadDM || 0
        });
        renderUsers();
        el.onlineCount.textContent = String(Array.from(usersMap.values()).filter(x=>x.online).length);

        // update dm header sub if currently in dm with this peer
        if(chatMode==="dm" && dmPeer && u.name === dmPeer.name){
          dmPeer = usersMap.get(u.name);
          el.dmSub.textContent = dmPeer.bio ? dmPeer.bio : (dmPeer.online ? "ONLINE" : "OFFLINE");
        }
      });

      // PUBLIC
      socket.on("public:history", (history)=>{
        if(chatMode!=="public") return;
        el.messages.innerHTML = "";
        (history||[]).forEach(m => renderMsg(m, "public"));
        scrollBottom();
      });

      socket.on("public:new", (m)=>{
        if(chatMode!=="public") return;
        renderMsg(m, "public");
        scrollBottom();
      });

      // DM history
      socket.on("dm:history", ({ room, peer, messages })=>{
        if(!room) return;
        dmCache.set(room, messages || []);

        if(chatMode==="dm" && dmRoom === room){
          el.messages.innerHTML = "";
          (messages||[]).forEach(m => renderMsg(m, "dm"));
          scrollBottom();
        }
      });

      // âœ… DM NEW (WORK + NOTIF)
      socket.on("dm:new", (data)=>{
        const m = data?.msg;
        const from = data?.from;
        const isSelf = !!data?.self;
        if(!m || !from) return;

        // cache dm
        const r = roomKey(m.from, m.to);
        const arr = dmCache.get(r) || [];
        arr.push(m);
        if(arr.length > 400) arr.shift();
        dmCache.set(r, arr);

        // if self echo
        if(isSelf){
          if(chatMode==="dm" && dmPeer && dmPeer.name === m.to){
            renderMsg(m, "dm"); scrollBottom();
          }
          return;
        }

        // incoming from other user
        // if currently in that dm
        if(chatMode==="dm" && dmPeer && dmPeer.name === m.from){
          renderMsg(m, "dm"); scrollBottom();
          return;
        }

        // not in dm => unread + toast
        const u = usersMap.get(m.from) || { name:m.from, bio:"", photo:m.fromPhoto||null, online:false, lastSeen:Date.now(), unreadDM:0 };
        u.unreadDM = (u.unreadDM||0) + 1;
        if(m.fromPhoto && !u.photo) u.photo = m.fromPhoto;
        usersMap.set(u.name, u);
        renderUsers();

        toast("DM", `${m.from}: ${m.text ? m.text : (m.kind ? "["+m.kind+"]" : "message")}`);
      });

      // typing
      socket.on("typing", (d)=>{
        if(!d) return;
        if(d.mode==="dm"){
          if(chatMode==="dm" && dmPeer && d.peer && d.peer === dmPeer.name && d.from !== me.name){
            el.typing.style.display = d.on ? "flex" : "none";
            el.typingText.textContent = `${d.from} is typing...`;
          }
        }else{
          if(chatMode==="public" && d.from !== me.name){
            el.typing.style.display = d.on ? "flex" : "none";
            el.typingText.textContent = `${d.from} is typing...`;
          }
        }
      });

      socket.on("pong", ()=>{
        const ms = Math.max(1, Date.now() - lastPingAt);
        el.pingText.textContent = `${ms} MS`;
        setBarsByPing(ms);
      });
    }

    function startPing(){
      stopPing();
      pingTimer = setInterval(()=>{
        if(!socket || !connected) return;
        lastPingAt = Date.now();
        socket.emit("ping");
      }, 1200);
    }
    function stopPing(){
      if(pingTimer) clearInterval(pingTimer);
      pingTimer = null;
      el.pingText.textContent = "-- MS";
      el.bars.className = "bars l1";
      el.sigPill.classList.remove("good","warn","bad");
    }

    /* ============================================================
       SEND (PUBLIC / DM)
    ============================================================ */
    function send(){
      if(!socket || !connected) return;

      const text = String(el.msgInput.value || "").trim();
      if(!text && !currentFileData && !voiceBlob) return;

      const msg = {
        id: makeId(),
        ts: Date.now(),
        text: text,
        replyTo: replyTo ? { id: replyTo.id, name: replyTo.name, text: replyTo.text } : null,
        kind: "text",
        data: null
      };

      if(currentFileData){
        // âœ… auto detect image/video from dataURL
        msg.kind = String(currentFileData).startsWith("data:video") ? "video" : "image";
        msg.data = currentFileData;
      }
      if(voiceBlob){
        msg.kind = "voice";
        msg.data = voiceBlob;
      }

      if(chatMode === "public"){
        socket.emit("public:send", {
          ...msg,
          from: me.name,
          fromPhoto: me.photo || null
        });
      }else{
        // DM: boleh walau peer offline (server akan pending)
        if(!dmPeer || !dmRoom) return;
        socket.emit("dm:send", {
          room: dmRoom,
          to: dmPeer.name,
          msg: {
            ...msg,
            from: me.name,
            to: dmPeer.name,
            fromPhoto: me.photo || null
          }
        });
      }

      el.msgInput.value = "";
      el.msgInput.style.height = "auto";
      setReplyPreview(false);
      clearFile();
      voiceBlob = null;
    }

    /* ============================================================
       FILE (âœ… image + video)
    ============================================================ */
    function handleFileSelect(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      const isImg = f.type.startsWith("image/");
      const isVid = f.type.startsWith("video/");
      if(!isImg && !isVid) return toast("FILE","Hanya image/video yang diizinkan.");

      // limits
      if(isImg && f.size > 10*1024*1024) return toast("FILE","Image max 10MB.");
      if(isVid && f.size > 30*1024*1024) return toast("FILE","Video max 30MB.");

      currentFile = f;
      el.filePreview.classList.add("active");
      el.fileName.textContent = f.name;

      const r = new FileReader();
      r.onload = (ev)=> currentFileData = ev.target.result;
      r.readAsDataURL(f);
    }

    /* ============================================================
       VOICE RECORD (browser support)
    ============================================================ */
    async function toggleRecord(){
      if(!navigator.mediaDevices?.getUserMedia){
        toast("VOICE","Browser tidak support record.");
        return;
      }

      if(mediaRecorder && mediaRecorder.state === "recording"){
        mediaRecorder.stop();
        el.micBtn.innerHTML = `<i class="fa-solid fa-microphone"></i>`;
        toast("VOICE","Rekaman selesai. Tekan SEND untuk kirim.");
        return;
      }

      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        voiceChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (ev)=> { if(ev.data?.size) voiceChunks.push(ev.data); };
        mediaRecorder.onstop = ()=>{
          const blob = new Blob(voiceChunks, { type: "audio/webm" });
          const reader = new FileReader();
          reader.onload = ()=> { voiceBlob = reader.result; };
          reader.readAsDataURL(blob);
          stream.getTracks().forEach(t=>t.stop());
        };
        mediaRecorder.start();
        el.micBtn.innerHTML = `<i class="fa-solid fa-stop"></i>`;
        toast("VOICE","Recording... tekan mic lagi untuk stop.");
      }catch{
        toast("VOICE","Izin mic ditolak / error.");
      }
    }

    /* ============================================================
       BACKGROUND FX (random shapes + color cycling)
    ============================================================ */
    function setupFX(){
      const c = el.fxCanvas;
      const ctx = c.getContext("2d", { alpha:true });

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        c.width = Math.floor(window.innerWidth * dpr);
        c.height = Math.floor(window.innerHeight * dpr);
        c.style.width = window.innerWidth + "px";
        c.style.height = window.innerHeight + "px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      const shapes = [];
      const stars = [];
      let t = 0;

      const rand = (a,b)=> Math.random()*(b-a)+a;

      const STAR_COUNT = Math.min(240, Math.floor((window.innerWidth*window.innerHeight)/6500));
      for(let i=0;i<STAR_COUNT;i++){
        stars.push({ x:rand(0,innerWidth), y:rand(0,innerHeight), r:rand(.4,1.4), a:rand(.12,.9), tw:rand(.002,.01) });
      }

      function spawnShape(){
        const type = Math.random() < 0.5 ? "ring" : "poly";
        shapes.push({
          type,
          x: rand(-100, innerWidth+100),
          y: rand(-100, innerHeight+100),
          vx: rand(-.08,.08),
          vy: rand(-.08,.08),
          r: rand(30, 120),
          rot: rand(0, Math.PI*2),
          vr: rand(-.002,.002),
          life: rand(700, 1200),
          hue: rand(0, 360),
          alpha: rand(.08,.18),
          sides: Math.floor(rand(5, 9))
        });
        if(shapes.length > 22) shapes.shift();
      }

      for(let i=0;i<12;i++) spawnShape();

      function draw(){
        t++;

        ctx.clearRect(0,0,innerWidth,innerHeight);

        // stars twinkle
        for(const s of stars){
          s.a += (Math.random()<0.5 ? -1 : 1) * s.tw;
          s.a = Math.max(0.06, Math.min(0.95, s.a));
          ctx.beginPath();
          ctx.fillStyle = `rgba(220,235,255,${s.a})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();
        }

        if(t % 80 === 0) spawnShape();

        // moving neon shapes
        for(let i=shapes.length-1;i>=0;i--){
          const p = shapes[i];
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.life -= 1;
          p.hue = (p.hue + 0.35) % 360;

          const col = `hsla(${p.hue}, 90%, 70%, ${p.alpha})`;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);

          ctx.lineWidth = 2;
          ctx.strokeStyle = col;
          ctx.shadowColor = `hsla(${p.hue}, 90%, 70%, ${p.alpha*1.8})`;
          ctx.shadowBlur = 18;

          if(p.type === "ring"){
            ctx.beginPath();
            ctx.arc(0,0,p.r,0,Math.PI*2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(0,0,p.r*0.62,0,Math.PI*2);
            ctx.stroke();
          }else{
            // polygon
            ctx.beginPath();
            for(let k=0;k<p.sides;k++){
              const ang = (k/p.sides) * Math.PI*2;
              const rr = p.r * (0.72 + 0.28*Math.sin(t*0.01 + k));
              const x = Math.cos(ang)*rr;
              const y = Math.sin(ang)*rr;
              if(k===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.closePath();
            ctx.stroke();
          }

          ctx.restore();

          if(p.life<=0) shapes.splice(i,1);
        }

        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);
    }

    /* ============================================================
       INIT
    ============================================================ */
    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function saveProfileFromGate(){
      const name = String(el.gateName.value || "").trim();
      const bio = String(el.gateBio.value || "").trim();

      if(!validName(name)){
        toast("LOGIN","Nama minimal 3 karakter.");
        el.gateName.focus();
        return;
      }

      me.name = name;
      me.bio = clamp(bio, 180);
      localStorage.setItem(KEY_NAME, me.name);
      localStorage.setItem(KEY_BIO, me.bio);

      if(el.gatePhoto.files && el.gatePhoto.files[0]){
        const f = el.gatePhoto.files[0];
        if(!f.type.startsWith("image/")){ toast("PHOTO","Harus gambar."); return; }
        if(f.size > 2*1024*1024){ toast("PHOTO","Max 2MB."); return; }
        me.photo = await fileToBase64(f);
        localStorage.setItem(KEY_PHOTO, me.photo);
      }else{
        const saved = localStorage.getItem(KEY_PHOTO);
        me.photo = saved ? saved : null;
      }

      applyMeUI();
      closeGate();

      if(!socket){
        connectSocket();
      }else{
        socket.emit("profile:update", { name: me.name, bio: me.bio, photo: me.photo });
      }
    }

    function logout(){
      localStorage.removeItem(KEY_NAME);
      localStorage.removeItem(KEY_BIO);
      localStorage.removeItem(KEY_PHOTO);

      me.name = null; me.bio = ""; me.photo = null;
      applyMeUI();

      try{ socket && socket.disconnect(); }catch{}
      socket = null; connected = false;

      usersMap.clear();
      renderUsers();
      el.onlineCount.textContent = "0";

      enableInput(false);
      setConn("bad");

      setModePublic();
      sidebarOpen(false);

      openGate("login");
    }

    function init(){
      setupFX();

      // âœ… auto-hide splash (slowmo feel)
      setTimeout(hideSplash, 3000);

      // textarea autoresize
      el.msgInput.addEventListener("input", function(){
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      // sidebar
      el.hamburger.addEventListener("click", ()=> sidebarOpen(true));
      el.overlay.addEventListener("click", ()=> sidebarOpen(false));

      // modals
      el.imgModal.addEventListener("click", ()=> el.imgModal.classList.remove("active"));
      el.pclose.addEventListener("click", closeProfile);
      el.pmodal.addEventListener("click", (e)=>{ if(e.target === el.pmodal) closeProfile(); });

      // profile actions
      el.meAvatar.addEventListener("click", ()=> openGate("edit"));
      el.btnEdit.addEventListener("click", ()=> openGate("edit"));
      el.btnLogout.addEventListener("click", logout);

      // gate actions
      el.gateGo.addEventListener("click", saveProfileFromGate);
      el.gateReset.addEventListener("click", ()=>{
        localStorage.removeItem(KEY_NAME);
        localStorage.removeItem(KEY_BIO);
        localStorage.removeItem(KEY_PHOTO);
        el.gateName.value = "";
        el.gateBio.value = "";
        el.gatePhoto.value = "";
        el.photoLabel.textContent = "Upload foto profil (opsional)";
        toast("RESET","Data login dihapus.");
      });
      el.gatePhoto.addEventListener("change", ()=>{
        const f = el.gatePhoto.files && el.gatePhoto.files[0];
        if(!f) return;
        el.photoLabel.textContent = `Foto: ${f.name}`;
      });

      // dm modal buttons
      el.pview.addEventListener("click", ()=>{
        if(!profUser) return;
        toast("PROFILE", `${profUser.name} â€¢ ${profUser.online ? "ONLINE" : "OFFLINE"}`);
      });

      // âœ… DM: langsung masuk DM, walau offline tetap bisa (server pending)
      el.pdm.addEventListener("click", ()=>{
        if(!profUser) return;
        if(!me.name){ toast("LOGIN","Login dulu."); return; }
        if(profUser.name === me.name){ toast("INFO","Tidak bisa DM diri sendiri."); return; }

        const safe = usersMap.get(profUser.name) || {
          name: profUser.name,
          bio: profUser.bio || "",
          photo: profUser.photo || null,
          online: !!profUser.online,
          lastSeen: Date.now(),
          unreadDM: 0
        };
        usersMap.set(safe.name, safe);
        renderUsers();

        closeProfile();
        setModeDM(safe);
        sidebarOpen(false);
      });

      // dm back
      el.dmBack.addEventListener("click", ()=>{
        setModePublic();
      });

      // attach
      el.attachBtn.addEventListener("click", ()=> el.fileInput.click());
      el.fileInput.addEventListener("change", handleFileSelect);
      el.fileRemove.addEventListener("click", clearFile);

      // reply remove
      el.replyRemove.addEventListener("click", ()=> setReplyPreview(false));

      // send
      el.sendBtn.addEventListener("click", send);
      el.msgInput.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          send();
        }
      });

      // typing emit
      el.msgInput.addEventListener("input", ()=>{
        if(!socket || !connected) return;
        socket.emit("typing", { mode: chatMode, peer: dmPeer?.name || "", on: true });
        clearTimeout(init._ty);
        init._ty = setTimeout(()=> socket.emit("typing", { mode: chatMode, peer: dmPeer?.name || "", on: false }), 700);
      });

      // mic
      el.micBtn.addEventListener("click", toggleRecord);

      // music
      el.musicBtn.addEventListener("click", toggleMusic);
      installAudioUnlock();
      tryPlayMusic();

      // load profile
      const savedName = (localStorage.getItem(KEY_NAME) || "").trim();
      const savedBio  = (localStorage.getItem(KEY_BIO) || "").trim();
      const savedPhoto = (localStorage.getItem(KEY_PHOTO) || "").trim();

      if(validName(savedName)){
        me.name = savedName;
        me.bio = clamp(savedBio, 180);
        me.photo = savedPhoto || null;
        applyMeUI();
        connectSocket();
        setModePublic();
      }else{
        me.name = null; me.bio = ""; me.photo = null;
        applyMeUI();
        enableInput(false);
        setConn("bad");
        openGate("login");
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
