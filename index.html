<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0a0f18" />
  <title>LIVE CHAT | ULTRA</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#070b13;
      --card: rgba(16, 24, 38, .55);
      --card2: rgba(10, 14, 26, .72);
      --stroke: rgba(170, 220, 255, .14);
      --stroke2: rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted: rgba(234,242,255,.62);
      --muted2: rgba(234,242,255,.40);

      --good:#4ade80;
      --bad:#fb7185;
      --warn:#facc15;

      --a1:#7dd3fc;
      --a2:#a78bfa;
      --a3:#34d399;
      --a4:#fb7185;

      --fontH:'Orbitron',sans-serif;
      --fontB:'Share Tech Mono',monospace;

      --r12:12px;
      --r16:16px;
      --r20:20px;

      --hue: 0deg;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:var(--fontB); -webkit-tap-highlight-color:transparent; }
    html, body { height:100%; }

    body{
      background:
        radial-gradient(1200px 900px at 15% 0%, rgba(125,211,252,.14), transparent 60%),
        radial-gradient(900px 900px at 85% 15%, rgba(167,139,250,.12), transparent 55%),
        radial-gradient(900px 800px at 40% 95%, rgba(52,211,153,.10), transparent 55%),
        linear-gradient(180deg, #050814, #0a0f18 45%, #050814);
      color: var(--text);
      overflow:hidden;
    }

    /* ULTRA color shift */
    .hueshift{
      position:fixed; inset:0;
      pointer-events:none;
      filter: hue-rotate(var(--hue)) saturate(1.1);
      z-index:-5;
    }

    /* Background canvases */
    .bg-wrap{
      position:fixed; inset:0; z-index:-4;
      pointer-events:none;
    }
    canvas#meteorCanvas, canvas#orbCanvas{
      width:100%; height:100%;
      display:block;
    }
    canvas#meteorCanvas{
      filter: drop-shadow(0 0 10px rgba(125,211,252,.22));
      opacity:.9;
    }
    canvas#orbCanvas{
      opacity:.65;
      mix-blend-mode: screen;
      filter: blur(1px);
    }

    .glow{
      position:fixed; inset:0; z-index:-3;
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(125,211,252,.10), transparent 70%),
        radial-gradient(800px 800px at 10% 80%, rgba(167,139,250,.08), transparent 60%),
        radial-gradient(700px 700px at 90% 85%, rgba(52,211,153,.07), transparent 55%);
      pointer-events:none;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.16); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,.25); }

    .app{
      height:100dvh;
      width:100%;
      max-width:1600px;
      margin:0 auto;
      display:flex;
      position:relative;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:320px;
      flex-shrink:0;
      border-right:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(8,12,22,.70), rgba(8,12,22,.35));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      z-index:50;
      transition: transform .28s cubic-bezier(.4,0,.2,1);
    }

    .user-card{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,24,38,.72), rgba(10,15,24,.25));
    }

    .profile-top{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .avatar{
      width:66px; height:66px;
      border-radius:18px;
      border:1px solid rgba(125,211,252,.30);
      background: rgba(0,0,0,.35);
      box-shadow:
        0 18px 55px rgba(0,0,0,.35),
        0 0 0 1px rgba(255,255,255,.06) inset;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      cursor:pointer;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:none; }
    .avatar .initials{
      font-family:var(--fontH);
      font-weight:800;
      letter-spacing:1px;
      color:#eaf2ff;
      font-size:20px;
      opacity:.92;
    }

    .me-info{ min-width:0; flex:1; }
    .me-name{
      font-family:var(--fontH);
      font-size:15px;
      letter-spacing:1px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .me-bio{
      margin-top:6px;
      font-size:11px;
      color: var(--muted2);
      line-height:1.35;
      max-height:2.7em;
      overflow:hidden;
    }

    .me-sub{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      user-select:none;
      white-space:nowrap;
    }
    .pill strong{
      color: var(--text);
      font-weight:800;
      letter-spacing:1px;
      font-family:var(--fontH);
      font-size:10px;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 14px rgba(250,204,21,.30);
    }
    .dot.on{ background: var(--good); box-shadow: 0 0 14px rgba(74,222,128,.35); }
    .dot.off{ background: var(--bad); box-shadow: 0 0 14px rgba(251,113,133,.30); }

    .card-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-family:var(--fontH);
      letter-spacing:1.5px;
      text-transform:uppercase;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .btn::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(125,211,252,.18), transparent 55%),
                  radial-gradient(circle at 70% 60%, rgba(167,139,250,.14), transparent 55%);
      transform: rotate(18deg);
      opacity:.9;
      pointer-events:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(170,220,255,.28); background: rgba(0,0,0,.30); }
    .btn.danger{ border-color: rgba(251,113,133,.20); }
    .btn.danger:hover{ border-color: rgba(251,113,133,.40); }

    .mini-panel{
      padding:14px 18px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      flex-direction:column;
      gap:10px;
      background: linear-gradient(180deg, rgba(12,18,30,.30), rgba(12,18,30,.12));
    }
    .mini-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .mini-title{
      font-family:var(--fontH);
      letter-spacing:1px;
      font-size:11px;
      color: var(--muted);
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .mini-badge{
      font-family:var(--fontH);
      letter-spacing:1px;
      font-size:11px;
      color: var(--text);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      min-width:56px;
      text-align:center;
    }

    .music-btn{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(170,220,255,.20);
      background: linear-gradient(135deg, rgba(125,211,252,.14), rgba(167,139,250,.10), rgba(52,211,153,.08));
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:11px;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .music-btn::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      transform: translateX(-120%);
      transition: transform .9s ease;
      pointer-events:none;
    }
    .music-btn:hover{ transform: translateY(-1px); border-color: rgba(170,220,255,.38); }
    .music-btn:hover::after{ transform: translateX(120%); }

    .music-dot{
      width:8px; height:8px; border-radius:50%;
      background: rgba(234,242,255,.25);
      box-shadow: 0 0 16px rgba(125,211,252,.18);
    }
    .music-on .music-dot{ background: var(--good); box-shadow: 0 0 16px rgba(74,222,128,.35); }

    .section-header{
      padding:12px 18px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      color: var(--muted);
    }
    .users-list{
      flex:1;
      overflow:auto;
      padding:10px;
      min-height:0;
    }

    .user-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:11px 10px;
      border-radius:14px;
      border:1px solid transparent;
      background: rgba(0,0,0,.10);
      margin-bottom:8px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .15s ease;
      position:relative;
      overflow:hidden;
    }
    .user-item:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,.18);
      border-color: rgba(170,220,255,.18);
    }
    .u-ava{
      width:42px;height:42px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1px;
      color: var(--text);
      overflow:hidden;
      flex-shrink:0;
    }
    .u-ava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .u-info{ min-width:0; flex:1; }
    .u-name{ font-size:13px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .u-sub{
      margin-top:3px;
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted2);
      font-size:10px;
      letter-spacing:1px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== Chat ===== */
    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
      position:relative;
    }

    .chat-header{
      height:64px;
      flex-shrink:0;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,24,38,.62), rgba(10,15,24,.22));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      gap:10px;
      z-index:10;
    }

    .left-head{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .hamburger{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      flex-shrink:0;
    }
    .hamburger:hover{ transform: translateY(-1px); border-color: rgba(170,220,255,.35); }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand h1{
      font-family:var(--fontH);
      font-size:16px;
      letter-spacing:2px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .badge-prem{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(170,220,255,.20);
      background: linear-gradient(135deg, rgba(125,211,252,.16), rgba(167,139,250,.10));
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--text);
      white-space:nowrap;
    }

    .mode-pill{
      margin-left:10px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--muted);
      white-space:nowrap;
      max-width:44vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .right-head{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }

    .net{
      display:flex;
      align-items:center;
      gap:10px;
      padding:9px 10px;
      border-radius:999px;
      border:1px solid rgba(170,220,255,.16);
      background: rgba(0,0,0,.18);
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--muted);
    }
    .net strong{ color: var(--text); font-weight:800; }
    .sig{
      display:flex;
      align-items:flex-end;
      gap:2px;
    }
    .bar{ width:3px; border-radius:2px; background: rgba(234,242,255,.30); }
    .bar.b1{ height:6px; }
    .bar.b2{ height:10px; }
    .bar.b3{ height:14px; }
    .bar.b4{ height:18px; }
    .sig.good .bar{ background: rgba(74,222,128,.65); }
    .sig.mid .bar{ background: rgba(250,204,21,.65); }
    .sig.bad .bar{ background: rgba(251,113,133,.70); }

    .messages{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .sys{
      align-self:center;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:center;
      max-width:92%;
    }

    .msg{
      display:flex;
      gap:10px;
      max-width:88%;
      animation: pop .18s ease;
      align-items:flex-end;
    }
    .msg.own{ align-self:flex-end; flex-direction:row-reverse; }
    .msg.other{ align-self:flex-start; }

    @keyframes pop{
      from{ transform: translateY(6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .m-ava{
      width:36px; height:36px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1px;
      color: var(--text);
    }
    .m-ava img{ width:100%; height:100%; object-fit:cover; display:none; }

    .m-wrap{ display:flex; flex-direction:column; gap:6px; min-width:0; }

    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted2);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      user-select:none;
    }
    .meta .name{
      font-family:var(--fontH);
      letter-spacing:2px;
      color: var(--text);
      font-size:10px;
      cursor:pointer;
    }
    .role-badge{
      font-family:var(--fontH);
      font-size:9px;
      letter-spacing:2px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
    }

    .bubble{
      border-radius: 18px;
      padding:12px 14px;
      line-height:1.55;
      font-size:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      min-width: 48px;
    }
    .msg.own .bubble{
      background: linear-gradient(135deg, rgba(125,211,252,.16), rgba(167,139,250,.10), rgba(52,211,153,.08));
      border-color: rgba(170,220,255,.18);
    }

    .reply-box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:9px 10px;
      margin-bottom:10px;
      font-size:12px;
      color: var(--muted);
    }
    .reply-box strong{ color: var(--text); font-family:var(--fontH); letter-spacing:1px; font-size:11px; }
    .reply-box .pv{ margin-top:5px; color: var(--muted2); font-size:11px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .bubble img{
      max-width:100%;
      display:block;
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }

    .msg-actions{
      display:flex;
      gap:8px;
      margin-top:8px;
      opacity:.95;
    }
    .act{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--text);
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:1.6px;
      text-transform:uppercase;
      font-size:9px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .act:hover{ border-color: rgba(170,220,255,.22); }

    /* Input */
    .input{
      flex-shrink:0;
      border-top:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(8,12,22,.18), rgba(16,24,38,.50));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:12px 14px;
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .input .wrap{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .replying{
      display:none;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(170,220,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:12px;
      align-items:center;
      gap:10px;
    }
    .replying.active{ display:flex; }
    .replying .x{ margin-left:auto; cursor:pointer; opacity:.85; }
    .replying strong{ color: var(--text); font-family:var(--fontH); font-size:11px; letter-spacing:1px; }

    .file-preview{
      display:none;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(170,220,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
      align-items:center;
      gap:10px;
    }
    .file-preview.active{ display:flex; }
    .file-preview .remove{ margin-left:auto; cursor:pointer; opacity:.85; }

    textarea{
      width:100%;
      min-height:54px;
      max-height:130px;
      resize:none;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.34);
      color: var(--text);
      outline:none;
      font-size:14px;
      transition: border-color .15s ease, background .15s ease;
    }
    textarea:focus{ border-color: rgba(170,220,255,.26); background: rgba(0,0,0,.40); }

    .btns{
      display:flex;
      gap:10px;
      flex-shrink:0;
    }
    .icon{
      width:54px;height:54px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
    }
    .icon:hover{ transform: translateY(-1px); border-color: rgba(170,220,255,.20); }
    .send{
      background: linear-gradient(135deg, rgba(125,211,252,.75), rgba(167,139,250,.55), rgba(52,211,153,.42));
      border-color: rgba(170,220,255,.22);
      color:#07101e;
      font-weight:900;
    }
    .send:disabled, .icon:disabled, textarea:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    /* Modals */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      z-index:40;
    }
    .overlay.active{ display:block; }

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:18px;
    }
    .modal.active{ display:flex; }
    .modal img{
      max-width:95%;
      max-height:90vh;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
    }

    .gate{
      position:fixed; inset:0;
      z-index:3000;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .gate.active{ display:flex; }
    .gate-card{
      width:100%;
      max-width:560px;
      border-radius:20px;
      border:1px solid rgba(170,220,255,.14);
      background: linear-gradient(180deg, rgba(16,24,38,.78), rgba(10,15,24,.58));
      box-shadow: 0 25px 90px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }
    .gate-card::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 20%, rgba(125,211,252,.14), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(167,139,250,.12), transparent 55%),
                  radial-gradient(circle at 60% 30%, rgba(52,211,153,.10), transparent 55%);
      transform: rotate(18deg);
      opacity:.9;
      pointer-events:none;
      animation: floatGlow 7s ease-in-out infinite;
    }
    @keyframes floatGlow{
      0%,100%{ transform: translateY(0) rotate(18deg); }
      50%{ transform: translateY(-12px) rotate(18deg); }
    }

    .gate-head{
      padding:18px 18px 12px;
      border-bottom:1px solid rgba(170,220,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .gate-title{
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:14px;
    }
    .gate-sub{
      padding:0 18px 14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.6;
      position:relative;
      z-index:1;
    }
    .gate-body{
      padding:16px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
      z-index:1;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .field{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    .field:focus{ border-color: rgba(170,220,255,.24); }
    .upload{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:16px;
      border:1px dashed rgba(170,220,255,.20);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .gate-footer{
      padding:14px 18px 18px;
      display:flex;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .primary{
      flex:1;
      padding:13px 12px;
      border-radius:16px;
      border:none;
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
      background: linear-gradient(135deg, rgba(125,211,252,.90), rgba(167,139,250,.70), rgba(52,211,153,.55));
      color:#07101e;
      font-weight:900;
    }
    .secondary{
      padding:13px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
    }
    .hint{
      padding:0 18px 16px;
      color: var(--muted2);
      font-size:11px;
      position:relative;
      z-index:1;
    }

    /* Public Profile Modal */
    .pmodal{
      position:fixed; inset:0;
      z-index:2600;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .pmodal.active{ display:flex; }
    .pcard{
      width:100%;
      max-width:560px;
      border-radius:20px;
      border:1px solid rgba(170,220,255,.14);
      background: linear-gradient(180deg, rgba(16,24,38,.80), rgba(10,15,24,.62));
      box-shadow: 0 28px 95px rgba(0,0,0,.58);
      overflow:hidden;
      position:relative;
    }
    .phead{
      padding:14px 16px;
      border-bottom:1px solid rgba(170,220,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .phead .t{
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:13px;
      color: var(--text);
    }
    .xbtn{
      width:42px;height:42px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--text);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .pbody{
      padding:16px;
      display:flex;
      gap:14px;
      align-items:center;
    }
    .pava{
      width:74px;height:74px;border-radius:22px;
      border:1px solid rgba(170,220,255,.20);
      background: rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:var(--fontH);
      font-size:18px;
      letter-spacing:1px;
    }
    .pava img{ width:100%; height:100%; object-fit:cover; display:none; }
    .pinfo{ flex:1; min-width:0; }
    .pname{
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pline{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .pbio{
      padding:0 16px 14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.6;
      border-top:1px solid rgba(170,220,255,.08);
      margin-top:6px;
    }
    .pacts{
      padding:14px 16px 16px;
      display:flex;
      gap:10px;
      border-top:1px solid rgba(170,220,255,.08);
    }

    /* Toast */
    .toast{
      position:fixed;
      left:14px; right:14px; bottom:86px;
      z-index:4000;
      display:none;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(170,220,255,.14);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 65px rgba(0,0,0,.55);
      color: var(--text);
      font-size:12px;
      line-height:1.35;
    }
    .toast.active{ display:block; animation: pop .18s ease; }
    .toast strong{ font-family:var(--fontH); letter-spacing:1px; font-size:11px; }
    .toast small{ color: var(--muted2); display:block; margin-top:3px; }

    @media (max-width: 900px){
      .sidebar{
        position:fixed;
        top:0; bottom:0; left:0;
        transform: translateX(-105%);
        width:300px;
        box-shadow: 18px 0 60px rgba(0,0,0,.55);
      }
      .sidebar.active{ transform: translateX(0); }
    }
  </style>
</head>

<body>
  <div class="hueshift"></div>

  <div class="bg-wrap">
    <canvas id="orbCanvas"></canvas>
    <canvas id="meteorCanvas"></canvas>
  </div>
  <div class="glow"></div>

  <!-- LOGIN / EDIT PROFILE -->
  <div class="gate" id="gate">
    <div class="gate-card">
      <div class="gate-head">
        <div class="gate-title" id="gateTitle">LOGIN</div>
        <span class="pill"><span class="dot off"></span><strong>Profile</strong></span>
      </div>
      <div class="gate-sub" id="gateSub">
        Isi <b>username</b> (bebas, boleh spasi/tanda) min 3 karakter.<br/>
        Tambahin <b>bio</b> biar keren & tampil publik. Foto opsional.
      </div>
      <div class="gate-body">
        <div class="row">
          <input id="gateUsername" class="field" maxlength="32" placeholder="contoh: Raraa Private ★" autocomplete="off"/>
          <label class="upload" for="gatePhoto">
            <i class="fa-solid fa-image"></i>
            <span id="photoLabel">Upload foto profil (opsional)</span>
          </label>
          <input id="gatePhoto" type="file" accept="image/*" style="display:none"/>
        </div>
        <div class="row">
          <input id="gateBio" class="field" maxlength="120" placeholder="bio (opsional) contoh: Ultra user • livechat vibes ✨" autocomplete="off"/>
        </div>
      </div>
      <div class="gate-footer">
        <button class="primary" id="gateGo">Masuk</button>
        <button class="secondary" id="gateReset" title="hapus data login">Reset</button>
      </div>
      <div class="hint">
        Autoplay musik kadang diblokir browser—kalau tidak bunyi, tekan tombol MUSIC.
      </div>
    </div>
  </div>

  <!-- Mobile overlay -->
  <div class="overlay" id="overlay"></div>

  <!-- Image modal -->
  <div class="modal" id="imgModal">
    <img id="imgModalEl" alt="preview"/>
  </div>

  <!-- Public Profile modal -->
  <div class="pmodal" id="pModal">
    <div class="pcard">
      <div class="phead">
        <div class="t">Public Profile</div>
        <button class="xbtn" id="pClose"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="pbody">
        <div class="pava" id="pAva">
          <img id="pAvaImg" alt="p"/>
          <div id="pAvaIn">??</div>
        </div>
        <div class="pinfo">
          <div class="pname" id="pName">-</div>
          <div class="pline">
            <span class="pill" id="pStatus"><span class="dot off"></span><strong>OFFLINE</strong></span>
            <span class="pill"><i class="fa-solid fa-user-shield"></i><strong id="pRole">USER</strong></span>
          </div>
        </div>
      </div>
      <div class="pbio" id="pBio">bio: -</div>
      <div class="pacts">
        <button class="btn" id="pDM"><i class="fa-solid fa-lock"></i> DM</button>
        <button class="btn" id="pView"><i class="fa-solid fa-eye"></i> View</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <strong id="toastTitle">DM</strong>
    <small id="toastBody">message</small>
  </div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="profile-top">
          <div class="avatar" id="meAvatar" title="Edit profile">
            <img id="meAvatarImg" alt="me"/>
            <div class="initials" id="meInitials">ME</div>
          </div>
          <div class="me-info">
            <div class="me-name" id="meName">Loading...</div>
            <div class="me-bio" id="meBio">—</div>
            <div class="me-sub">
              <span class="pill" id="connPillSide"><span class="dot off" id="connDot"></span><strong id="connText">OFFLINE</strong></span>
              <span class="pill"><i class="fa-solid fa-user-shield"></i><strong id="meRole">USER</strong></span>
            </div>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn" id="btnEdit"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
          <button class="btn danger" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>

      <div class="mini-panel">
        <div class="mini-row">
          <div class="mini-title"><i class="fa-solid fa-users"></i> Online</div>
          <div class="mini-badge" id="onlineCount">0</div>
        </div>

        <button class="music-btn" id="musicBtn">
          <span class="music-dot" id="musicDot"></span>
          <span id="musicText">MUSIC OFF</span>
        </button>
      </div>

      <div class="section-header">
        <span>Users (History)</span>
        <span id="usersCount">0</span>
      </div>
      <div class="users-list" id="userList"></div>
    </aside>

    <!-- CHAT -->
    <main class="chat">
      <header class="chat-header">
        <div class="left-head">
          <button class="hamburger" id="hamburger" aria-label="menu">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div class="brand">
            <h1>LIVE CHAT</h1>
            <span class="badge-prem">ULTRA</span>
            <span class="mode-pill" id="modePill">PUBLIC</span>
          </div>
        </div>

        <div class="right-head">
          <div class="net">
            <span class="sig mid" id="sig">
              <span class="bar b1"></span><span class="bar b2"></span><span class="bar b3"></span><span class="bar b4"></span>
            </span>
            <span><strong id="pingMs">--</strong> ms</span>
          </div>
        </div>
      </header>

      <section class="messages" id="messages">
        <div class="sys" id="welcome">
          <i class="fa-solid fa-circle-notch fa-spin"></i>
          Waiting for login...
        </div>
      </section>

      <footer class="input">
        <div class="wrap">
          <div class="replying" id="replying">
            <i class="fa-solid fa-reply"></i>
            <div style="min-width:0;flex:1">
              <div><strong id="replyTo">User</strong></div>
              <div style="color:var(--muted2);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="replyPreview">preview</div>
            </div>
            <i class="fa-solid fa-xmark x" id="replyCancel"></i>
          </div>

          <div class="file-preview" id="filePreview">
            <i class="fa-solid fa-paperclip"></i>
            <span id="fileName" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;">file</span>
            <i class="fa-solid fa-xmark remove" id="fileRemove"></i>
          </div>

          <textarea id="msgInput" placeholder="Type message..." disabled></textarea>
        </div>

        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none"/>
        <div class="btns">
          <button class="icon" id="attachBtn" disabled><i class="fa-solid fa-paperclip"></i></button>
          <button class="icon send" id="sendBtn" disabled><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </footer>
    </main>
  </div>

  <!-- Audio -->
  <audio id="bgm" preload="auto" loop>
    <source src="https://files.catbox.moe/wlny2m.mp3" type="audio/mpeg"/>
  </audio>

  <!-- SET SOCKET URL -->
  <script>
    window.SOCKET_URL = "https://livechatscarrydeath.raraaprivate.my.id";
  </script>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
    /* =========================
      STORAGE KEYS
    ========================== */
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;

    const KEY_USER = "lc_username";
    const KEY_PHOTO = "lc_photo";
    const KEY_BIO = "lc_bio";
    const KEY_ROLE = "lc_role"; // keep
    const KEY_MUSIC = "lc_music";

    const els = {
      // gate
      gate: document.getElementById("gate"),
      gateTitle: document.getElementById("gateTitle"),
      gateSub: document.getElementById("gateSub"),
      gateUsername: document.getElementById("gateUsername"),
      gatePhoto: document.getElementById("gatePhoto"),
      gateBio: document.getElementById("gateBio"),
      photoLabel: document.getElementById("photoLabel"),
      gateGo: document.getElementById("gateGo"),
      gateReset: document.getElementById("gateReset"),

      // sidebar
      sidebar: document.getElementById("sidebar"),
      overlay: document.getElementById("overlay"),
      hamburger: document.getElementById("hamburger"),
      meAvatar: document.getElementById("meAvatar"),
      meAvatarImg: document.getElementById("meAvatarImg"),
      meInitials: document.getElementById("meInitials"),
      meName: document.getElementById("meName"),
      meBio: document.getElementById("meBio"),
      meRole: document.getElementById("meRole"),
      btnEdit: document.getElementById("btnEdit"),
      btnLogout: document.getElementById("btnLogout"),
      onlineCount: document.getElementById("onlineCount"),
      usersCount: document.getElementById("usersCount"),
      userList: document.getElementById("userList"),
      connDot: document.getElementById("connDot"),
      connText: document.getElementById("connText"),
      connPillSide: document.getElementById("connPillSide"),

      // chat
      messages: document.getElementById("messages"),
      welcome: document.getElementById("welcome"),
      modePill: document.getElementById("modePill"),
      pingMs: document.getElementById("pingMs"),
      sig: document.getElementById("sig"),

      // input
      msgInput: document.getElementById("msgInput"),
      sendBtn: document.getElementById("sendBtn"),
      attachBtn: document.getElementById("attachBtn"),
      fileInput: document.getElementById("fileInput"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      fileRemove: document.getElementById("fileRemove"),

      replying: document.getElementById("replying"),
      replyTo: document.getElementById("replyTo"),
      replyPreview: document.getElementById("replyPreview"),
      replyCancel: document.getElementById("replyCancel"),

      // modal image
      imgModal: document.getElementById("imgModal"),
      imgModalEl: document.getElementById("imgModalEl"),

      // profile modal
      pModal: document.getElementById("pModal"),
      pClose: document.getElementById("pClose"),
      pAva: document.getElementById("pAva"),
      pAvaImg: document.getElementById("pAvaImg"),
      pAvaIn: document.getElementById("pAvaIn"),
      pName: document.getElementById("pName"),
      pStatus: document.getElementById("pStatus"),
      pRole: document.getElementById("pRole"),
      pBio: document.getElementById("pBio"),
      pDM: document.getElementById("pDM"),
      pView: document.getElementById("pView"),

      // toast
      toast: document.getElementById("toast"),
      toastTitle: document.getElementById("toastTitle"),
      toastBody: document.getElementById("toastBody"),

      // music
      musicBtn: document.getElementById("musicBtn"),
      musicText: document.getElementById("musicText"),
      musicDot: document.getElementById("musicDot"),
      bgm: document.getElementById("bgm"),

      // canvases
      meteorCanvas: document.getElementById("meteorCanvas"),
      orbCanvas: document.getElementById("orbCanvas"),
    };

    /* =========================
      STATE
    ========================== */
    const myUser = {
      username: null,
      photo: null,
      bio: null,
      role: (localStorage.getItem(KEY_ROLE) || "user"),
    };

    let socket = null;
    let connected = false;

    // directory from server (history users)
    let directory = []; // { username, role, photo, bio, lastSeen, isOnline }

    // mode
    let mode = "public"; // "public" | "dm"
    let dmWith = null;

    // reply state
    let replyState = null; // { id, username, preview }

    // file
    let currentFile = null;
    let currentFileData = null;

    // ping
    let pingTimer = null;
    let lastPing = null;
    let pingMs = null;

    // music
    let musicOn = false;

    /* =========================
      UTIL
    ========================== */
    function escapeHtml(t){
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    }

    function initials(name){
      const s = String(name || "").trim();
      if(!s) return "??";
      const parts = s.split(/\s+/).filter(Boolean);
      const a = (parts[0]?.[0] || s[0] || "?").toUpperCase();
      const b = (parts[1]?.[0] || s[1] || "").toUpperCase();
      return (a + b).slice(0,2);
    }

    function validUsername(name){
      const s = String(name || "").trim();
      return s.length >= 3 && s.length <= 32; // bebas karakter
    }

    function setConnUI(isOn){
      els.connDot.classList.toggle("on", !!isOn);
      els.connDot.classList.toggle("off", !isOn);
      els.connText.textContent = isOn ? "ONLINE" : "OFFLINE";
    }

    function applyProfileUI(){
      els.meName.textContent = myUser.username || "Guest";
      els.meBio.textContent = myUser.bio ? myUser.bio : "—";
      els.meRole.textContent = String(myUser.role || "user").toUpperCase();
      els.meInitials.textContent = initials(myUser.username);

      if(myUser.photo){
        els.meAvatarImg.src = myUser.photo;
        els.meAvatarImg.style.display = "block";
        els.meInitials.style.display = "none";
      }else{
        els.meAvatarImg.removeAttribute("src");
        els.meAvatarImg.style.display = "none";
        els.meInitials.style.display = "block";
      }
    }

    function enableInput(on){
      els.msgInput.disabled = !on;
      els.sendBtn.disabled = !on;
      els.attachBtn.disabled = !on;
      if(on) els.msgInput.focus();
    }

    function sidebarOpen(open){
      const show = (open === undefined) ? !els.sidebar.classList.contains("active") : open;
      if(show){
        els.sidebar.classList.add("active");
        els.overlay.classList.add("active");
      }else{
        els.sidebar.classList.remove("active");
        els.overlay.classList.remove("active");
      }
    }

    function setMode(newMode, withUser=null){
      mode = newMode;
      dmWith = withUser;

      if(mode === "public"){
        els.modePill.textContent = "PUBLIC";
        els.messages.innerHTML = "";
        els.messages.appendChild(els.welcome);
        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-comments"></i> Public chat`;
        requestPublicHistory(); // server already sent on login; we keep last loaded
      }else{
        els.modePill.textContent = `DM: ${withUser}`;
        els.messages.innerHTML = "";
        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-lock"></i> DM with ${escapeHtml(withUser)}...`;
        requestDMHistory(withUser);
      }

      clearReply();
    }

    function showToast(title, body){
      els.toastTitle.textContent = title;
      els.toastBody.textContent = body;
      els.toast.classList.add("active");
      setTimeout(()=> els.toast.classList.remove("active"), 2200);
    }

    /* =========================
      GATE (LOGIN/EDIT)
    ========================== */
    function openGate(mode="login"){
      els.gate.classList.add("active");
      if(mode === "edit"){
        els.gateTitle.textContent = "EDIT PROFILE";
        els.gateUsername.value = myUser.username || "";
        els.gateBio.value = myUser.bio || "";
        els.photoLabel.textContent = myUser.photo ? "Ganti foto profil (sudah ada)" : "Upload foto profil (opsional)";
      }else{
        els.gateTitle.textContent = "LOGIN";
        els.gateUsername.value = "";
        els.gateBio.value = "";
        els.photoLabel.textContent = "Upload foto profil (opsional)";
      }
      setTimeout(()=> els.gateUsername.focus(), 60);
    }

    function closeGate(){
      els.gate.classList.remove("active");
    }

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function saveGate(){
      const name = String(els.gateUsername.value || "").trim();
      const bio = String(els.gateBio.value || "").trim().slice(0,120);

      if(!validUsername(name)){
        alert("Username minimal 3 karakter (bebas karakter).");
        return;
      }

      myUser.username = name;
      myUser.bio = bio;

      localStorage.setItem(KEY_USER, name);
      localStorage.setItem(KEY_BIO, bio);

      // photo optional
      if(els.gatePhoto.files && els.gatePhoto.files[0]){
        const f = els.gatePhoto.files[0];
        if(!f.type.startsWith("image/")) return alert("Foto harus gambar.");
        if(f.size > 2*1024*1024) return alert("Foto max 2MB biar ringan.");
        myUser.photo = await fileToBase64(f);
        localStorage.setItem(KEY_PHOTO, myUser.photo);
      }else{
        myUser.photo = localStorage.getItem(KEY_PHOTO) || null;
      }

      applyProfileUI();
      closeGate();

      if(!socket){
        connectSocket();
      }else{
        if(connected){
          socket.emit("chat:updateProfile", { photo: myUser.photo, bio: myUser.bio, role: myUser.role });
          socket.emit("chat:login", { username: myUser.username, role: myUser.role, photo: myUser.photo, bio: myUser.bio });
        }
      }
    }

    function logout(){
      localStorage.removeItem(KEY_USER);
      localStorage.removeItem(KEY_PHOTO);
      localStorage.removeItem(KEY_BIO);

      myUser.username = null;
      myUser.photo = null;
      myUser.bio = null;

      try{ if(socket) socket.disconnect(); }catch(_){}
      socket = null;
      connected = false;

      enableInput(false);
      setConnUI(false);

      els.messages.innerHTML = "";
      els.messages.appendChild(els.welcome);
      els.welcome.style.display = "flex";
      els.welcome.innerHTML = `<i class="fa-solid fa-user-lock"></i> Please login`;

      applyProfileUI();
      sidebarOpen(false);
      openGate("login");
    }

    /* =========================
      MUSIC
    ========================== */
    function setMusicUI(on){
      musicOn = !!on;
      els.musicBtn.classList.toggle("music-on", musicOn);
      els.musicDot.style.opacity = musicOn ? "1" : ".6";
      els.musicText.textContent = musicOn ? "MUSIC ON" : "MUSIC OFF";
      localStorage.setItem(KEY_MUSIC, musicOn ? "1" : "0");
    }

    async function tryPlayMusic(){
      try{
        els.bgm.volume = 0.78;
        await els.bgm.play();
        setMusicUI(true);
      }catch(_){
        setMusicUI(false);
      }
    }

    async function toggleMusic(){
      try{
        if(musicOn){
          els.bgm.pause();
          setMusicUI(false);
        }else{
          await els.bgm.play();
          setMusicUI(true);
        }
      }catch(_){
        alert("Autoplay diblokir browser. Coba klik lagi / unmute device.");
      }
    }

    function installAudioUnlock(){
      const unlock = async () => {
        const wantOn = (localStorage.getItem(KEY_MUSIC) !== "0");
        if(wantOn && !musicOn){
          try{ await els.bgm.play(); setMusicUI(true); }catch(_){}
        }
        window.removeEventListener("touchstart", unlock);
        window.removeEventListener("click", unlock);
      };
      window.addEventListener("touchstart", unlock, { once:true });
      window.addEventListener("click", unlock, { once:true });
    }

    /* =========================
      PROFILE MODAL
    ========================== */
    let pUser = null;

    function openProfile(u){
      pUser = u;
      els.pModal.classList.add("active");

      els.pName.textContent = u.username || "-";
      els.pRole.textContent = String(u.role || "user").toUpperCase();
      els.pBio.textContent = u.bio ? `bio: ${u.bio}` : "bio: —";

      // status pill
      const isOn = !!u.isOnline;
      els.pStatus.innerHTML = `<span class="dot ${isOn ? "on" : "off"}"></span><strong>${isOn ? "ONLINE" : "OFFLINE"}</strong>`;

      // avatar
      els.pAvaIn.textContent = initials(u.username);
      if(u.photo){
        els.pAvaImg.src = u.photo;
        els.pAvaImg.style.display = "block";
        els.pAvaIn.style.display = "none";
      }else{
        els.pAvaImg.removeAttribute("src");
        els.pAvaImg.style.display = "none";
        els.pAvaIn.style.display = "block";
      }

      // DM button
      const isMe = myUser.username && u.username === myUser.username;
      els.pDM.disabled = isMe;
      els.pView.disabled = false;
    }

    function closeProfile(){
      els.pModal.classList.remove("active");
      pUser = null;
    }

    /* =========================
      RENDER USERS LIST (history + status)
    ========================== */
    function renderUsers(){
      els.userList.innerHTML = "";
      els.usersCount.textContent = directory.length;

      const onlineCount = directory.filter(u=>u.isOnline).length;
      els.onlineCount.textContent = onlineCount;

      directory.forEach(u=>{
        const item = document.createElement("div");
        item.className = "user-item";

        const isOn = !!u.isOnline;
        const dot = isOn ? "on" : "off";
        const label = isOn ? "ONLINE" : "OFFLINE";

        item.innerHTML = `
          <div class="u-ava">
            <img alt="u"/>
            <div class="u-in">${escapeHtml(initials(u.username))}</div>
          </div>
          <div class="u-info">
            <div class="u-name">${escapeHtml(u.username || "")}</div>
            <div class="u-sub">
              <span class="dot ${dot}"></span><span>${label}</span>
              <span>•</span>
              <span>${escapeHtml(String(u.role || "user").toUpperCase())}</span>
              <span style="opacity:.7;">• TAP</span>
            </div>
          </div>
        `;

        const img = item.querySelector(".u-ava img");
        const ini = item.querySelector(".u-in");

        if(u.photo){
          img.src = u.photo;
          img.style.display = "block";
          ini.style.display = "none";
        }else{
          img.style.display = "none";
          ini.style.display = "block";
        }

        item.addEventListener("click", ()=>{
          openProfile(u);
        });

        els.userList.appendChild(item);
      });
    }

    /* =========================
      CHAT UI
    ========================== */
    function scrollBottom(){ els.messages.scrollTop = els.messages.scrollHeight; }

    function systemMsg(text){
      const d = document.createElement("div");
      d.className = "sys";
      d.innerHTML = `<i class="fa-solid fa-bolt"></i> ${text}`;
      els.messages.appendChild(d);
      scrollBottom();
      setTimeout(()=> d.remove(), 4500);
    }

    function setReply(msgObj){
      replyState = {
        id: msgObj.id,
        username: msgObj.username || msgObj.from || "user",
        preview: (msgObj.message || (msgObj.image ? "[image]" : "") || "").slice(0, 60)
      };
      els.replyTo.textContent = replyState.username;
      els.replyPreview.textContent = replyState.preview || "-";
      els.replying.classList.add("active");
      els.msgInput.focus();
    }

    function clearReply(){
      replyState = null;
      els.replying.classList.remove("active");
    }

    function findUser(username){
      return directory.find(u => u.username === username) || null;
    }

    function renderMessageCommon({ id, username, role, photo, message, timestamp, reply, image }, own=false){
      const msg = document.createElement("div");
      msg.className = `msg ${own ? "own" : "other"}`;

      const time = new Date(timestamp || Date.now()).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
      const who = username || "-";
      const r = String(role || "user").toUpperCase();

      const ava = document.createElement("div");
      ava.className = "m-ava";
      ava.innerHTML = `<img alt="a"/><div class="in">${escapeHtml(initials(who))}</div>`;
      const avaImg = ava.querySelector("img");
      const avaIn = ava.querySelector(".in");
      if(photo){
        avaImg.src = photo;
        avaImg.style.display = "block";
        avaIn.style.display = "none";
      }else{
        avaImg.style.display = "none";
        avaIn.style.display = "block";
      }

      const wrap = document.createElement("div");
      wrap.className = "m-wrap";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span class="name" data-u="${escapeHtml(who)}">${escapeHtml(who)}</span>
        <span class="role-badge">${escapeHtml(r)}</span>
        <span>${time}</span>
      `;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      // reply block
      let replyHtml = "";
      if(reply && reply.username){
        replyHtml = `
          <div class="reply-box">
            <div><strong>Reply to ${escapeHtml(reply.username)}</strong></div>
            <div class="pv">${escapeHtml(reply.preview || "")}</div>
          </div>
        `;
      }

      const textHtml = message ? escapeHtml(message).replace(/\n/g,"<br>") : "";
      const imgHtml = image ? `<img src="${image}" data-preview="1" alt="image"/>` : "";

      bubble.innerHTML = `${replyHtml}${textHtml}${imgHtml}`;

      const actions = document.createElement("div");
      actions.className = "msg-actions";
      actions.innerHTML = `
        <button class="act"><i class="fa-solid fa-reply"></i> REPLY</button>
        <button class="act"><i class="fa-solid fa-user"></i> PROFILE</button>
        <button class="act"><i class="fa-solid fa-lock"></i> DM</button>
      `;

      // action handlers
      const [btnReply, btnProfile, btnDM] = actions.querySelectorAll("button.act");

      btnReply.addEventListener("click", ()=> {
        setReply({ id, username: who, message: (message || (image ? "[image]" : "")) });
      });

      btnProfile.addEventListener("click", ()=> {
        const u = findUser(who) || { username: who, role: role, photo: photo, bio: "", isOnline: true };
        openProfile(u);
      });

      btnDM.addEventListener("click", ()=> {
        if(!myUser.username || who === myUser.username) return;
        setMode("dm", who);
      });

      // click username -> profile
      meta.querySelector(".name").addEventListener("click", ()=>{
        const u = findUser(who) || { username: who, role: role, photo: photo, bio: "", isOnline: true };
        openProfile(u);
      });

      wrap.appendChild(meta);
      wrap.appendChild(bubble);
      wrap.appendChild(actions);

      msg.appendChild(ava);
      msg.appendChild(wrap);

      els.messages.appendChild(msg);

      const im = bubble.querySelector('img[data-preview="1"]');
      if(im){
        im.addEventListener("click", ()=>{
          els.imgModalEl.src = image;
          els.imgModal.classList.add("active");
        });
      }
    }

    function addPublicMessage(m){
      const own = (m.username === myUser.username);
      renderMessageCommon({
        id: m.id,
        username: m.username,
        role: m.role,
        photo: m.photo,
        message: m.message,
        timestamp: m.timestamp,
        reply: m.reply,
        image: m.image
      }, own);
    }

    function addDMMessage(m){
      const own = (m.from === myUser.username);
      const otherName = own ? m.to : m.from;

      renderMessageCommon({
        id: m.id,
        username: otherName,
        role: m.role,
        photo: m.photo,
        message: m.message,
        timestamp: m.timestamp,
        reply: m.reply,
        image: null
      }, own);
    }

    /* =========================
      SEND + FILE
    ========================== */
    function handleFileSelect(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      const ok = f.type.startsWith("image/") || f.type.startsWith("video/");
      if(!ok) return alert("Hanya boleh image/video");
      if(f.size > 10*1024*1024) return alert("Max 10MB");

      currentFile = f;
      els.filePreview.classList.add("active");
      els.fileName.textContent = f.name;

      const r = new FileReader();
      r.onload = (ev)=> currentFileData = ev.target.result;
      r.readAsDataURL(f);
    }
    function clearFile(){
      currentFile = null;
      currentFileData = null;
      els.filePreview.classList.remove("active");
      els.fileInput.value = "";
    }

    function send(){
      if(!socket || !connected) return;

      const text = String(els.msgInput.value || "").trim();
      if(!text && !currentFile) return;

      const payloadReply = replyState ? { ...replyState } : null;

      if(mode === "dm" && dmWith){
        socket.emit("chat:dm", {
          to: dmWith,
          message: text,
          reply: payloadReply
        });
      }else{
        if(currentFile){
          socket.emit("chat:image", {
            image: currentFileData,
            message: text,
            reply: payloadReply
          });
          clearFile();
        }else{
          socket.emit("chat:message", {
            message: text,
            reply: payloadReply
          });
        }
      }

      els.msgInput.value = "";
      els.msgInput.style.height = "auto";
      clearReply();
    }

    /* =========================
      SOCKET
    ========================== */
    function requestDMHistory(withUser){
      if(!socket) return;
      socket.emit("chat:dmHistory", { with: withUser });
    }
    function requestPublicHistory(){
      // history already managed by server on connect, no need extra
    }

    function connectSocket(){
      if(!window.io){
        setConnUI(false);
        return;
      }

      socket = io(SOCKET_URL, { transports:["websocket","polling"] });

      socket.on("connect", ()=>{
        connected = true;
        setConnUI(true);
        enableInput(true);

        socket.emit("chat:login", {
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo,
          bio: myUser.bio
        });

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-check"></i> Connected as ${escapeHtml(myUser.username)}`;
        setTimeout(()=> els.welcome.style.display = "none", 1300);

        startPing();
      });

      socket.on("disconnect", ()=>{
        connected = false;
        setConnUI(false);
        enableInput(false);
        stopPing();
        systemMsg("Disconnected");
      });

      socket.on("chat:directory", (data)=>{
        const users = Array.isArray(data?.users) ? data.users : [];
        directory = users;

        renderUsers();
      });

      socket.on("chat:history", (history)=>{
        // only load into public mode view
        if(mode !== "public") return;
        els.messages.innerHTML = "";
        (history || []).forEach(m => addPublicMessage(m));
        scrollBottom();
      });

      socket.on("chat:newMessage", (m)=>{
        if(mode !== "public") return;
        addPublicMessage(m);
        scrollBottom();
      });

      socket.on("chat:image", (m)=>{
        if(mode !== "public") return;
        addPublicMessage(m);
        scrollBottom();
      });

      socket.on("chat:userJoin", (d)=>{
        systemMsg(`${escapeHtml(d?.username || "someone")} joined`);
      });

      socket.on("chat:userLeave", (d)=>{
        systemMsg(`${escapeHtml(d?.username || "someone")} left`);
      });

      // DM events
      socket.on("chat:dmHistory", (data)=>{
        if(mode !== "dm") return;
        if(data?.with !== dmWith) return;

        els.messages.innerHTML = "";
        (data?.history || []).forEach(m => addDMMessage(m));
        scrollBottom();

        els.welcome.style.display = "none";
      });

      socket.on("chat:dm", (m)=>{
        // if not currently in that dm, toast notify
        const other = (m.from === myUser.username) ? m.to : m.from;
        const isInThisDM = (mode === "dm" && dmWith === other);

        if(isInThisDM){
          addDMMessage(m);
          scrollBottom();
        }else{
          showToast(`DM dari ${other}`, (m.message || "").slice(0,80));
        }
      });

      // pong -> ping calc
      socket.on("app:pong", (d)=>{
        const now = Date.now();
        const t0 = d?.t0 || now;
        pingMs = Math.max(0, now - t0);
        els.pingMs.textContent = String(pingMs);

        els.sig.classList.remove("good","mid","bad");
        if(pingMs <= 90) els.sig.classList.add("good");
        else if(pingMs <= 180) els.sig.classList.add("mid");
        else els.sig.classList.add("bad");
      });
    }

    function startPing(){
      stopPing();
      pingTimer = setInterval(()=>{
        if(!socket || !connected) return;
        const t0 = Date.now();
        socket.emit("app:ping", { t0 });
      }, 1200);
    }
    function stopPing(){
      if(pingTimer) clearInterval(pingTimer);
      pingTimer = null;
      els.pingMs.textContent = "--";
      els.sig.classList.remove("good","mid","bad");
      els.sig.classList.add("mid");
    }

    /* =========================
      BACKGROUND: meteors + orbs
    ========================== */
    function startHueShift(){
      let t = 0;
      function tick(){
        t += 0.12;
        document.documentElement.style.setProperty("--hue", (t % 360) + "deg");
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function setupMeteors(){
      const c = els.meteorCanvas;
      const ctx = c.getContext("2d", { alpha:true });

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        c.width = Math.floor(window.innerWidth * dpr);
        c.height = Math.floor(window.innerHeight * dpr);
        c.style.width = window.innerWidth + "px";
        c.style.height = window.innerHeight + "px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      const stars = [];
      const meteors = [];
      const rand = (a,b)=> Math.random()*(b-a)+a;

      const STAR_COUNT = Math.min(220, Math.floor((window.innerWidth*window.innerHeight)/7000));
      for(let i=0;i<STAR_COUNT;i++){
        stars.push({ x: rand(0, innerWidth), y: rand(0, innerHeight), r: rand(.4,1.3), a: rand(.12,.85), tw: rand(.002,.009) });
      }

      function spawnMeteor(){
        const startX = rand(-200, innerWidth*0.85);
        const startY = rand(-120, innerHeight*0.35);
        const len = rand(140, 320);
        const speed = rand(2.0, 3.7);
        const angle = rand(0.68, 0.86);
        meteors.push({
          x:startX, y:startY,
          vx: Math.cos(angle)*speed,
          vy: Math.sin(angle)*speed,
          len,
          life: rand(180, 320),
          w: rand(1.1, 2.3),
          glow: rand(.28, .65),
        });
        if(meteors.length>18) meteors.shift();
      }

      let tick = 0;

      function draw(){
        tick++;
        ctx.clearRect(0,0,innerWidth,innerHeight);

        // stars
        for(const s of stars){
          s.a += (Math.random()<0.5?-1:1)*s.tw;
          s.a = Math.max(0.08, Math.min(0.95, s.a));
          ctx.beginPath();
          ctx.fillStyle = `rgba(180,220,255,${s.a})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();
        }

        // meteors
        if(tick % 22 === 0 && Math.random() < 0.65) spawnMeteor();

        for(let i=meteors.length-1;i>=0;i--){
          const m = meteors[i];
          m.x += m.vx; m.y += m.vy; m.life -= 1;

          const dx = -m.vx, dy = -m.vy;
          const mag = Math.hypot(dx,dy) || 1;
          const nx = dx/mag, ny = dy/mag;

          const tx = m.x + nx*m.len;
          const ty = m.y + ny*m.len;

          const grad = ctx.createLinearGradient(m.x, m.y, tx, ty);
          grad.addColorStop(0, `rgba(125,211,252,${0.90*m.glow})`);
          grad.addColorStop(0.25, `rgba(167,139,250,${0.62*m.glow})`);
          grad.addColorStop(0.50, `rgba(52,211,153,${0.44*m.glow})`);
          grad.addColorStop(1, `rgba(125,211,252,0)`);

          ctx.lineWidth = m.w;
          ctx.strokeStyle = grad;
          ctx.beginPath();
          ctx.moveTo(m.x, m.y);
          ctx.lineTo(tx, ty);
          ctx.stroke();

          ctx.beginPath();
          ctx.fillStyle = `rgba(200,240,255,${0.36*m.glow})`;
          ctx.arc(m.x, m.y, 3.0, 0, Math.PI*2);
          ctx.fill();

          if(m.life<=0 || m.x>innerWidth+500 || m.y>innerHeight+500) meteors.splice(i,1);
        }

        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);
    }

    function setupOrbs(){
      const c = els.orbCanvas;
      const ctx = c.getContext("2d", { alpha:true });

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        c.width = Math.floor(window.innerWidth * dpr);
        c.height = Math.floor(window.innerHeight * dpr);
        c.style.width = window.innerWidth + "px";
        c.style.height = window.innerHeight + "px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      const rand = (a,b)=> Math.random()*(b-a)+a;
      const orbs = [];
      const N = Math.min(16, Math.max(9, Math.floor(innerWidth/120)));

      for(let i=0;i<N;i++){
        orbs.push({
          x: rand(0, innerWidth),
          y: rand(0, innerHeight),
          r: rand(60, 140),
          vx: rand(-0.25, 0.25),
          vy: rand(-0.18, 0.18),
          ph: rand(0, 6.28),
          sp: rand(0.004, 0.012),
        });
      }

      function draw(){
        ctx.clearRect(0,0,innerWidth,innerHeight);

        for(const o of orbs){
          o.x += o.vx; o.y += o.vy;
          o.ph += o.sp;

          // bounce
          if(o.x < -200) o.x = innerWidth + 200;
          if(o.x > innerWidth + 200) o.x = -200;
          if(o.y < -200) o.y = innerHeight + 200;
          if(o.y > innerHeight + 200) o.y = -200;

          const rr = o.r * (0.80 + 0.20*Math.sin(o.ph));
          const g = ctx.createRadialGradient(o.x, o.y, 0, o.x, o.y, rr);
          g.addColorStop(0, `rgba(125,211,252,0.16)`);
          g.addColorStop(0.45, `rgba(167,139,250,0.10)`);
          g.addColorStop(0.75, `rgba(52,211,153,0.08)`);
          g.addColorStop(1, `rgba(0,0,0,0)`);

          ctx.fillStyle = g;
          ctx.beginPath();
          ctx.arc(o.x, o.y, rr, 0, Math.PI*2);
          ctx.fill();
        }

        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);
    }

    /* =========================
      INIT
    ========================== */
    function init(){
      startHueShift();
      setupOrbs();
      setupMeteors();

      // autoresize textarea
      els.msgInput.addEventListener("input", function(){
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      // sidebar
      els.hamburger.addEventListener("click", ()=> sidebarOpen(true));
      els.overlay.addEventListener("click", ()=> sidebarOpen(false));

      // modals
      els.imgModal.addEventListener("click", ()=> els.imgModal.classList.remove("active"));
      els.pClose.addEventListener("click", closeProfile);
      els.pModal.addEventListener("click", (e)=>{ if(e.target === els.pModal) closeProfile(); });

      // profile modal actions
      els.pDM.addEventListener("click", ()=>{
        if(!pUser || !pUser.username || pUser.username === myUser.username) return;
        closeProfile();
        sidebarOpen(false);
        setMode("dm", pUser.username);
      });
      els.pView.addEventListener("click", ()=>{
        // just close (view already shown)
        closeProfile();
      });

      // actions
      els.meAvatar.addEventListener("click", ()=> openGate("edit"));
      els.btnEdit.addEventListener("click", ()=> openGate("edit"));
      els.btnLogout.addEventListener("click", logout);

      // reply cancel
      els.replyCancel.addEventListener("click", clearReply);

      // attach + file
      els.attachBtn.addEventListener("click", ()=> els.fileInput.click());
      els.fileInput.addEventListener("change", handleFileSelect);
      els.fileRemove.addEventListener("click", clearFile);

      // send
      els.sendBtn.addEventListener("click", send);
      els.msgInput.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          send();
        }
      });

      // music
      els.musicBtn.addEventListener("click", toggleMusic);
      installAudioUnlock();
      const wantMusic = (localStorage.getItem(KEY_MUSIC) !== "0");
      if(wantMusic) tryPlayMusic(); else setMusicUI(false);

      // gate events
      els.gateGo.addEventListener("click", saveGate);
      els.gateUsername.addEventListener("keydown", (e)=>{ if(e.key==="Enter") saveGate(); });
      els.gateReset.addEventListener("click", ()=>{
        localStorage.removeItem(KEY_USER);
        localStorage.removeItem(KEY_PHOTO);
        localStorage.removeItem(KEY_BIO);
        els.gateUsername.value = "";
        els.gateBio.value = "";
        els.gatePhoto.value = "";
        els.photoLabel.textContent = "Upload foto profil (opsional)";
        alert("Data login dihapus. Isi lagi ya.");
      });
      els.gatePhoto.addEventListener("change", ()=>{
        const f = els.gatePhoto.files && els.gatePhoto.files[0];
        if(!f) return;
        els.photoLabel.textContent = `Foto: ${f.name}`;
      });

      // restore profile
      const savedName = (localStorage.getItem(KEY_USER) || "").trim();
      const savedPhoto = (localStorage.getItem(KEY_PHOTO) || "").trim();
      const savedBio = (localStorage.getItem(KEY_BIO) || "").trim();

      myUser.photo = savedPhoto || null;
      myUser.bio = savedBio || "";

      if(validUsername(savedName)){
        myUser.username = savedName;
        applyProfileUI();
        setConnUI(false);
        connectSocket();
        setMode("public");
      }else{
        myUser.username = null;
        applyProfileUI();
        enableInput(false);
        setConnUI(false);
        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-user-lock"></i> Please login`;
        openGate("login");
      }

      // back/esc to close sidebar/profile
      document.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          els.imgModal.classList.remove("active");
          closeProfile();
          sidebarOpen(false);
        }
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
