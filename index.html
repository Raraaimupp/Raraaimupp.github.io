<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#070a12" />
  <title>LIVE CHAT | ULTRA</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#070a12;
      --txt:#eaf2ff;
      --mut: rgba(234,242,255,.62);
      --mut2: rgba(234,242,255,.38);

      --card: rgba(10,14,22,.55);
      --card2: rgba(6,10,18,.78);
      --stroke: rgba(170,220,255,.14);
      --stroke2: rgba(255,255,255,.10);

      --good:#4ade80;
      --bad:#fb7185;
      --warn:#facc15;

      --H:'Orbitron',sans-serif;
      --B:'Share Tech Mono',monospace;
    }

    *{box-sizing:border-box; margin:0; padding:0; font-family:var(--B); -webkit-tap-highlight-color:transparent;}
    html,body{height:100%;}
    body{
      background: radial-gradient(1200px 700px at 10% 0%, rgba(120,190,255,.10), transparent 62%),
                  radial-gradient(900px 900px at 90% 10%, rgba(255,130,230,.10), transparent 60%),
                  linear-gradient(180deg, #050713, #070a12 45%, #050713);
      color:var(--txt);
      overflow:hidden;
    }

    /* ====== LAYER: Colorful animated overlay ====== */
    .hue-layer{
      position:fixed; inset:-20%;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(700px 500px at 20% 20%, rgba(0,255,255,.10), transparent 60%),
        radial-gradient(650px 550px at 80% 30%, rgba(255,0,200,.10), transparent 60%),
        radial-gradient(700px 600px at 55% 80%, rgba(0,255,160,.08), transparent 62%),
        radial-gradient(900px 700px at 40% 55%, rgba(140,120,255,.08), transparent 65%);
      filter: blur(10px) saturate(1.2);
      animation: hue 12s linear infinite;
      opacity:.9;
    }
    @keyframes hue { from{ filter: blur(10px) hue-rotate(0deg) saturate(1.25);} to{ filter: blur(10px) hue-rotate(360deg) saturate(1.25);} }

    /* ====== Background canvas random shapes ====== */
    .bg-wrap{ position:fixed; inset:0; z-index:-2; pointer-events:none; }
    canvas#fx{ width:100%; height:100%; display:block; }

    /* ====== App layout ====== */
    .app{
      height:100dvh;
      width:100%;
      max-width:1600px;
      margin:0 auto;
      display:flex;
      position:relative;
    }

    /* ====== Sidebar ====== */
    .sidebar{
      width:320px;
      flex-shrink:0;
      border-right:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,14,22,.70), rgba(10,14,22,.30));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
      z-index:50;
      transition: transform .28s cubic-bezier(.4,0,.2,1);
      box-shadow: 18px 0 80px rgba(0,0,0,.45);
    }

    /* profile card */
    .user-card{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,22,34,.75), rgba(10,14,22,.25));
    }
    .profile-top{display:flex; gap:12px; align-items:center;}
    .avatar{
      width:68px;height:68px;border-radius:18px;
      border:1px solid rgba(180,230,255,.25);
      background: rgba(0,0,0,.28);
      box-shadow: 0 18px 55px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.06) inset;
      overflow:hidden; flex-shrink:0;
      display:flex; align-items:center; justify-content:center;
      position:relative; cursor:pointer;
    }
    .avatar::after{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(0,255,255,.12), rgba(255,0,200,.12), rgba(0,255,160,.12));
      filter: blur(14px);
      opacity:.75;
      animation: hue 9s linear infinite;
      z-index:-1;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:none;}
    .avatar .ini{font-family:var(--H); font-weight:800; letter-spacing:1px; opacity:.9;}

    .me-info{min-width:0; flex:1;}
    .me-name{font-family:var(--H); letter-spacing:1.5px; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .me-bio{margin-top:6px; color:var(--mut); font-size:12px; line-height:1.3; max-height:32px; overflow:hidden; text-overflow:ellipsis;}
    .row-pills{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color:var(--mut);
      font-size:10px; letter-spacing:1.4px; text-transform:uppercase;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%; background:var(--warn); box-shadow:0 0 12px rgba(250,204,21,.32);}
    .dot.on{background:var(--good); box-shadow:0 0 12px rgba(74,222,128,.32);}
    .dot.off{background:var(--bad); box-shadow:0 0 12px rgba(251,113,133,.32);}

    .actions{margin-top:12px; display:flex; gap:10px;}
    .btn{
      flex:1;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(180,230,255,.16);
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(0,0,0,.16));
      color:var(--txt);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      font-family:var(--H);
      letter-spacing:1.8px;
      text-transform:uppercase;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(0,255,255,.22); filter:saturate(1.15);}
    .btn.danger{border-color: rgba(251,113,133,.18);}
    .btn.danger:hover{border-color: rgba(251,113,133,.30);}

    /* online + music */
    .mini-panel{
      padding:14px 18px;
      border-bottom:1px solid var(--stroke);
      display:flex; flex-direction:column; gap:10px;
      background: linear-gradient(180deg, rgba(8,12,20,.35), rgba(8,12,20,.12));
    }
    .mini-row{display:flex; justify-content:space-between; align-items:center; gap:12px;}
    .mini-title{font-family:var(--H); letter-spacing:1.6px; font-size:11px; color:var(--mut); text-transform:uppercase;}
    .mini-value{
      min-width:56px;
      text-align:center;
      font-family:var(--H);
      letter-spacing:1.4px;
      font-size:11px;
      color:var(--txt);
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
    }

    .music-btn{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(170,220,255,.16);
      background: linear-gradient(135deg, rgba(0,255,255,.12), rgba(255,0,200,.10), rgba(0,255,160,.10));
      color:var(--txt);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      font-family:var(--H);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:11px;
      user-select:none;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .music-btn::after{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(0,255,255,.18), rgba(255,0,200,.18), rgba(0,255,160,.18));
      filter: blur(16px);
      opacity:.7;
      animation: hue 8s linear infinite;
      pointer-events:none;
    }
    .music-btn > *{ position:relative; z-index:2; }
    .m-dot{width:9px;height:9px;border-radius:50%; background: rgba(255,255,255,.25); box-shadow:0 0 14px rgba(0,255,255,.18);}
    .music-on .m-dot{background:var(--good); box-shadow:0 0 14px rgba(74,222,128,.35);}
    .music-off .m-dot{background: rgba(255,255,255,.22);}

    /* user list */
    .list-wrap{flex:1; min-height:0; display:flex; flex-direction:column;}
    .section-header{
      padding:12px 18px;
      border-bottom:1px solid var(--stroke);
      display:flex; justify-content:space-between; align-items:center;
      color:var(--mut);
      font-family:var(--H);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:11px;
    }
    .users{flex:1; min-height:0; overflow:auto; padding:10px 12px;}
    .u{
      display:flex; align-items:center; gap:12px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid transparent;
      background: rgba(0,0,0,.10);
      margin-bottom:8px;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      position:relative;
      overflow:hidden;
    }
    .u:hover{transform: translateY(-1px); border-color: rgba(0,255,255,.18); background: rgba(0,0,0,.16);}
    .u::after{
      content:""; position:absolute; inset:-2px;
      background: radial-gradient(300px 120px at 20% 20%, rgba(0,255,255,.12), transparent 60%),
                  radial-gradient(300px 120px at 80% 50%, rgba(255,0,200,.10), transparent 60%);
      filter: blur(10px);
      opacity:.35;
      pointer-events:none;
      animation: hue 10s linear infinite;
    }
    .u > *{ position:relative; z-index:2; }

    .u-ava{
      width:44px;height:44px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      flex-shrink:0;
      position:relative;
    }
    .u-ava img{width:100%;height:100%;object-fit:cover;display:none;}
    .u-ava .ini{font-family:var(--H); font-size:12px; letter-spacing:1px;}
    .u-info{min-width:0; flex:1;}
    .u-name{font-size:13px; color:var(--txt); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .u-sub{margin-top:2px; display:flex; gap:10px; align-items:center; color:var(--mut2); font-size:10px; letter-spacing:1.2px; text-transform:uppercase;}
    .status{
      display:inline-flex; align-items:center; gap:8px;
    }
    .s-dot{width:8px;height:8px;border-radius:50%;}
    .s-dot.on{background:var(--good); box-shadow:0 0 10px rgba(74,222,128,.25);}
    .s-dot.off{background:var(--bad); box-shadow:0 0 10px rgba(251,113,133,.22);}
    .badgeNew{
      margin-left:auto;
      min-width:22px;
      height:22px;
      padding:0 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.24);
      display:none;
      align-items:center;
      justify-content:center;
      font-family:var(--H);
      font-size:10px;
      letter-spacing:1px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .badgeNew.on{display:flex;}

    /* ====== Chat area ====== */
    .chat{flex:1; min-width:0; display:flex; flex-direction:column; position:relative;}

    .chat-header{
      height:64px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,22,34,.62), rgba(10,14,22,.22));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      gap:10px;
      z-index:10;
    }

    /* PUBLIC header left */
    .left-head{display:flex; align-items:center; gap:12px; min-width:0;}
    .hamburger{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .hamburger:hover{transform: translateY(-1px); border-color: rgba(0,255,255,.18);}

    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .brand h1{font-family:var(--H); font-size:15px; letter-spacing:2px; text-transform:uppercase; white-space:nowrap;}
    .badge-prem{
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(0,255,255,.16);
      background: linear-gradient(135deg, rgba(0,255,255,.10), rgba(255,0,200,.08), rgba(0,255,160,.08));
      font-family:var(--H);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .mode-pill{
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      font-family:var(--H);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--mut);
      white-space:nowrap;
    }

    /* ===== DM header (Telegram-like) ===== */
    .dm-head{
      flex:1;
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .dm-back{
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color:var(--txt);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      transition: transform .15s ease, border-color .15s ease;
      flex-shrink:0;
    }
    .dm-back:hover{transform: translateY(-1px); border-color: rgba(0,255,255,.18);}

    .dm-title{min-width:0; flex:1; display:flex; flex-direction:column; gap:4px;}
    .dm-name{
      font-family:var(--H);
      letter-spacing:1.5px;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dm-sub{
      font-size:11px;
      color: var(--mut);
      display:flex;
      align-items:center;
      gap:8px;
      letter-spacing:1.2px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dm-sub .tinyDot{width:8px;height:8px;border-radius:50%;}
    .dm-sub .tinyDot.on{background:var(--good); box-shadow:0 0 12px rgba(74,222,128,.30);}
    .dm-sub .tinyDot.off{background:var(--bad); box-shadow:0 0 12px rgba(251,113,133,.25);}

    .dm-avatar{
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      position:relative;
      flex-shrink:0;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .dm-avatar img{width:100%;height:100%;object-fit:cover;display:none;}
    .dm-avatar .ini{font-family:var(--H); font-size:12px; letter-spacing:1px; opacity:.95;}

    /* Net/ping on right */
    .net{
      display:flex; align-items:center; gap:10px; flex-shrink:0;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      color: var(--mut);
      font-family:var(--H);
      letter-spacing:1.2px;
      text-transform:uppercase;
      font-size:10px;
      min-width:90px;
      justify-content:center;
    }
    .sig{display:inline-flex; gap:3px; align-items:flex-end;}
    .bar{width:4px; border-radius:3px; background: rgba(0,255,255,.22); box-shadow:0 0 10px rgba(0,255,255,.12);}
    .b1{height:6px}.b2{height:10px}.b3{height:14px}.b4{height:18px}
    .sig.low .bar{background: rgba(251,113,133,.22); box-shadow:0 0 10px rgba(251,113,133,.12);}
    .sig.mid .bar{background: rgba(250,204,21,.22); box-shadow:0 0 10px rgba(250,204,21,.12);}
    .sig.high .bar{background: rgba(74,222,128,.22); box-shadow:0 0 10px rgba(74,222,128,.12);}

    /* messages */
    .msgs{
      flex:1; min-height:0; overflow:auto;
      padding:16px;
      display:flex; flex-direction:column; gap:12px;
    }

    .sys{
      align-self:center;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color:var(--mut);
      font-size:11px;
      letter-spacing:1.2px;
      text-transform:uppercase;
      display:flex; align-items:center; gap:10px;
      text-align:center;
      max-width:92%;
    }

    .msg{
      display:flex;
      gap:10px;
      max-width:88%;
      animation: pop .16s ease;
    }
    @keyframes pop{from{transform:translateY(6px);opacity:0}to{transform:translateY(0);opacity:1}}
    .msg.own{align-self:flex-end; flex-direction:row-reverse;}
    .msg .a{
      width:34px;height:34px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      flex-shrink:0;
      margin-top:2px;
    }
    .msg .a img{width:100%;height:100%;object-fit:cover;display:none;}
    .msg .a .ini{font-family:var(--H); font-size:10px; letter-spacing:1px;}

    .bubble{
      border-radius:18px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      box-shadow: 0 16px 50px rgba(0,0,0,.28);
      position:relative;
      overflow:hidden;
      min-width:0;
    }
    .msg.own .bubble{
      background: linear-gradient(135deg, rgba(0,255,255,.12), rgba(255,0,200,.10), rgba(0,255,160,.10));
      border-color: rgba(170,220,255,.14);
    }
    .bubble::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(280px 120px at 20% 0%, rgba(0,255,255,.12), transparent 60%),
                  radial-gradient(280px 120px at 80% 20%, rgba(255,0,200,.10), transparent 60%);
      filter: blur(12px);
      opacity:.35;
      pointer-events:none;
      animation:hue 10s linear infinite;
    }
    .bubble > *{ position:relative; z-index:2; }

    .topline{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .name{
      font-family:var(--H);
      letter-spacing:1.4px;
      font-size:11px;
      color: var(--txt);
      opacity:.92;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:70%;
    }
    .time{font-size:10px; color:var(--mut2); letter-spacing:1.2px; text-transform:uppercase; white-space:nowrap;}
    .txt{font-size:14px; line-height:1.55; color:var(--txt); word-break:break-word;}
    .replyBox{
      border-left:3px solid rgba(0,255,255,.22);
      padding:8px 10px;
      border-radius:12px;
      background: rgba(0,0,0,.22);
      margin-bottom:10px;
      color: var(--mut);
      font-size:12px;
      overflow:hidden;
    }
    .replyBox .rName{font-family:var(--H); letter-spacing:1px; color:var(--txt); font-size:11px; margin-bottom:4px;}
    .replyBox .rText{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:.9}

    .media{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      max-width:100%;
    }
    .media img, .media video{display:block; width:100%; height:auto;}
    .media audio{width:100%;}

    .quick{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .qbtn{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--mut);
      cursor:pointer;
      font-family:var(--H);
      font-size:10px;
      letter-spacing:1.6px;
      text-transform:uppercase;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .15s ease, border-color .15s ease;
    }
    .qbtn:hover{transform: translateY(-1px); border-color: rgba(0,255,255,.18);}

    /* input */
    .input{
      border-top:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,14,22,.20), rgba(16,22,34,.55));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:12px 12px;
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .wrap{flex:1; min-width:0; display:flex; flex-direction:column; gap:8px;}
    .preview{
      display:none;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: var(--mut);
      font-size:12px;
      align-items:center;
      gap:10px;
    }
    .preview.on{display:flex;}
    .preview .x{margin-left:auto; cursor:pointer; opacity:.85;}

    .replyPreview{
      display:none;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(0,255,255,.16);
      background: rgba(0,0,0,.20);
      color: var(--mut);
      font-size:12px;
      line-height:1.35;
    }
    .replyPreview.on{display:flex; gap:10px; align-items:flex-start;}
    .replyPreview .x{margin-left:auto; cursor:pointer; opacity:.85;}

    textarea{
      width:100%;
      min-height:54px;
      max-height:130px;
      resize:none;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.32);
      color: var(--txt);
      outline:none;
      font-size:14px;
      transition: border-color .15s ease, background .15s ease;
    }
    textarea:focus{border-color: rgba(0,255,255,.18); background: rgba(0,0,0,.38);}

    .btns{display:flex; gap:10px; flex-shrink:0;}
    .icon{
      width:54px;height:54px;border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--txt);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .icon:hover{transform: translateY(-1px); border-color: rgba(0,255,255,.18);}
    .send{
      background: linear-gradient(135deg, rgba(0,255,255,.18), rgba(255,0,200,.14), rgba(0,255,160,.14));
      border-color: rgba(170,220,255,.16);
    }
    .icon::after{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(0,255,255,.16), rgba(255,0,200,.14), rgba(0,255,160,.14));
      filter: blur(16px);
      opacity:.55;
      animation: hue 8s linear infinite;
      pointer-events:none;
    }
    .icon > *{position:relative; z-index:2;}
    .disabled{opacity:.45; cursor:not-allowed; transform:none !important;}

    /* typing */
    .typing{
      height:18px;
      padding:0 16px 10px;
      color: var(--mut2);
      font-size:11px;
      display:none;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .typing .dots span{
      width:4px;height:4px;border-radius:999px;
      background: rgba(234,242,255,.45);
      display:inline-block;
      animation: bounce 1.2s infinite;
      margin-right:3px;
    }
    .typing .dots span:nth-child(2){animation-delay:.15s}
    .typing .dots span:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:scale(.2);opacity:.4}40%{transform:scale(1);opacity:1}}

    /* overlays/modals */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      z-index:40;
    }
    .overlay.on{display:block;}

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:18px;
    }
    .modal.on{display:flex;}
    .modal img{max-width:95%; max-height:90vh; border-radius:14px; border:1px solid rgba(255,255,255,.12);}

    /* Profile modal + Gate (login/edit) */
    .gate{
      position:fixed; inset:0;
      z-index:3000;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .gate.on{display:flex;}
    .card{
      width:100%; max-width:560px;
      border-radius:20px;
      border:1px solid rgba(170,220,255,.14);
      background: linear-gradient(180deg, rgba(16,22,34,.78), rgba(10,14,22,.55));
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
      overflow:hidden;
      position:relative;
    }
    .card::after{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(0,255,255,.16), rgba(255,0,200,.14), rgba(0,255,160,.14));
      filter: blur(18px);
      opacity:.45;
      animation: hue 9s linear infinite;
      pointer-events:none;
    }
    .card > *{position:relative; z-index:2;}
    .chead{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(170,220,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .ctitle{font-family:var(--H); letter-spacing:2px; text-transform:uppercase; font-size:14px;}
    .csub{padding:0 16px 12px; color:var(--mut); font-size:12px; line-height:1.6;}
    .cbody{padding:14px 16px 16px; display:flex; flex-direction:column; gap:12px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .field{
      flex:1; min-width:200px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    .field:focus{border-color: rgba(0,255,255,.18);}
    .upload{
      flex:1; min-width:200px;
      padding:12px 12px;
      border-radius:14px;
      border:1px dashed rgba(0,255,255,.18);
      background: rgba(0,0,0,.22);
      color: var(--mut);
      font-size:12px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .cfoot{padding:14px 16px 16px; display:flex; gap:10px;}
    .primary{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-family:var(--H);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
      background: linear-gradient(135deg, rgba(0,255,255,.22), rgba(255,0,200,.18), rgba(0,255,160,.18));
      color:#07101e;
      font-weight:900;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .secondary{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--txt);
      cursor:pointer;
      font-family:var(--H);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
    }
    .hint{padding:0 16px 14px; color:var(--mut2); font-size:11px;}

    .profileModal{
      position:fixed; inset:0;
      z-index:2600;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .profileModal.on{display:flex;}
    .pbox{
      width:100%; max-width:560px;
      border-radius:20px;
      border:1px solid rgba(170,220,255,.14);
      background: linear-gradient(180deg, rgba(16,22,34,.78), rgba(10,14,22,.55));
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
      overflow:hidden;
      position:relative;
    }
    .pbox::after{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(0,255,255,.16), rgba(255,0,200,.14), rgba(0,255,160,.14));
      filter: blur(18px);
      opacity:.45;
      animation: hue 9s linear infinite;
      pointer-events:none;
    }
    .pbox > *{position:relative; z-index:2;}
    .phead{
      padding:16px;
      border-bottom:1px solid rgba(170,220,255,.10);
      display:flex; align-items:center; justify-content:space-between;
    }
    .phead .t{font-family:var(--H); letter-spacing:2px; text-transform:uppercase; font-size:13px;}
    .pclose{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color:var(--txt);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }
    .pcontent{padding:16px; display:flex; gap:14px; align-items:center;}
    .pava{
      width:72px;height:72px;border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background: rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      flex-shrink:0;
    }
    .pava img{width:100%;height:100%;object-fit:cover;display:none;}
    .pava .ini{font-family:var(--H); font-weight:800; letter-spacing:1px;}
    .pmeta{min-width:0; flex:1;}
    .pname{font-family:var(--H); letter-spacing:1.6px; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pbio{margin-top:6px; color:var(--mut); font-size:12px; line-height:1.45;}
    .pstatus{margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pbtns{padding:0 16px 16px; display:flex; gap:10px;}
    .pbtn{
      flex:1;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--txt);
      cursor:pointer;
      font-family:var(--H);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }

    /* Toast notifications */
    .toastWrap{
      position:fixed;
      right:12px; bottom:92px;
      z-index:4000;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      min-width:240px;
      max-width:320px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding:12px 12px;
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      animation: pop .16s ease;
    }
    .toast .tt{font-family:var(--H); letter-spacing:1.6px; text-transform:uppercase; font-size:11px;}
    .toast .tx{margin-top:6px; color:var(--mut); font-size:12px; line-height:1.35; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    /* Mobile */
    @media (max-width: 900px){
      .sidebar{
        position:fixed;
        top:0; bottom:0; left:0;
        transform: translateX(-105%);
        width:300px;
      }
      .sidebar.on{ transform: translateX(0); }
    }
  </style>
</head>

<body>
  <div class="bg-wrap"><canvas id="fx"></canvas></div>
  <div class="hue-layer"></div>

  <!-- Toasts -->
  <div class="toastWrap" id="toastWrap"></div>

  <!-- LOGIN / EDIT -->
  <div class="gate" id="gate">
    <div class="card">
      <div class="chead">
        <div class="ctitle" id="gateTitle">LOGIN</div>
        <span class="pill"><span class="dot off" id="gateDot"></span><strong>PROFILE</strong></span>
      </div>
      <div class="csub" id="gateSub">
        Masukin <b>nama</b> (min 3 karakter, bebas spasi/unik) + <b>bio</b> + (opsional) <b>foto profil</b>.
        Semua orang bisa lihat profil kamu.
      </div>
      <div class="cbody">
        <div class="row">
          <input id="gateName" class="field" placeholder="Nama (min 3) contoh: Anomali Epep" autocomplete="off"/>
          <input id="gateBio" class="field" placeholder="Bio (opsional) contoh: hidup santuy ✨" autocomplete="off"/>
        </div>
        <div class="row">
          <label class="upload" for="gatePhoto">
            <i class="fa-solid fa-image"></i>
            <span id="photoLabel">Upload foto profil (opsional)</span>
          </label>
          <input id="gatePhoto" type="file" accept="image/*" style="display:none"/>
        </div>
      </div>
      <div class="cfoot">
        <button class="primary" id="gateGo">Masuk</button>
        <button class="secondary" id="gateReset" title="hapus data login">Reset</button>
      </div>
      <div class="hint">
        Autoplay musik kadang diblokir browser. Kalau belum bunyi → tekan tombol MUSIC.
      </div>
    </div>
  </div>

  <!-- Public profile modal -->
  <div class="profileModal" id="profileModal">
    <div class="pbox">
      <div class="phead">
        <div class="t">PUBLIC PROFILE</div>
        <button class="pclose" id="pClose"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="pcontent">
        <div class="pava" id="pAva">
          <img id="pAvaImg" alt="p"/>
          <div class="ini" id="pAvaIni">??</div>
        </div>
        <div class="pmeta">
          <div class="pname" id="pName">User</div>
          <div class="pbio" id="pBio">-</div>
          <div class="pstatus" id="pStatus"></div>
        </div>
      </div>
      <div class="pbtns">
        <button class="pbtn" id="pDm"><i class="fa-solid fa-lock"></i> DM</button>
        <button class="pbtn" id="pView"><i class="fa-solid fa-eye"></i> VIEW</button>
      </div>
    </div>
  </div>

  <!-- overlay for sidebar mobile -->
  <div class="overlay" id="overlay"></div>

  <!-- image modal -->
  <div class="modal" id="imgModal">
    <img id="imgModalEl" alt="preview"/>
  </div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="profile-top">
          <div class="avatar" id="meAvatar" title="Edit profile">
            <img id="meImg" alt="me"/>
            <div class="ini" id="meIni">ME</div>
          </div>
          <div class="me-info">
            <div class="me-name" id="meName">Loading...</div>
            <div class="me-bio" id="meBio">-</div>
            <div class="row-pills">
              <span class="pill"><span class="dot" id="connDot"></span><strong id="connTxt">CONNECTING</strong></span>
              <span class="pill"><i class="fa-solid fa-user"></i><strong id="modeTxt">PUBLIC</strong></span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btnEdit"><i class="fa-solid fa-pen-to-square"></i> EDIT</button>
          <button class="btn danger" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> LOGOUT</button>
        </div>
      </div>

      <div class="mini-panel">
        <div class="mini-row">
          <div class="mini-title"><i class="fa-solid fa-users"></i> ONLINE</div>
          <div class="mini-value" id="onlineCount">0</div>
        </div>

        <button class="music-btn music-off" id="musicBtn">
          <span class="m-dot" id="musicDot"></span>
          <span id="musicTxt">MUSIC OFF</span>
        </button>
      </div>

      <div class="list-wrap">
        <div class="section-header">
          <span>USERS (HISTORY)</span>
          <span id="userCount">0</span>
        </div>
        <div class="users" id="userList"></div>
      </div>
    </aside>

    <!-- CHAT -->
    <main class="chat">
      <header class="chat-header">
        <!-- PUBLIC header -->
        <div class="left-head" id="publicHead">
          <button class="hamburger" id="hamburger" aria-label="menu"><i class="fa-solid fa-bars"></i></button>
          <div class="brand">
            <h1>LIVE CHAT</h1>
            <span class="badge-prem">ULTRA</span>
            <span class="mode-pill" id="modePill">PUBLIC</span>
          </div>
        </div>

        <!-- DM header -->
        <div class="dm-head" id="dmHead" style="display:none;">
          <button class="dm-back" id="dmBack" title="Back">
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <div class="dm-title">
            <div class="dm-name" id="dmTitleName">User</div>
            <div class="dm-sub" id="dmTitleSub">
              <span class="tinyDot off" id="dmTinyDot"></span>
              <span id="dmTinyTxt">offline</span>
            </div>
          </div>
          <div class="dm-avatar" id="dmTitleAvatar" title="Open profile">
            <img id="dmTitleImg" alt="dm"/>
            <div class="ini" id="dmTitleIni">??</div>
          </div>
        </div>

        <div class="net">
          <span class="sig mid" id="sig">
            <span class="bar b1"></span><span class="bar b2"></span><span class="bar b3"></span><span class="bar b4"></span>
          </span>
          <span><strong id="pingMs">--</strong> ms</span>
        </div>
      </header>

      <section class="msgs" id="msgs">
        <div class="sys" id="welcome"><i class="fa-solid fa-circle-notch fa-spin"></i> Waiting for login...</div>
      </section>

      <div class="typing" id="typing">
        <div class="dots"><span></span><span></span><span></span></div>
        <div id="typingTxt">Typing...</div>
      </div>

      <footer class="input">
        <div class="wrap">
          <div class="replyPreview" id="replyPreview">
            <div>
              <div style="font-family:var(--H);letter-spacing:1.2px;font-size:11px;text-transform:uppercase;color:var(--txt);">Reply to: <span id="replyToName"></span></div>
              <div style="color:var(--mut);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" id="replyToText"></div>
            </div>
            <i class="fa-solid fa-xmark x" id="replyCancel"></i>
          </div>

          <div class="preview" id="preview">
            <i class="fa-solid fa-paperclip"></i>
            <span id="previewName" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;"></span>
            <i class="fa-solid fa-xmark x" id="previewX"></i>
          </div>

          <textarea id="input" placeholder="Type message..." disabled></textarea>
        </div>

        <input type="file" id="file" accept="image/*,video/*" style="display:none"/>
        <div class="btns">
          <button class="icon disabled" id="attachBtn" disabled title="Attach"><i class="fa-solid fa-paperclip"></i></button>
          <button class="icon disabled" id="micBtn" disabled title="Voice"><i class="fa-solid fa-microphone"></i></button>
          <button class="icon send disabled" id="sendBtn" disabled title="Send"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </footer>
    </main>
  </div>

  <!-- Audio -->
  <audio id="bgm" preload="auto" loop>
    <source src="https://files.catbox.moe/wlny2m.mp3" type="audio/mpeg"/>
  </audio>

  <!-- SET SOCKET URL (ubah sesuai backend kamu) -->
  <script>
    // contoh:
    // window.SOCKET_URL = "https://livechat.raraaprivate.my.id";
    window.SOCKET_URL = window.SOCKET_URL || "https://livechatscarrydeath.raraaprivate.my.id";
  </script>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
    /* =======================
      STORAGE KEYS
    ======================== */
    const KEY_NAME  = "lc_name";
    const KEY_BIO   = "lc_bio";
    const KEY_PHOTO = "lc_photo";

    /* =======================
      DOM
    ======================== */
    const $ = (id)=>document.getElementById(id);
    const el = {
      fx: $("fx"),
      toastWrap: $("toastWrap"),

      gate: $("gate"),
      gateTitle: $("gateTitle"),
      gateSub: $("gateSub"),
      gateDot: $("gateDot"),
      gateName: $("gateName"),
      gateBio: $("gateBio"),
      gatePhoto: $("gatePhoto"),
      photoLabel: $("photoLabel"),
      gateGo: $("gateGo"),
      gateReset: $("gateReset"),

      profileModal: $("profileModal"),
      pClose: $("pClose"),
      pAvaImg: $("pAvaImg"),
      pAvaIni: $("pAvaIni"),
      pName: $("pName"),
      pBio: $("pBio"),
      pStatus: $("pStatus"),
      pDm: $("pDm"),
      pView: $("pView"),

      overlay: $("overlay"),
      sidebar: $("sidebar"),
      hamburger: $("hamburger"),

      meAvatar: $("meAvatar"),
      meImg: $("meImg"),
      meIni: $("meIni"),
      meName: $("meName"),
      meBio: $("meBio"),
      connDot: $("connDot"),
      connTxt: $("connTxt"),
      modeTxt: $("modeTxt"),
      modePill: $("modePill"),
      btnEdit: $("btnEdit"),
      btnLogout: $("btnLogout"),

      onlineCount: $("onlineCount"),
      userCount: $("userCount"),
      userList: $("userList"),

      publicHead: $("publicHead"),
      dmHead: $("dmHead"),
      dmBack: $("dmBack"),
      dmTitleName: $("dmTitleName"),
      dmTitleSub: $("dmTitleSub"),
      dmTinyDot: $("dmTinyDot"),
      dmTinyTxt: $("dmTinyTxt"),
      dmTitleAvatar: $("dmTitleAvatar"),
      dmTitleImg: $("dmTitleImg"),
      dmTitleIni: $("dmTitleIni"),

      sig: $("sig"),
      pingMs: $("pingMs"),

      msgs: $("msgs"),
      welcome: $("welcome"),
      typing: $("typing"),
      typingTxt: $("typingTxt"),

      replyPreview: $("replyPreview"),
      replyToName: $("replyToName"),
      replyToText: $("replyToText"),
      replyCancel: $("replyCancel"),

      preview: $("preview"),
      previewName: $("previewName"),
      previewX: $("previewX"),

      input: $("input"),
      file: $("file"),
      attachBtn: $("attachBtn"),
      micBtn: $("micBtn"),
      sendBtn: $("sendBtn"),

      musicBtn: $("musicBtn"),
      musicDot: $("musicDot"),
      musicTxt: $("musicTxt"),
      bgm: $("bgm"),

      imgModal: $("imgModal"),
      imgModalEl: $("imgModalEl"),
    };

    /* =======================
      STATE
    ======================== */
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;
    const me = { name:null, bio:"", photo:null };

    let socket = null;
    let connected = false;
    let pingTimer = null;
    let pingAt = 0;

    // Users history map: name -> {name,bio,photo,online,lastSeen,unreadDM}
    let usersMap = new Map();

    // mode: public / dm
    let chatMode = "public";
    let dmPeer = null; // {name,bio,photo,online}
    let dmRoom = null;

    // typing
    let typingTimeout = null;

    // attach
    let currentFile = null;
    let currentFileData = null;

    // reply
    let replyTo = null; // {id, name, text}

    // voice
    let recorder = null;
    let recChunks = [];
    let recording = false;

    // simple msg id
    const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);

    /* =======================
      HELPERS
    ======================== */
    function esc(t){
      const d=document.createElement("div");
      d.textContent= String(t ?? "");
      return d.innerHTML;
    }
    function ini(name){
      const s = String(name||"").trim();
      if(!s) return "??";
      const parts = s.split(/\s+/).filter(Boolean);
      const a = parts[0]?.[0] || s[0];
      const b = parts[1]?.[0] || s[1] || "";
      return (a+b).toUpperCase().slice(0,2);
    }
    function okName(name){
      const s = String(name||"").trim();
      return s.length >= 3; // bebas spasi/unik
    }
    function toast(title, text){
      const div = document.createElement("div");
      div.className = "toast";
      div.innerHTML = `<div class="tt">${esc(title)}</div><div class="tx">${esc(text||"")}</div>`;
      el.toastWrap.appendChild(div);
      setTimeout(()=>{ div.style.opacity="0"; div.style.transform="translateY(6px)"; }, 2600);
      setTimeout(()=>{ div.remove(); }, 3200);
    }
    function setConn(state){
      // state: connecting/online/offline
      el.connDot.classList.remove("on","off");
      if(state==="online"){
        el.connDot.classList.add("on");
        el.connTxt.textContent = "ONLINE";
        el.gateDot.classList.remove("off");
        el.gateDot.classList.add("on");
      }else if(state==="connecting"){
        el.connTxt.textContent = "CONNECTING";
        el.gateDot.classList.remove("on");
        el.gateDot.classList.add("off");
      }else{
        el.connDot.classList.add("off");
        el.connTxt.textContent = "OFFLINE";
        el.gateDot.classList.remove("on");
        el.gateDot.classList.add("off");
      }
    }
    function enableUI(on){
      const add = (x)=>{ x.disabled = !on; x.classList.toggle("disabled", !on); };
      el.input.disabled = !on;
      el.attachBtn.disabled = !on; add(el.attachBtn);
      el.micBtn.disabled = !on; add(el.micBtn);
      el.sendBtn.disabled = !on; add(el.sendBtn);
      if(on) el.input.focus();
    }
    function scrollBottom(){
      el.msgs.scrollTop = el.msgs.scrollHeight;
    }
    function timeStr(ts){
      return new Date(ts||Date.now()).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
    }

    /* =======================
      BACKGROUND FX (random colorful objects)
    ======================== */
    function bgFX(){
      const c = el.fx;
      const ctx = c.getContext("2d",{alpha:true});

      let w=0,h=0,dpr=1;
      const objects=[];
      const stars=[];

      function resize(){
        dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
        w = window.innerWidth;
        h = window.innerHeight;
        c.width = Math.floor(w*dpr);
        c.height = Math.floor(h*dpr);
        c.style.width = w+"px";
        c.style.height = h+"px";
        ctx.setTransform(dpr,0,0,dpr,0,0);

        objects.length=0; stars.length=0;

        const starCount = Math.min(280, Math.floor((w*h)/6000));
        for(let i=0;i<starCount;i++){
          stars.push({
            x: Math.random()*w,
            y: Math.random()*h,
            r: Math.random()*1.6 + 0.2,
            a: Math.random()*0.8 + 0.05,
            tw: Math.random()*0.01 + 0.002
          });
        }

        const objCount = Math.min(18, Math.max(10, Math.floor(w/70)));
        for(let i=0;i<objCount;i++){
          objects.push(spawnObj());
        }
      }

      function spawnObj(){
        const type = ["orb","hex","tri","ring"][Math.floor(Math.random()*4)];
        const size = 18 + Math.random()*55;
        return {
          type,
          x: Math.random()*w,
          y: Math.random()*h,
          vx: (Math.random()*0.6-0.3),
          vy: (Math.random()*0.6-0.3),
          rot: Math.random()*Math.PI*2,
          vr: (Math.random()*0.01-0.005),
          size,
          hue: Math.random()*360,
          hueSp: 0.2 + Math.random()*0.6,
          glow: 0.12 + Math.random()*0.18,
          alpha: 0.12 + Math.random()*0.22
        };
      }

      function drawHex(x,y,r,rot){
        ctx.beginPath();
        for(let i=0;i<6;i++){
          const a = rot + i*Math.PI/3;
          const px = x + Math.cos(a)*r;
          const py = y + Math.sin(a)*r;
          if(i===0) ctx.moveTo(px,py);
          else ctx.lineTo(px,py);
        }
        ctx.closePath();
      }

      function tick(){
        ctx.clearRect(0,0,w,h);

        // stars
        for(const s of stars){
          s.a += (Math.random()<0.5?-1:1)*s.tw;
          if(s.a<0.05) s.a=0.05;
          if(s.a>0.95) s.a=0.95;
          ctx.beginPath();
          ctx.fillStyle = `rgba(200,230,255,${s.a})`;
          ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
          ctx.fill();
        }

        // objects
        for(const o of objects){
          o.x += o.vx; o.y += o.vy; o.rot += o.vr;
          o.hue = (o.hue + o.hueSp) % 360;

          // wrap
          if(o.x < -120) o.x = w+120;
          if(o.x > w+120) o.x = -120;
          if(o.y < -120) o.y = h+120;
          if(o.y > h+120) o.y = -120;

          const col = `hsla(${o.hue}, 95%, 70%, ${o.alpha})`;
          const glow = `hsla(${(o.hue+40)%360}, 95%, 70%, ${o.glow})`;

          ctx.save();
          ctx.translate(o.x,o.y);
          ctx.rotate(o.rot);

          ctx.shadowColor = glow;
          ctx.shadowBlur = 22;

          ctx.lineWidth = 1.4;
          ctx.strokeStyle = col;

          if(o.type==="orb"){
            const g = ctx.createRadialGradient(0,0,1,0,0,o.size);
            g.addColorStop(0, `hsla(${o.hue},95%,75%,${o.alpha+0.10})`);
            g.addColorStop(1, `hsla(${o.hue},95%,65%,0)`);
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.arc(0,0,o.size,0,Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(0,0,o.size*0.55,0,Math.PI*2);
            ctx.stroke();
          }else if(o.type==="ring"){
            ctx.beginPath();
            ctx.arc(0,0,o.size*0.95,0,Math.PI*2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(0,0,o.size*0.45,0,Math.PI*2);
            ctx.stroke();
          }else if(o.type==="hex"){
            drawHex(0,0,o.size*0.85,0);
            ctx.stroke();
          }else{
            // tri
            ctx.beginPath();
            ctx.moveTo(0,-o.size);
            ctx.lineTo(o.size*0.9,o.size*0.7);
            ctx.lineTo(-o.size*0.9,o.size*0.7);
            ctx.closePath();
            ctx.stroke();
          }

          ctx.restore();
        }

        // slow meteor streaks
        if(Math.random()<0.06){
          const x = Math.random()*w*0.9;
          const y = Math.random()*h*0.3;
          const len = 120+Math.random()*260;
          const ang = 0.7+Math.random()*0.25;
          const vx = Math.cos(ang)*3.2;
          const vy = Math.sin(ang)*3.2;
          const hue = Math.random()*360;
          const head = {x,y,vx,vy,len,life:90, hue};
          meteors.push(head);
          if(meteors.length>14) meteors.shift();
        }
        for(let i=meteors.length-1;i>=0;i--){
          const m=meteors[i];
          m.x += m.vx; m.y += m.vy; m.life--;
          const dx=-m.vx, dy=-m.vy;
          const mag=Math.hypot(dx,dy)||1;
          const nx=dx/mag, ny=dy/mag;
          const tx=m.x+nx*m.len, ty=m.y+ny*m.len;

          const grad=ctx.createLinearGradient(m.x,m.y,tx,ty);
          grad.addColorStop(0, `hsla(${m.hue},95%,75%,.35)`);
          grad.addColorStop(0.25, `hsla(${(m.hue+50)%360},95%,70%,.22)`);
          grad.addColorStop(1, `hsla(${m.hue},95%,70%,0)`);

          ctx.lineWidth=1.8;
          ctx.strokeStyle=grad;
          ctx.beginPath();
          ctx.moveTo(m.x,m.y);
          ctx.lineTo(tx,ty);
          ctx.stroke();

          ctx.fillStyle=`hsla(${m.hue},95%,80%,.20)`;
          ctx.beginPath(); ctx.arc(m.x,m.y,3,0,Math.PI*2); ctx.fill();

          if(m.life<=0 || m.x>w+400 || m.y>h+400) meteors.splice(i,1);
        }

        requestAnimationFrame(tick);
      }

      const meteors=[];
      window.addEventListener("resize", resize);
      resize();
      requestAnimationFrame(tick);
    }

    /* =======================
      MUSIC
    ======================== */
    let musicOn = false;
    async function tryPlay(){
      try{
        el.bgm.volume = 0.8;
        await el.bgm.play();
        setMusic(true);
      }catch(_){
        setMusic(false);
      }
    }
    function setMusic(on){
      musicOn=!!on;
      el.musicBtn.classList.toggle("music-on", musicOn);
      el.musicBtn.classList.toggle("music-off", !musicOn);
      el.musicTxt.textContent = musicOn ? "MUSIC ON" : "MUSIC OFF";
    }
    async function toggleMusic(){
      try{
        if(musicOn){ el.bgm.pause(); setMusic(false); }
        else{ await el.bgm.play(); setMusic(true); }
      }catch(_){
        setMusic(false);
        alert("Autoplay diblokir browser. Coba klik MUSIC lagi / unmute.");
      }
    }
    function installUnlock(){
      const unlock = async ()=>{
        if(!musicOn){
          try{ await el.bgm.play(); setMusic(true); }catch(_){}
        }
        window.removeEventListener("touchstart", unlock);
        window.removeEventListener("click", unlock);
      };
      window.addEventListener("touchstart", unlock, {once:true});
      window.addEventListener("click", unlock, {once:true});
    }

    /* =======================
      PROFILE UI
    ======================== */
    function applyMe(){
      el.meName.textContent = me.name || "Guest";
      el.meBio.textContent = me.bio ? me.bio : "-";
      el.meIni.textContent = ini(me.name);
      if(me.photo){
        el.meImg.src = me.photo;
        el.meImg.style.display="block";
        el.meIni.style.display="none";
      }else{
        el.meImg.removeAttribute("src");
        el.meImg.style.display="none";
        el.meIni.style.display="block";
      }
    }

    function openGate(mode){
      el.gate.classList.add("on");
      if(mode==="edit"){
        el.gateTitle.textContent="EDIT PROFILE";
        el.gateName.value = me.name || "";
        el.gateBio.value = me.bio || "";
        el.photoLabel.textContent = me.photo ? "Ganti foto profil (sudah ada)" : "Upload foto profil (opsional)";
      }else{
        el.gateTitle.textContent="LOGIN";
        el.gateName.value="";
        el.gateBio.value="";
        el.photoLabel.textContent="Upload foto profil (opsional)";
      }
      setTimeout(()=>el.gateName.focus(), 50);
    }
    function closeGate(){ el.gate.classList.remove("on"); }

    function fileToBase64(file){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej;
        r.readAsDataURL(file);
      });
    }

    async function saveGate(){
      const name = String(el.gateName.value||"").trim();
      const bio  = String(el.gateBio.value||"").trim();

      if(!okName(name)){
        alert("Nama minimal 3 karakter.");
        el.gateName.focus();
        return;
      }

      me.name = name;
      me.bio  = bio;

      localStorage.setItem(KEY_NAME, me.name);
      localStorage.setItem(KEY_BIO, me.bio);

      if(el.gatePhoto.files && el.gatePhoto.files[0]){
        const f=el.gatePhoto.files[0];
        if(!f.type.startsWith("image/")) return alert("Foto profil harus gambar.");
        if(f.size > 2*1024*1024) return alert("Foto max 2MB.");
        me.photo = await fileToBase64(f);
        localStorage.setItem(KEY_PHOTO, me.photo);
      }else{
        const saved = localStorage.getItem(KEY_PHOTO);
        me.photo = saved ? saved : null;
      }

      applyMe();
      closeGate();

      if(!socket) connect();
      else if(connected){
        socket.emit("profile:update", { name: me.name, bio: me.bio, photo: me.photo });
      }
    }

    function logout(){
      localStorage.removeItem(KEY_NAME);
      localStorage.removeItem(KEY_BIO);
      localStorage.removeItem(KEY_PHOTO);
      me.name=null; me.bio=""; me.photo=null;
      applyMe();

      try{ if(socket) socket.disconnect(); }catch(_){}
      socket=null; connected=false;

      el.msgs.innerHTML="";
      el.welcome.style.display="flex";
      el.welcome.innerHTML=`<i class="fa-solid fa-user-lock"></i> Please login`;
      el.msgs.appendChild(el.welcome);

      enableUI(false);
      setConn("offline");

      chatToPublic(true);
      openGate("login");
    }

    /* =======================
      MODE + DM HEADER
    ======================== */
    function setMode(mode){
      chatMode = mode;
      const isDM = mode==="dm";
      el.publicHead.style.display = isDM ? "none" : "flex";
      el.dmHead.style.display     = isDM ? "flex" : "none";
      el.modePill.textContent     = isDM ? "DM" : "PUBLIC";
      el.modeTxt.textContent      = isDM ? "DM" : "PUBLIC";
    }

    function setDMHeader(user){
      if(!user) return;
      el.dmTitleName.textContent = user.name || "User";
      const on = !!user.online;
      el.dmTinyDot.classList.toggle("on", on);
      el.dmTinyDot.classList.toggle("off", !on);
      el.dmTinyTxt.textContent = on ? "online" : "offline";

      el.dmTitleIni.textContent = ini(user.name);
      if(user.photo){
        el.dmTitleImg.src = user.photo;
        el.dmTitleImg.style.display="block";
        el.dmTitleIni.style.display="none";
      }else{
        el.dmTitleImg.removeAttribute("src");
        el.dmTitleImg.style.display="none";
        el.dmTitleIni.style.display="block";
      }
    }

    function chatToPublic(clear=false){
      setMode("public");
      dmPeer=null; dmRoom=null;
      if(clear){
        el.msgs.innerHTML="";
        el.welcome.style.display="flex";
        el.welcome.innerHTML=`<i class="fa-solid fa-comment-dots"></i> Public chat`;
        el.msgs.appendChild(el.welcome);
        setTimeout(()=>{ el.welcome.style.display="none"; }, 1200);
      }
      if(socket && connected){
        socket.emit("public:history");
      }
    }

    function chatToDM(user){
      if(!user || !user.name) return;
      dmPeer = user;
      dmRoom = makeRoom(me.name, user.name);
      setMode("dm");
      setDMHeader(user);

      // clear unread badge
      const u = usersMap.get(user.name);
      if(u){ u.unreadDM = 0; usersMap.set(user.name,u); renderUsers(); }

      el.msgs.innerHTML="";
      el.welcome.style.display="flex";
      el.welcome.innerHTML=`<i class="fa-solid fa-lock"></i> DM with ${esc(user.name)}`;
      el.msgs.appendChild(el.welcome);
      setTimeout(()=>{ el.welcome.style.display="none"; }, 1200);

      if(socket && connected){
        socket.emit("dm:history", { room: dmRoom, peer: user.name });
      }
    }

    function makeRoom(a,b){
      const x=String(a||"").trim().toLowerCase();
      const y=String(b||"").trim().toLowerCase();
      return [x,y].sort().join("__");
    }

    /* =======================
      PROFILE MODAL (PUBLIC)
    ======================== */
    let profUser = null;
    function openProfile(user){
      if(!user) return;
      profUser = user;

      el.profileModal.classList.add("on");
      el.pName.textContent = user.name || "User";
      el.pBio.textContent = user.bio ? user.bio : "-";

      // status
      const on = !!user.online;
      el.pStatus.innerHTML = `
        <span class="pill"><span class="dot ${on?"on":"off"}"></span><strong>${on?"ONLINE":"OFFLINE"}</strong></span>
      `;

      el.pAvaIni.textContent = ini(user.name);
      if(user.photo){
        el.pAvaImg.src = user.photo;
        el.pAvaImg.style.display="block";
        el.pAvaIni.style.display="none";
      }else{
        el.pAvaImg.removeAttribute("src");
        el.pAvaImg.style.display="none";
        el.pAvaIni.style.display="block";
      }
    }
    function closeProfile(){
      el.profileModal.classList.remove("on");
      profUser=null;
    }

    /* =======================
      MESSAGE RENDER
    ======================== */
    function system(text){
      const d=document.createElement("div");
      d.className="sys";
      d.innerHTML = `<i class="fa-solid fa-bolt"></i> ${esc(text)}`;
      el.msgs.appendChild(d);
      scrollBottom();
      setTimeout(()=>d.remove(), 4500);
    }

    function renderMsg(m){
      const mine = (m.from === me.name);
      const wrap=document.createElement("div");
      wrap.className = `msg ${mine?"own":"other"}`;

      const ava=document.createElement("div");
      ava.className="a";
      const img=document.createElement("img");
      const inid=document.createElement("div");
      inid.className="ini";
      inid.textContent = ini(m.from);

      const fromUser = usersMap.get(m.from) || {photo:null};
      const photo = mine ? me.photo : (m.fromPhoto || fromUser.photo || null);

      if(photo){
        img.src=photo; img.style.display="block"; inid.style.display="none";
      }else{
        img.style.display="none"; inid.style.display="block";
      }
      ava.appendChild(img); ava.appendChild(inid);

      const b=document.createElement("div");
      b.className="bubble";

      const top = `
        <div class="topline">
          <div class="name">${esc(m.from||"")}</div>
          <div class="time">${esc(timeStr(m.ts))}</div>
        </div>
      `;

      const replyHTML = m.replyTo ? `
        <div class="replyBox">
          <div class="rName">REPLY: ${esc(m.replyTo.name||"")}</div>
          <div class="rText">${esc(m.replyTo.text||"")}</div>
        </div>
      ` : "";

      const txt = m.text ? `<div class="txt">${esc(m.text).replace(/\n/g,"<br>")}</div>` : "";

      let media = "";
      if(m.kind==="image" && m.data){
        media = `<div class="media"><img src="${m.data}" data-preview="1" alt="img"/></div>`;
      }else if(m.kind==="video" && m.data){
        media = `<div class="media"><video src="${m.data}" controls></video></div>`;
      }else if(m.kind==="audio" && m.data){
        media = `<div class="media"><audio src="${m.data}" controls></audio></div>`;
      }

      const quick = `
        <div class="quick">
          <button class="qbtn" data-act="reply" data-id="${esc(m.id)}"><i class="fa-solid fa-reply"></i> REPLY</button>
        </div>
      `;

      b.innerHTML = `${top}${replyHTML}${txt}${media}${quick}`;

      wrap.appendChild(ava);
      wrap.appendChild(b);
      el.msgs.appendChild(wrap);

      // preview image
      const im = wrap.querySelector('img[data-preview="1"]');
      if(im){
        im.addEventListener("click", ()=>{
          el.imgModalEl.src = m.data;
          el.imgModal.classList.add("on");
        });
      }

      // reply button
      const rb = wrap.querySelector('[data-act="reply"]');
      if(rb){
        rb.addEventListener("click", ()=>{
          replyTo = { id: m.id, name: m.from, text: (m.text || (m.kind ? `[${m.kind}]` : "")) };
          el.replyToName.textContent = replyTo.name;
          el.replyToText.textContent = replyTo.text;
          el.replyPreview.classList.add("on");
          el.input.focus();
        });
      }
    }

    /* =======================
      USERS LIST (history + online/offline)
    ======================== */
    function renderUsers(){
      const arr = Array.from(usersMap.values());
      // sort: online first, then name
      arr.sort((a,b)=>{
        const ao = a.online?0:1, bo=b.online?0:1;
        if(ao!==bo) return ao-bo;
        return String(a.name||"").localeCompare(String(b.name||""));
      });

      el.userList.innerHTML="";
      el.userCount.textContent = arr.length;

      arr.forEach(u=>{
        const item=document.createElement("div");
        item.className="u";

        const ava=document.createElement("div");
        ava.className="u-ava";

        const img=document.createElement("img");
        const iniD=document.createElement("div");
        iniD.className="ini";
        iniD.textContent = ini(u.name);

        if(u.photo){
          img.src=u.photo; img.style.display="block"; iniD.style.display="none";
        }else{
          img.style.display="none"; iniD.style.display="block";
        }
        ava.appendChild(img); ava.appendChild(iniD);

        const info=document.createElement("div");
        info.className="u-info";
        const sub = `
          <div class="u-sub">
            <span class="status">
              <span class="s-dot ${u.online?'on':'off'}"></span>
              <span>${u.online?'ONLINE':'OFFLINE'}</span>
            </span>
            <span>• TAP FOR DM</span>
          </div>
        `;
        info.innerHTML = `<div class="u-name">${esc(u.name||"")}</div>${sub}`;

        const badge=document.createElement("div");
        badge.className="badgeNew";
        if(u.unreadDM && u.unreadDM>0){
          badge.classList.add("on");
          badge.textContent = u.unreadDM>99 ? "99+" : String(u.unreadDM);
        }

        item.appendChild(ava);
        item.appendChild(info);
        item.appendChild(badge);

        item.addEventListener("click", ()=>{
          // open profile modal with DM option
          openProfile(u);
        });

        el.userList.appendChild(item);
      });

      // online count
      const online = arr.filter(x=>x.online).length;
      el.onlineCount.textContent = online;
    }

    /* =======================
      ATTACH / REPLY / SEND
    ======================== */
    function clearAttach(){
      currentFile=null; currentFileData=null;
      el.preview.classList.remove("on");
      el.file.value="";
    }
    function clearReply(){
      replyTo=null;
      el.replyPreview.classList.remove("on");
    }

    function send(){
      if(!socket || !connected) return;
      const text = String(el.input.value||"").trim();

      if(!text && !currentFile && !recording && !pendingAudio) return;

      // if we have pending audio: send it
      if(pendingAudio){
        const payload = {
          id: uid(),
          from: me.name,
          fromPhoto: me.photo || null,
          ts: Date.now(),
          text: text || "",
          kind: "audio",
          data: pendingAudio,
          replyTo: replyTo ? { name: replyTo.name, text: replyTo.text, id: replyTo.id } : null,
        };
        if(chatMode==="dm" && dmPeer){
          socket.emit("dm:send", { room: dmRoom, to: dmPeer.name, msg: payload });
        }else{
          socket.emit("public:send", payload);
        }
        pendingAudio=null;
        el.input.value="";
        el.input.style.height="auto";
        clearReply();
        return;
      }

      // attach image/video
      if(currentFile){
        const kind = currentFile.type.startsWith("image/") ? "image" : "video";
        const payload = {
          id: uid(),
          from: me.name,
          fromPhoto: me.photo || null,
          ts: Date.now(),
          text: text || "",
          kind,
          data: currentFileData,
          replyTo: replyTo ? { name: replyTo.name, text: replyTo.text, id: replyTo.id } : null,
        };

        if(chatMode==="dm" && dmPeer){
          socket.emit("dm:send", { room: dmRoom, to: dmPeer.name, msg: payload });
        }else{
          socket.emit("public:send", payload);
        }

        clearAttach();
        el.input.value="";
        el.input.style.height="auto";
        clearReply();
        return;
      }

      // normal text
      const payload = {
        id: uid(),
        from: me.name,
        fromPhoto: me.photo || null,
        ts: Date.now(),
        text,
        kind: "text",
        data: null,
        replyTo: replyTo ? { name: replyTo.name, text: replyTo.text, id: replyTo.id } : null,
      };
      if(chatMode==="dm" && dmPeer){
        socket.emit("dm:send", { room: dmRoom, to: dmPeer.name, msg: payload });
      }else{
        socket.emit("public:send", payload);
      }

      el.input.value="";
      el.input.style.height="auto";
      clearReply();
    }

    function onSelectFile(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      const ok = f.type.startsWith("image/") || f.type.startsWith("video/");
      if(!ok) return alert("Hanya image/video");
      if(f.size > 10*1024*1024) return alert("Max 10MB");

      currentFile=f;
      el.preview.classList.add("on");
      el.previewName.textContent = f.name;

      const r=new FileReader();
      r.onload=(ev)=> currentFileData = ev.target.result;
      r.readAsDataURL(f);
    }

    /* =======================
      VOICE RECORD (MediaRecorder)
    ======================== */
    let pendingAudio = null;

    async function startRec(){
      if(recording) return;
      pendingAudio=null;

      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        recorder = new MediaRecorder(stream);
        recChunks = [];
        recorder.ondataavailable = (e)=>{ if(e.data.size>0) recChunks.push(e.data); };
        recorder.onstop = async ()=>{
          // stop tracks
          stream.getTracks().forEach(t=>t.stop());
          const blob = new Blob(recChunks, {type:"audio/webm"});
          const dataUrl = await blobToDataURL(blob);
          pendingAudio = dataUrl;
          toast("VOICE", "Voice ready — tekan SEND");
          recording=false;
          el.micBtn.innerHTML = `<i class="fa-solid fa-microphone"></i>`;
        };
        recorder.start();
        recording=true;
        toast("VOICE", "Recording...");
        el.micBtn.innerHTML = `<i class="fa-solid fa-stop"></i>`;
      }catch(err){
        alert("Mic tidak bisa diakses: izin ditolak / browser tidak support.");
      }
    }

    function stopRec(){
      if(!recording || !recorder) return;
      try{ recorder.stop(); }catch(_){}
    }

    function blobToDataURL(blob){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej;
        r.readAsDataURL(blob);
      });
    }

    /* =======================
      SOCKET CONNECT
    ======================== */
    function connect(){
      if(!window.io) return alert("Socket.IO client gagal load.");
      setConn("connecting");
      enableUI(false);

      socket = io(SOCKET_URL, { transports:["websocket","polling"] });

      socket.on("connect", ()=>{
        connected=true;
        setConn("online");
        enableUI(true);

        // register profile
        socket.emit("profile:hello", { name: me.name, bio: me.bio, photo: me.photo });

        // get initial
        socket.emit("users:sync");
        socket.emit("public:history");

        startPing();
        system("Connected");
      });

      socket.on("disconnect", ()=>{
        connected=false;
        setConn("offline");
        enableUI(false);
        stopPing();
        system("Disconnected");
      });

      socket.on("connect_error", ()=>{
        connected=false;
        setConn("offline");
        enableUI(false);
        system("Cannot connect to server");
      });

      // users sync
      socket.on("users:list", (payload)=>{
        // payload: { users:[{name,bio,photo,online,lastSeen}], onlineCount }
        const list = payload?.users || [];
        list.forEach(u=>{
          const old = usersMap.get(u.name) || {unreadDM:0};
          usersMap.set(u.name, {
            name: u.name,
            bio: u.bio || "",
            photo: u.photo || null,
            online: !!u.online,
            lastSeen: u.lastSeen || Date.now(),
            unreadDM: old.unreadDM || 0
          });
        });
        renderUsers();

        // update dm header status if in dm
        if(chatMode==="dm" && dmPeer){
          const nu = usersMap.get(dmPeer.name);
          if(nu){
            dmPeer = nu;
            setDMHeader(nu);
          }
        }
      });

      socket.on("users:update", (u)=>{
        if(!u || !u.name) return;
        const old = usersMap.get(u.name) || {unreadDM:0};
        usersMap.set(u.name, {
          name:u.name,
          bio:u.bio||"",
          photo:u.photo||null,
          online:!!u.online,
          lastSeen:u.lastSeen||Date.now(),
          unreadDM: old.unreadDM||0
        });
        renderUsers();

        if(chatMode==="dm" && dmPeer && u.name===dmPeer.name){
          dmPeer = usersMap.get(u.name);
          setDMHeader(dmPeer);
        }
      });

      // public history/messages
      socket.on("public:history", (arr)=>{
        if(chatMode!=="public") return;
        el.msgs.innerHTML="";
        (arr||[]).forEach(renderMsg);
        scrollBottom();
      });

      socket.on("public:new", (m)=>{
        if(chatMode!=="public") return;
        renderMsg(m);
        scrollBottom();
      });

      // dm history/messages
      socket.on("dm:history", (data)=>{
        if(chatMode!=="dm") return;
        el.msgs.innerHTML="";
        (data?.messages||[]).forEach(renderMsg);
        scrollBottom();
      });

socket.on("dm:new", (data)=>{
  const m = data?.msg;
  const from = data?.from;
  const isSelf = !!data?.self;
  if(!m || !from) return;

  // kalau ini echo pesan kita sendiri, jangan bikin toast notif
  if(isSelf){
    // kalau lagi di DM yang sama, render
    if(chatMode==="dm" && dmPeer && from===dmPeer.name){
      renderMsg(m);
      scrollBottom();
    }
    return;
  }

  // kalau lagi di DM dengan pengirim -> tampilkan langsung
  if(chatMode==="dm" && dmPeer && from===dmPeer.name){
    renderMsg(m);
    scrollBottom();
    return;
  }

  // selain itu → unread + toast notif
  const u = usersMap.get(from);
  if(u){
    u.unreadDM = (u.unreadDM||0) + 1;
    usersMap.set(from,u);
    renderUsers();
  }
  toast("DM", `${from}: ${m.text ? m.text : (m.kind ? `[${m.kind}]` : "message")}`);
});

/* ====== FIX TOMBOL DM MODAL ====== */
/* cari: el.pDm.addEventListener("click", ()=>{ ... }) */
/* ganti jadi ini biar pasti masuk DM: */

el.pDm.addEventListener("click", ()=>{
  if(!profUser) return;
  if(profUser.name === me.name){
    toast("INFO","Kamu tidak bisa DM diri sendiri.");
    return;
  }
  closeProfile();

  // kalau user belum ada lengkap di map, bikin placeholder biar tetap bisa DM
  const safe = usersMap.get(profUser.name) || {
    name: profUser.name,
    bio: profUser.bio || "",
    photo: profUser.photo || null,
    online: !!profUser.online,
    lastSeen: Date.now(),
    unreadDM: 0
  };
  usersMap.set(safe.name, safe);
  renderUsers();

  // masuk DM meskipun offline
  chatToDM(safe);

  // close sidebar (mobile)
  el.sidebar.classList.remove("on");
  el.overlay.classList.remove("on");
});

      // typing
      socket.on("typing", (d)=>{
        if(!d) return;
        // show typing only for current mode/peer
        if(chatMode==="public"){
          if(d.mode!=="public") return;
        }else{
          if(d.mode!=="dm") return;
          if(!dmPeer || d.peer !== me.name || d.from !== dmPeer.name) return;
        }
        if(d.from === me.name) return;

        el.typing.style.display = d.on ? "flex" : "none";
        el.typingTxt.textContent = `${d.from} typing...`;
      });

      // pong/ping
      socket.on("pong", ()=>{
        const ms = Math.max(0, Date.now()-pingAt);
        el.pingMs.textContent = String(ms);
        // signal level
        el.sig.classList.remove("low","mid","high");
        if(ms <= 90) el.sig.classList.add("high");
        else if(ms <= 180) el.sig.classList.add("mid");
        else el.sig.classList.add("low");
      });
    }

    function startPing(){
      stopPing();
      pingTimer = setInterval(()=>{
        if(!socket || !connected) return;
        pingAt = Date.now();
        socket.emit("ping");
      }, 2000);
    }
    function stopPing(){
      if(pingTimer) clearInterval(pingTimer);
      pingTimer=null;
      el.pingMs.textContent="--";
      el.sig.classList.remove("low","mid","high");
      el.sig.classList.add("mid");
    }

    /* =======================
      INIT
    ======================== */
    function init(){
      bgFX();

      // stored profile
      const sName = (localStorage.getItem(KEY_NAME)||"").trim();
      const sBio  = (localStorage.getItem(KEY_BIO)||"").trim();
      const sPhoto = (localStorage.getItem(KEY_PHOTO)||"").trim();

      me.name = okName(sName) ? sName : null;
      me.bio  = sBio || "";
      me.photo = sPhoto || null;

      applyMe();

      // UI events
      el.hamburger.addEventListener("click", ()=>{
        el.sidebar.classList.add("on");
        el.overlay.classList.add("on");
      });
      el.overlay.addEventListener("click", ()=>{
        el.sidebar.classList.remove("on");
        el.overlay.classList.remove("on");
      });

      el.meAvatar.addEventListener("click", ()=> openGate("edit"));
      el.btnEdit.addEventListener("click", ()=> openGate("edit"));
      el.btnLogout.addEventListener("click", logout);

      // gate
      el.gateGo.addEventListener("click", saveGate);
      el.gateName.addEventListener("keydown",(e)=>{ if(e.key==="Enter") saveGate(); });
      el.gateReset.addEventListener("click", ()=>{
        localStorage.removeItem(KEY_NAME);
        localStorage.removeItem(KEY_BIO);
        localStorage.removeItem(KEY_PHOTO);
        el.gateName.value=""; el.gateBio.value=""; el.gatePhoto.value="";
        el.photoLabel.textContent="Upload foto profil (opsional)";
        alert("Data login dihapus.");
      });
      el.gatePhoto.addEventListener("change", ()=>{
        const f = el.gatePhoto.files && el.gatePhoto.files[0];
        if(!f) return;
        el.photoLabel.textContent = `Foto: ${f.name}`;
      });

      // music
      el.musicBtn.addEventListener("click", toggleMusic);
      installUnlock();
      tryPlay();

      // modals
      el.imgModal.addEventListener("click", ()=> el.imgModal.classList.remove("on"));
      el.pClose.addEventListener("click", closeProfile);
      el.profileModal.addEventListener("click", (e)=>{ if(e.target===el.profileModal) closeProfile(); });

      // profile modal buttons
      el.pDm.addEventListener("click", ()=>{
        if(!profUser) return;
        closeProfile();
        if(profUser.name === me.name) return toast("INFO","Kamu tidak bisa DM diri sendiri.");
        chatToDM(profUser);
        el.sidebar.classList.remove("on");
        el.overlay.classList.remove("on");
      });
      el.pView.addEventListener("click", ()=>{
        if(!profUser) return;
        toast("PROFILE", (profUser.bio||"-"));
      });

      // DM header actions
      el.dmBack.addEventListener("click", ()=> chatToPublic(true));
      el.dmTitleAvatar.addEventListener("click", ()=>{
        if(dmPeer) openProfile(dmPeer);
      });

      // input autoresize
      el.input.addEventListener("input", function(){
        this.style.height="auto";
        this.style.height=this.scrollHeight+"px";
        if(!socket || !connected) return;

        if(typingTimeout) clearTimeout(typingTimeout);
        if(chatMode==="public"){
          socket.emit("typing", {mode:"public", from: me.name, on:true});
          typingTimeout=setTimeout(()=>socket.emit("typing",{mode:"public", from: me.name, on:false}), 900);
        }else if(dmPeer){
          socket.emit("typing", {mode:"dm", from: me.name, peer: dmPeer.name, on:true});
          typingTimeout=setTimeout(()=>socket.emit("typing",{mode:"dm", from: me.name, peer: dmPeer.name, on:false}), 900);
        }
      });

      // reply cancel
      el.replyCancel.addEventListener("click", clearReply);

      // attach
      el.attachBtn.addEventListener("click", ()=> el.file.click());
      el.file.addEventListener("change", onSelectFile);
      el.previewX.addEventListener("click", clearAttach);

      // mic
      el.micBtn.addEventListener("click", ()=>{
        if(recording) stopRec();
        else startRec();
      });

      // send
      el.sendBtn.addEventListener("click", send);
      el.input.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          send();
        }
      });

      // start mode public
      setMode("public");

      // if logged in -> connect
      if(me.name){
        enableUI(false);
        setConn("connecting");
        connect();
        chatToPublic(true);
      }else{
        enableUI(false);
        setConn("offline");
        openGate("login");
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
